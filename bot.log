2024-07-05 16:11:51,783 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-05 16:11:51,784 - INFO - Added job "on_startup" to job store "default"
2024-07-05 16:11:51,784 - INFO - Scheduler started
2024-07-05 16:11:51,784 - INFO - Start polling
2024-07-05 16:11:52,194 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-05 16:12:21,784 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-05 16:12:51 +07)" (scheduled at 2024-07-05 16:12:21.783268+07:00)
2024-07-05 16:12:24,656 - INFO - Job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-05 16:12:51 +07)" executed successfully
2024-07-05 16:12:51,784 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-05 16:13:21 +07)" (scheduled at 2024-07-05 16:12:51.783268+07:00)
2024-07-05 16:12:53,763 - INFO - Job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-05 16:13:21 +07)" executed successfully
2024-07-05 16:13:21,785 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-05 16:13:51 +07)" (scheduled at 2024-07-05 16:13:21.783268+07:00)
2024-07-05 16:13:24,012 - INFO - Job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-05 16:13:51 +07)" executed successfully
2024-07-05 16:13:51,784 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-05 16:14:21 +07)" (scheduled at 2024-07-05 16:13:51.783268+07:00)
2024-07-05 16:13:53,788 - INFO - Job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-05 16:14:21 +07)" executed successfully
2024-07-05 16:14:10,652 - INFO - Update id=792257253 is not handled. Duration 8 ms by bot id=6235250605
2024-07-05 16:14:21,784 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-05 16:14:51 +07)" (scheduled at 2024-07-05 16:14:21.783268+07:00)
2024-07-05 16:14:23,881 - INFO - Job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-05 16:14:51 +07)" executed successfully
2024-07-05 16:14:51,784 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-05 16:15:21 +07)" (scheduled at 2024-07-05 16:14:51.783268+07:00)
2024-07-05 16:14:53,775 - INFO - Job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-05 16:15:21 +07)" executed successfully
2024-07-05 16:15:02,420 - WARNING - Received SIGINT signal
2024-07-05 16:15:02,421 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-05 16:15:02,421 - INFO - Polling stopped
2024-07-05 16:15:02,838 - ERROR - Unclosed client session
client_session: <aiohttp.client.ClientSession object at 0x14d7ce900>
2024-07-05 16:15:02,838 - ERROR - Unclosed connector
connections: ['[(<aiohttp.client_proto.ResponseHandler object at 0x14eb9c410>, 256561.294555708)]']
connector: <aiohttp.connector.TCPConnector object at 0x14d7cea20>
2024-07-05 16:17:15,478 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-05 16:17:15,478 - INFO - Added job "on_startup" to job store "default"
2024-07-05 16:17:15,478 - INFO - Scheduler started
2024-07-05 16:17:15,478 - INFO - Start polling
2024-07-05 16:17:15,856 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-05 16:17:38,354 - INFO - Update id=792257254 is not handled. Duration 5 ms by bot id=6235250605
2024-07-05 16:17:45,503 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-05 16:18:15 +07)" (scheduled at 2024-07-05 16:17:45.478041+07:00)
2024-07-05 16:17:47,674 - INFO - Job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-05 16:18:15 +07)" executed successfully
2024-07-05 16:17:49,732 - WARNING - Received SIGINT signal
2024-07-05 16:17:49,733 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-05 16:17:49,733 - INFO - Polling stopped
2024-07-05 16:17:50,116 - ERROR - Unclosed client session
client_session: <aiohttp.client.ClientSession object at 0x11dfd2ae0>
2024-07-05 16:17:50,116 - ERROR - Unclosed connector
connections: ['[(<aiohttp.client_proto.ResponseHandler object at 0x11e90e270>, 256735.175879)]']
connector: <aiohttp.connector.TCPConnector object at 0x11dfa0e30>
2024-07-05 16:21:40,292 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-05 16:21:40,292 - INFO - Added job "on_startup" to job store "default"
2024-07-05 16:21:40,292 - INFO - Scheduler started
2024-07-05 16:21:40,293 - INFO - Start polling
2024-07-05 16:21:40,621 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-05 16:22:10,298 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-05 16:22:40 +07)" (scheduled at 2024-07-05 16:22:10.292110+07:00)
2024-07-05 16:22:12,629 - INFO - Job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-05 16:22:40 +07)" executed successfully
2024-07-05 16:22:30,279 - WARNING - Received SIGINT signal
2024-07-05 16:22:30,280 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-05 16:22:30,280 - INFO - Polling stopped
2024-07-05 16:22:30,651 - ERROR - Unclosed client session
client_session: <aiohttp.client.ClientSession object at 0x12c2cf1d0>
2024-07-05 16:22:30,652 - ERROR - Unclosed connector
connections: ['[(<aiohttp.client_proto.ResponseHandler object at 0x12c40a270>, 257000.116424166)]']
connector: <aiohttp.connector.TCPConnector object at 0x12c2ce750>
2024-07-05 16:46:07,765 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-05 16:46:07,766 - INFO - Added job "on_startup" to job store "default"
2024-07-05 16:46:07,766 - INFO - Scheduler started
2024-07-05 16:46:07,766 - INFO - Start polling
2024-07-05 16:46:08,148 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-05 16:46:23,926 - INFO - Received message from 964635576: /start
2024-07-05 16:46:23,929 - INFO - Update id=792257255 is not handled. Duration 11 ms by bot id=6235250605
2024-07-05 16:46:23,929 - ERROR - Cause exception while process update id=792257255 by bot id=6235250605
TypeError: 'NoneType' object does not support the asynchronous context manager protocol
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 49, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/fsm/middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 170, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 162, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/logging_middleware.py", line 8, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 46, in handle_start
    async with connection:
TypeError: 'NoneType' object does not support the asynchronous context manager protocol
2024-07-05 16:46:28,421 - WARNING - Received SIGINT signal
2024-07-05 16:46:28,423 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-05 16:46:28,423 - INFO - Polling stopped
2024-07-05 16:46:47,277 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-05 16:46:47,278 - INFO - Added job "on_startup" to job store "default"
2024-07-05 16:46:47,278 - INFO - Scheduler started
2024-07-05 16:46:47,278 - INFO - Start polling
2024-07-05 16:46:47,598 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-05 16:46:51,453 - INFO - Received message from 964635576: /start
2024-07-05 16:46:51,454 - INFO - Update id=792257256 is not handled. Duration 3 ms by bot id=6235250605
2024-07-05 16:46:51,454 - ERROR - Cause exception while process update id=792257256 by bot id=6235250605
TypeError: 'NoneType' object does not support the asynchronous context manager protocol
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 49, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/fsm/middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 170, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 162, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/logging_middleware.py", line 8, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 46, in handle_start
    async with connection:
TypeError: 'NoneType' object does not support the asynchronous context manager protocol
2024-07-05 16:47:17,279 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-05 16:47:47 +07)" (scheduled at 2024-07-05 16:47:17.277263+07:00)
2024-07-05 16:47:18,789 - ERROR - Failed to initialize and load data:
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/bot.py", line 26, in on_startup
    await check_news(Message)
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 229, in check_news
    df_2 = pd.read_sql_query(con=connection, sql=check_query)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 526, in read_sql_query
    return pandas_sql.read_query(
           ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 2738, in read_query
    cursor = self.execute(sql, params)
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 2672, in execute
    cur = self.con.cursor()
          ^^^^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'cursor'
2024-07-05 16:47:18,791 - INFO - Job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-05 16:47:47 +07)" executed successfully
2024-07-05 16:47:38,147 - WARNING - Received SIGINT signal
2024-07-05 16:47:38,149 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-05 16:47:38,150 - INFO - Polling stopped
2024-07-05 16:55:37,960 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-05 16:55:37,961 - INFO - Added job "on_startup" to job store "default"
2024-07-05 16:55:37,961 - INFO - Scheduler started
2024-07-05 16:55:37,961 - INFO - Start polling
2024-07-05 16:55:38,402 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-05 16:55:49,160 - INFO - Received message from 964635576: /start
2024-07-05 16:55:49,161 - INFO - Update id=792257257 is not handled. Duration 6 ms by bot id=6235250605
2024-07-05 16:55:49,162 - ERROR - Cause exception while process update id=792257257 by bot id=6235250605
TypeError: 'NoneType' object does not support the asynchronous context manager protocol
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 49, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/fsm/middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 170, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 162, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/logging_middleware.py", line 8, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 65, in handle_start
    async with connection:
TypeError: 'NoneType' object does not support the asynchronous context manager protocol
2024-07-05 16:56:07,962 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-05 16:56:37 +07)" (scheduled at 2024-07-05 16:56:07.960385+07:00)
2024-07-05 16:56:09,520 - ERROR - Failed to initialize and load data:
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/bot.py", line 26, in on_startup
    await check_news(Message)
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 248, in check_news
    df_2 = pd.read_sql_query(con=connection, sql=check_query)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 526, in read_sql_query
    return pandas_sql.read_query(
           ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 2738, in read_query
    cursor = self.execute(sql, params)
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 2672, in execute
    cur = self.con.cursor()
          ^^^^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'cursor'
2024-07-05 16:56:09,522 - INFO - Job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-05 16:56:37 +07)" executed successfully
2024-07-05 16:56:13,210 - WARNING - Received SIGINT signal
2024-07-05 16:56:13,212 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-05 16:56:13,213 - INFO - Polling stopped
2024-07-06 20:16:02,207 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-06 20:16:02,208 - INFO - Added job "on_startup" to job store "default"
2024-07-06 20:16:02,208 - INFO - Scheduler started
2024-07-06 20:16:02,208 - INFO - Start polling
2024-07-06 20:16:02,579 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-06 20:16:18,173 - INFO - Received message from 964635576: /start
2024-07-06 20:16:18,179 - INFO - Update id=792257258 is not handled. Duration 58 ms by bot id=6235250605
2024-07-06 20:16:18,179 - ERROR - Cause exception while process update id=792257258 by bot id=6235250605
ValueError: the greenlet library is required to use this function. No module named 'greenlet'
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/database/db.py", line 21, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 170, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 162, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/logging_middleware.py", line 8, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 50, in handle_start
    session.add(Users(
                ^^^^^^
  File "<string>", line 4, in __init__
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/state.py", line 571, in _initialize_instance
    with util.safe_reraise():
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py", line 146, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/state.py", line 569, in _initialize_instance
    manager.original_init(*mixed[1:], **kwargs)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/decl_base.py", line 2167, in _declarative_constructor
    raise TypeError(
TypeError: 'last_name' is an invalid keyword argument for Users

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 49, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/fsm/middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/database/db.py", line 19, in __call__
    async with self.session_pool() as session:
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py", line 1080, in __aexit__
    await asyncio.shield(task)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py", line 1025, in close
    await greenlet_spawn(self.sync_session.close)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/concurrency.py", line 99, in greenlet_spawn
    _not_implemented()
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/concurrency.py", line 79, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet'
2024-07-06 20:16:22,702 - WARNING - Received SIGINT signal
2024-07-06 20:16:22,704 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-06 20:16:22,704 - INFO - Polling stopped
2024-07-06 20:17:58,291 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-06 20:17:58,292 - INFO - Added job "on_startup" to job store "default"
2024-07-06 20:17:58,292 - INFO - Scheduler started
2024-07-06 20:17:58,292 - INFO - Start polling
2024-07-06 20:17:58,657 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-06 20:18:03,495 - INFO - Received message from 964635576: /start
2024-07-06 20:18:03,860 - INFO - Update id=792257259 is not handled. Duration 371 ms by bot id=6235250605
2024-07-06 20:18:03,860 - ERROR - Cause exception while process update id=792257259 by bot id=6235250605
ValueError: the greenlet library is required to use this function. No module named 'greenlet'
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 49, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/fsm/middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/database/db.py", line 19, in __call__
    async with self.session_pool() as session:
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py", line 1080, in __aexit__
    await asyncio.shield(task)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py", line 1025, in close
    await greenlet_spawn(self.sync_session.close)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/concurrency.py", line 99, in greenlet_spawn
    _not_implemented()
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/concurrency.py", line 79, in _not_implemented
    raise ValueError(
ValueError: the greenlet library is required to use this function. No module named 'greenlet'
2024-07-06 20:18:12,255 - WARNING - Received SIGINT signal
2024-07-06 20:18:12,258 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-06 20:18:12,258 - INFO - Polling stopped
2024-07-06 20:18:39,106 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-06 20:18:39,107 - INFO - Added job "on_startup" to job store "default"
2024-07-06 20:18:39,108 - INFO - Scheduler started
2024-07-06 20:18:39,108 - INFO - Start polling
2024-07-06 20:18:39,450 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-06 20:18:42,632 - INFO - Received message from 964635576: /start
2024-07-06 20:18:43,086 - INFO - Update id=792257260 is handled. Duration 457 ms by bot id=6235250605
2024-07-06 20:18:47,675 - WARNING - Received SIGINT signal
2024-07-06 20:18:47,677 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-06 20:18:47,678 - INFO - Polling stopped
2024-07-06 20:19:11,647 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-06 20:19:11,648 - INFO - Added job "on_startup" to job store "default"
2024-07-06 20:19:11,648 - INFO - Scheduler started
2024-07-06 20:19:11,648 - INFO - Start polling
2024-07-06 20:19:12,004 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-06 20:19:15,820 - INFO - Update id=792257261 is not handled. Duration 16 ms by bot id=6235250605
2024-07-06 20:19:30,292 - WARNING - Received SIGINT signal
2024-07-06 20:19:30,295 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-06 20:19:30,295 - INFO - Polling stopped
2024-07-06 20:37:07,291 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-06 20:37:07,293 - INFO - Added job "on_startup" to job store "default"
2024-07-06 20:37:07,293 - INFO - Scheduler started
2024-07-06 20:37:07,293 - INFO - Start polling
2024-07-06 20:37:07,652 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-06 20:37:22,115 - INFO - Received message from 964635576: /start
2024-07-06 20:37:22,506 - INFO - Update id=792257262 is handled. Duration 399 ms by bot id=6235250605
2024-07-06 20:37:37,291 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-06 20:38:07 +07)" (scheduled at 2024-07-06 20:37:37.291173+07:00)
2024-07-06 20:37:39,063 - ERROR - Failed to initialize and load data:
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/bot.py", line 26, in on_startup
    await check_news(Message)
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 237, in check_news
    df_2 = pd.read_sql_query(con=session_maker, sql=check_query)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 526, in read_sql_query
    return pandas_sql.read_query(
           ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 2738, in read_query
    cursor = self.execute(sql, params)
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 2672, in execute
    cur = self.con.cursor()
          ^^^^^^^^^^^^^^^
AttributeError: 'async_sessionmaker' object has no attribute 'cursor'
2024-07-06 20:37:39,065 - INFO - Job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-06 20:38:07 +07)" executed successfully
2024-07-06 20:37:41,535 - WARNING - Received SIGINT signal
2024-07-06 20:37:41,538 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-06 20:37:41,538 - INFO - Polling stopped
2024-07-06 20:39:15,999 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-06 20:39:16,001 - INFO - Added job "on_startup" to job store "default"
2024-07-06 20:39:16,001 - INFO - Scheduler started
2024-07-06 20:39:16,001 - INFO - Start polling
2024-07-06 20:39:16,399 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-06 20:39:19,804 - INFO - Received message from 964635576: /start
2024-07-06 20:39:20,322 - INFO - Update id=792257263 is handled. Duration 538 ms by bot id=6235250605
2024-07-06 20:39:24,519 - WARNING - Received SIGINT signal
2024-07-06 20:39:24,522 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-06 20:39:24,522 - INFO - Polling stopped
2024-07-06 20:41:29,634 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-06 20:41:29,636 - INFO - Added job "on_startup" to job store "default"
2024-07-06 20:41:29,636 - INFO - Scheduler started
2024-07-06 20:41:29,636 - INFO - Start polling
2024-07-06 20:41:29,989 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-06 20:41:33,210 - INFO - Received message from 964635576: /start
2024-07-06 20:41:33,259 - INFO - select pg_catalog.version()
2024-07-06 20:41:33,259 - INFO - [raw sql] ()
2024-07-06 20:41:33,262 - INFO - select current_schema()
2024-07-06 20:41:33,262 - INFO - [raw sql] ()
2024-07-06 20:41:33,264 - INFO - show standard_conforming_strings
2024-07-06 20:41:33,264 - INFO - [raw sql] ()
2024-07-06 20:41:33,266 - INFO - BEGIN (implicit)
2024-07-06 20:41:33,268 - INFO - INSERT INTO users (user_id, user_name, last_name, username, joined_at) VALUES ($1::BIGINT, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::TIMESTAMP WITHOUT TIME ZONE)
2024-07-06 20:41:33,268 - INFO - [generated in 0.00025s] (964635576, 'Влад', 'Казаков', 'rejoller', '2024-07-06 20:41:33')
2024-07-06 20:41:33,270 - INFO - ROLLBACK
2024-07-06 20:41:33,271 - INFO - Update id=792257264 is not handled. Duration 78 ms by bot id=6235250605
2024-07-06 20:41:33,271 - ERROR - Cause exception while process update id=792257264 by bot id=6235250605
DBAPIError: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.DataError'>: invalid input for query argument $5: '2024-07-06 20:41:33' (expected a datetime.date or datetime.datetime instance, got 'str')
[SQL: INSERT INTO users (user_id, user_name, last_name, username, joined_at) VALUES ($1::BIGINT, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::TIMESTAMP WITHOUT TIME ZONE)]
[parameters: (964635576, 'Влад', 'Казаков', 'rejoller', '2024-07-06 20:41:33')]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
Traceback (most recent call last):
  File "asyncpg/protocol/prepared_stmt.pyx", line 175, in asyncpg.protocol.protocol.PreparedStatementState._encode_bind_msg
  File "asyncpg/protocol/codecs/base.pyx", line 227, in asyncpg.protocol.protocol.Codec.encode
  File "asyncpg/protocol/codecs/base.pyx", line 129, in asyncpg.protocol.protocol.Codec.encode_scalar
  File "asyncpg/pgproto/./codecs/datetime.pyx", line 147, in asyncpg.pgproto.pgproto.timestamp_encode
TypeError: expected a datetime.date or datetime.datetime instance, got 'str'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 538, in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/asyncpg/prepared_stmt.py", line 176, in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/asyncpg/prepared_stmt.py", line 241, in __bind_execute
    data, status, _ = await self.__do_execute(
                      ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/asyncpg/prepared_stmt.py", line 230, in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "asyncpg/protocol/protocol.pyx", line 186, in bind_execute
  File "asyncpg/protocol/prepared_stmt.pyx", line 204, in asyncpg.protocol.protocol.PreparedStatementState._encode_bind_msg
asyncpg.exceptions.DataError: invalid input for query argument $5: '2024-07-06 20:41:33' (expected a datetime.date or datetime.datetime instance, got 'str')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 572, in execute
    self._adapt_connection.await_(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 550, in _prepare_and_execute
    self._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 501, in _handle_exception
    self._adapt_connection._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 784, in _handle_exception
    raise translated_error from error
sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.Error: <class 'asyncpg.exceptions.DataError'>: invalid input for query argument $5: '2024-07-06 20:41:33' (expected a datetime.date or datetime.datetime instance, got 'str')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 49, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/fsm/middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/database/db.py", line 21, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 170, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 162, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/logging_middleware.py", line 8, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 57, in handle_start
    await session.commit()
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py", line 1009, in commit
    await greenlet_spawn(self.sync_session.commit)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2017, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 1302, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 1277, in _prepare_impl
    self.session.flush()
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4341, in flush
    self._flush(objects)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4476, in _flush
    with util.safe_reraise():
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py", line 146, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4437, in _flush
    flush_context.execute()
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 1048, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1418, in execute
    return meth(
           ^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py", line 515, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1640, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2353, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 572, in execute
    self._adapt_connection.await_(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 550, in _prepare_and_execute
    self._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 501, in _handle_exception
    self._adapt_connection._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 784, in _handle_exception
    raise translated_error from error
sqlalchemy.exc.DBAPIError: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.DataError'>: invalid input for query argument $5: '2024-07-06 20:41:33' (expected a datetime.date or datetime.datetime instance, got 'str')
[SQL: INSERT INTO users (user_id, user_name, last_name, username, joined_at) VALUES ($1::BIGINT, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::TIMESTAMP WITHOUT TIME ZONE)]
[parameters: (964635576, 'Влад', 'Казаков', 'rejoller', '2024-07-06 20:41:33')]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2024-07-06 20:41:50,257 - WARNING - Received SIGINT signal
2024-07-06 20:41:50,261 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-06 20:41:50,261 - INFO - Polling stopped
2024-07-06 20:45:44,223 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-06 20:45:44,223 - INFO - Added job "on_startup" to job store "default"
2024-07-06 20:45:44,223 - INFO - Scheduler started
2024-07-06 20:45:44,224 - INFO - Start polling
2024-07-06 20:45:44,614 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-06 20:45:48,567 - INFO - Received message from 964635576: /start
2024-07-06 20:45:48,622 - INFO - select pg_catalog.version()
2024-07-06 20:45:48,622 - INFO - [raw sql] ()
2024-07-06 20:45:48,625 - INFO - select current_schema()
2024-07-06 20:45:48,625 - INFO - [raw sql] ()
2024-07-06 20:45:48,626 - INFO - show standard_conforming_strings
2024-07-06 20:45:48,627 - INFO - [raw sql] ()
2024-07-06 20:45:48,628 - INFO - BEGIN (implicit)
2024-07-06 20:45:48,630 - INFO - INSERT INTO users (user_id, user_name, last_name, username, joined_at) VALUES ($1::BIGINT, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::TIMESTAMP WITHOUT TIME ZONE)
2024-07-06 20:45:48,630 - INFO - [generated in 0.00017s] (964635576, 'Влад', 'Казаков', 'rejoller', datetime.datetime(2024, 7, 6, 20, 45, 48, 568414))
2024-07-06 20:45:48,636 - INFO - COMMIT
2024-07-06 20:45:49,155 - INFO - Update id=792257265 is handled. Duration 595 ms by bot id=6235250605
2024-07-06 20:45:53,599 - WARNING - Received SIGINT signal
2024-07-06 20:45:53,602 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-06 20:45:53,602 - INFO - Polling stopped
2024-07-07 19:53:03,712 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 19:53:03,713 - INFO - Added job "on_startup" to job store "default"
2024-07-07 19:53:03,713 - INFO - Scheduler started
2024-07-07 19:53:03,713 - INFO - Start polling
2024-07-07 19:53:04,153 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 19:53:20,832 - INFO - Received message from 964635576: /subscribe
2024-07-07 19:53:20,834 - INFO - Update id=792257266 is not handled. Duration 16 ms by bot id=6235250605
2024-07-07 19:53:20,834 - ERROR - Cause exception while process update id=792257266 by bot id=6235250605
AttributeError: 'AsyncSession' object has no attribute 'select'
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 49, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/fsm/middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/database/db.py", line 21, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 170, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 162, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/logging_middleware.py", line 8, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 79, in handle_waiting_for_choise
    session.select(Municipalities('map_id', 'municipaliti_name')
    ^^^^^^^^^^^^^^
AttributeError: 'AsyncSession' object has no attribute 'select'
2024-07-07 19:53:24,463 - WARNING - Received SIGINT signal
2024-07-07 19:53:24,468 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 19:53:24,468 - INFO - Polling stopped
2024-07-07 19:57:27,567 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 19:57:27,568 - INFO - Added job "on_startup" to job store "default"
2024-07-07 19:57:27,568 - INFO - Scheduler started
2024-07-07 19:57:27,568 - INFO - Start polling
2024-07-07 19:57:27,910 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 19:57:31,226 - INFO - Received message from 964635576: /subscribe
2024-07-07 19:57:31,227 - INFO - Update id=792257267 is not handled. Duration 12 ms by bot id=6235250605
2024-07-07 19:57:31,227 - ERROR - Cause exception while process update id=792257267 by bot id=6235250605
TypeError: __init__() takes 1 positional argument but 3 were given
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 49, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/fsm/middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/database/db.py", line 21, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 170, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 162, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/logging_middleware.py", line 8, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 79, in handle_waiting_for_choise
    all_municipalities = session.scalars(select(Municipalities('map_id', 'municipaliti_name'))
                                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: __init__() takes 1 positional argument but 3 were given
2024-07-07 19:57:37,154 - WARNING - Received SIGINT signal
2024-07-07 19:57:37,155 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 19:57:37,155 - INFO - Polling stopped
2024-07-07 19:58:22,785 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 19:58:22,786 - INFO - Added job "on_startup" to job store "default"
2024-07-07 19:58:22,786 - INFO - Scheduler started
2024-07-07 19:58:22,786 - INFO - Start polling
2024-07-07 19:58:23,119 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 19:58:25,499 - INFO - Received message from 964635576: /subscribe
2024-07-07 19:58:25,500 - INFO - Update id=792257268 is not handled. Duration 11 ms by bot id=6235250605
2024-07-07 19:58:25,500 - ERROR - Cause exception while process update id=792257268 by bot id=6235250605
TypeError: 'coroutine' object is not iterable
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 49, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/fsm/middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/database/db.py", line 21, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 170, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 162, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/logging_middleware.py", line 8, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 86, in handle_waiting_for_choise
    for index, mun in enumerate(all_municipalities, start=1):
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: 'coroutine' object is not iterable
2024-07-07 19:58:31,253 - WARNING - Received SIGINT signal
2024-07-07 19:58:31,255 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 19:58:31,256 - INFO - Polling stopped
2024-07-07 19:59:05,046 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 19:59:05,047 - INFO - Added job "on_startup" to job store "default"
2024-07-07 19:59:05,047 - INFO - Scheduler started
2024-07-07 19:59:05,047 - INFO - Start polling
2024-07-07 19:59:05,389 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 19:59:08,396 - INFO - Received message from 964635576: /subscribe
2024-07-07 19:59:08,458 - INFO - select pg_catalog.version()
2024-07-07 19:59:08,460 - INFO - [raw sql] ()
2024-07-07 19:59:08,471 - INFO - select current_schema()
2024-07-07 19:59:08,471 - INFO - [raw sql] ()
2024-07-07 19:59:08,473 - INFO - show standard_conforming_strings
2024-07-07 19:59:08,473 - INFO - [raw sql] ()
2024-07-07 19:59:08,474 - INFO - BEGIN (implicit)
2024-07-07 19:59:08,477 - INFO - SELECT municipalities.map_id 
FROM municipalities
2024-07-07 19:59:08,477 - INFO - [generated in 0.00014s] ()
2024-07-07 19:59:08,919 - INFO - ROLLBACK
2024-07-07 19:59:08,920 - INFO - Update id=792257269 is not handled. Duration 527 ms by bot id=6235250605
2024-07-07 19:59:08,920 - ERROR - Cause exception while process update id=792257269 by bot id=6235250605
NameError: name 'cur' is not defined
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 49, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/fsm/middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/database/db.py", line 21, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 170, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 162, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/logging_middleware.py", line 8, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 100, in handle_waiting_for_choise
    cur.close()
    ^^^
NameError: name 'cur' is not defined. Did you mean: 'chr'?
2024-07-07 19:59:12,463 - WARNING - Received SIGINT signal
2024-07-07 19:59:12,464 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 19:59:12,464 - INFO - Polling stopped
2024-07-07 20:00:35,115 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 20:00:35,116 - INFO - Added job "on_startup" to job store "default"
2024-07-07 20:00:35,116 - INFO - Scheduler started
2024-07-07 20:00:35,116 - INFO - Start polling
2024-07-07 20:00:35,476 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 20:00:39,174 - INFO - Received message from 964635576: /start
2024-07-07 20:00:39,185 - INFO - Update id=792257270 is not handled. Duration 30 ms by bot id=6235250605
2024-07-07 20:00:39,185 - ERROR - Cause exception while process update id=792257270 by bot id=6235250605
TypeError: object NoneType can't be used in 'await' expression
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 49, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/fsm/middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/database/db.py", line 21, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 170, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 162, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/logging_middleware.py", line 8, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 51, in handle_start
    await session.add(Users(
TypeError: object NoneType can't be used in 'await' expression
2024-07-07 20:00:47,739 - INFO - Received message from 964635576: /subscribe
2024-07-07 20:00:47,774 - INFO - select pg_catalog.version()
2024-07-07 20:00:47,774 - INFO - [raw sql] ()
2024-07-07 20:00:47,776 - INFO - select current_schema()
2024-07-07 20:00:47,776 - INFO - [raw sql] ()
2024-07-07 20:00:47,777 - INFO - show standard_conforming_strings
2024-07-07 20:00:47,777 - INFO - [raw sql] ()
2024-07-07 20:00:47,778 - INFO - BEGIN (implicit)
2024-07-07 20:00:47,779 - INFO - SELECT municipalities.map_id 
FROM municipalities
2024-07-07 20:00:47,780 - INFO - [generated in 0.00019s] ()
2024-07-07 20:00:48,368 - INFO - ROLLBACK
2024-07-07 20:00:48,368 - INFO - Update id=792257271 is handled. Duration 654 ms by bot id=6235250605
2024-07-07 20:00:52,031 - WARNING - Received SIGINT signal
2024-07-07 20:00:52,032 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 20:00:52,032 - INFO - Polling stopped
2024-07-07 20:04:10,062 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 20:04:10,063 - INFO - Added job "on_startup" to job store "default"
2024-07-07 20:04:10,063 - INFO - Scheduler started
2024-07-07 20:04:10,063 - INFO - Start polling
2024-07-07 20:04:10,408 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 20:04:13,851 - INFO - Received message from 964635576: /start
2024-07-07 20:04:13,854 - INFO - Update id=792257272 is not handled. Duration 6 ms by bot id=6235250605
2024-07-07 20:04:13,854 - ERROR - Cause exception while process update id=792257272 by bot id=6235250605
TypeError: object NoneType can't be used in 'await' expression
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 49, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/fsm/middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/database/db.py", line 21, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 170, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 162, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/logging_middleware.py", line 8, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 51, in handle_start
    await session.add(Users(
TypeError: object NoneType can't be used in 'await' expression
2024-07-07 20:04:34,523 - WARNING - Received SIGINT signal
2024-07-07 20:04:34,527 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 20:04:34,528 - INFO - Polling stopped
2024-07-07 20:04:39,169 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 20:04:39,170 - INFO - Added job "on_startup" to job store "default"
2024-07-07 20:04:39,170 - INFO - Scheduler started
2024-07-07 20:04:39,170 - INFO - Start polling
2024-07-07 20:04:39,518 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 20:04:41,834 - INFO - Received message from 964635576: /start
2024-07-07 20:04:41,847 - INFO - select pg_catalog.version()
2024-07-07 20:04:41,847 - INFO - [raw sql] ()
2024-07-07 20:04:41,848 - INFO - select current_schema()
2024-07-07 20:04:41,849 - INFO - [raw sql] ()
2024-07-07 20:04:41,849 - INFO - show standard_conforming_strings
2024-07-07 20:04:41,849 - INFO - [raw sql] ()
2024-07-07 20:04:41,850 - INFO - BEGIN (implicit)
2024-07-07 20:04:41,851 - INFO - INSERT INTO users (user_id, user_name, last_name, username, joined_at) VALUES ($1::BIGINT, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::TIMESTAMP WITHOUT TIME ZONE)
2024-07-07 20:04:41,851 - INFO - [generated in 0.00015s] (964635576, 'Влад', 'Казаков', 'rejoller', datetime.datetime(2024, 7, 7, 20, 4, 41, 835021))
2024-07-07 20:04:41,919 - INFO - ROLLBACK
2024-07-07 20:04:41,921 - INFO - Update id=792257273 is not handled. Duration 89 ms by bot id=6235250605
2024-07-07 20:04:41,921 - ERROR - Cause exception while process update id=792257273 by bot id=6235250605
IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "users_pkey"
DETAIL:  Key (user_id)=(964635576) already exists.
[SQL: INSERT INTO users (user_id, user_name, last_name, username, joined_at) VALUES ($1::BIGINT, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::TIMESTAMP WITHOUT TIME ZONE)]
[parameters: (964635576, 'Влад', 'Казаков', 'rejoller', datetime.datetime(2024, 7, 7, 20, 4, 41, 835021))]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 538, in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/asyncpg/prepared_stmt.py", line 176, in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/asyncpg/prepared_stmt.py", line 241, in __bind_execute
    data, status, _ = await self.__do_execute(
                      ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/asyncpg/prepared_stmt.py", line 230, in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "asyncpg/protocol/protocol.pyx", line 207, in bind_execute
asyncpg.exceptions.UniqueViolationError: duplicate key value violates unique constraint "users_pkey"
DETAIL:  Key (user_id)=(964635576) already exists.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 572, in execute
    self._adapt_connection.await_(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 550, in _prepare_and_execute
    self._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 501, in _handle_exception
    self._adapt_connection._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 784, in _handle_exception
    raise translated_error from error
sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.IntegrityError: <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "users_pkey"
DETAIL:  Key (user_id)=(964635576) already exists.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 49, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/fsm/middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/database/db.py", line 21, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 170, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 162, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/logging_middleware.py", line 8, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 59, in handle_start
    await session.commit()
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py", line 1009, in commit
    await greenlet_spawn(self.sync_session.commit)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2017, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 1302, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 1277, in _prepare_impl
    self.session.flush()
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4341, in flush
    self._flush(objects)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4476, in _flush
    with util.safe_reraise():
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py", line 146, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4437, in _flush
    flush_context.execute()
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 1048, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1418, in execute
    return meth(
           ^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py", line 515, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1640, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2353, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 572, in execute
    self._adapt_connection.await_(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 550, in _prepare_and_execute
    self._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 501, in _handle_exception
    self._adapt_connection._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 784, in _handle_exception
    raise translated_error from error
sqlalchemy.exc.IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "users_pkey"
DETAIL:  Key (user_id)=(964635576) already exists.
[SQL: INSERT INTO users (user_id, user_name, last_name, username, joined_at) VALUES ($1::BIGINT, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::TIMESTAMP WITHOUT TIME ZONE)]
[parameters: (964635576, 'Влад', 'Казаков', 'rejoller', datetime.datetime(2024, 7, 7, 20, 4, 41, 835021))]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2024-07-07 20:05:09,170 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 20:05:39 +07)" (scheduled at 2024-07-07 20:05:09.169716+07:00)
2024-07-07 20:05:10,862 - ERROR - Failed to initialize and load data:
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/bot.py", line 26, in on_startup
    await check_news(Message)
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 239, in check_news
    df_2 = pd.read_sql_query(con=session_maker, sql=check_query)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 526, in read_sql_query
    return pandas_sql.read_query(
           ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 2738, in read_query
    cursor = self.execute(sql, params)
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 2672, in execute
    cur = self.con.cursor()
          ^^^^^^^^^^^^^^^
AttributeError: 'async_sessionmaker' object has no attribute 'cursor'
2024-07-07 20:05:10,864 - INFO - Job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 20:05:39 +07)" executed successfully
2024-07-07 20:05:22,391 - ERROR - Failed to fetch updates - TelegramNetworkError: HTTP Client says - ServerDisconnectedError: Server disconnected
2024-07-07 20:05:22,392 - WARNING - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 6235250605)
2024-07-07 20:05:23,761 - INFO - Connection established (tryings = 1, bot id = 6235250605)
2024-07-07 20:05:23,765 - INFO - Received message from 964635576: /subscribe
2024-07-07 20:05:23,767 - INFO - Update id=792257274 is not handled. Duration 4 ms by bot id=6235250605
2024-07-07 20:05:23,767 - ERROR - Cause exception while process update id=792257274 by bot id=6235250605
AttributeError: 'Select' object has no attribute 'scalars'
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 49, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/fsm/middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/database/db.py", line 21, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 170, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 162, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/logging_middleware.py", line 8, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 79, in handle_waiting_for_choise
    all_municipalities = await session.execute(select(Municipalities.map_id).scalars().all()
                                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'Select' object has no attribute 'scalars'
2024-07-07 20:05:34,881 - WARNING - Received SIGINT signal
2024-07-07 20:05:34,884 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 20:05:34,884 - INFO - Polling stopped
2024-07-07 20:08:17,652 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 20:08:17,652 - INFO - Added job "on_startup" to job store "default"
2024-07-07 20:08:17,652 - INFO - Scheduler started
2024-07-07 20:08:17,653 - INFO - Start polling
2024-07-07 20:08:18,001 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 20:08:21,702 - INFO - Received message from 964635576: /start
2024-07-07 20:08:21,729 - INFO - select pg_catalog.version()
2024-07-07 20:08:21,730 - INFO - [raw sql] ()
2024-07-07 20:08:21,733 - INFO - select current_schema()
2024-07-07 20:08:21,733 - INFO - [raw sql] ()
2024-07-07 20:08:21,734 - INFO - show standard_conforming_strings
2024-07-07 20:08:21,734 - INFO - [raw sql] ()
2024-07-07 20:08:21,735 - INFO - BEGIN (implicit)
2024-07-07 20:08:21,737 - INFO - INSERT INTO users (user_id, user_name, last_name, username, joined_at) VALUES ($1::BIGINT, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::TIMESTAMP WITHOUT TIME ZONE)
2024-07-07 20:08:21,737 - INFO - [generated in 0.00018s] (964635576, 'Влад', 'Казаков', 'rejoller', datetime.datetime(2024, 7, 7, 20, 8, 21, 703598))
2024-07-07 20:08:21,741 - INFO - ROLLBACK
2024-07-07 20:08:21,742 - INFO - Update id=792257275 is not handled. Duration 54 ms by bot id=6235250605
2024-07-07 20:08:21,742 - ERROR - Cause exception while process update id=792257275 by bot id=6235250605
IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "users_pkey"
DETAIL:  Key (user_id)=(964635576) already exists.
[SQL: INSERT INTO users (user_id, user_name, last_name, username, joined_at) VALUES ($1::BIGINT, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::TIMESTAMP WITHOUT TIME ZONE)]
[parameters: (964635576, 'Влад', 'Казаков', 'rejoller', datetime.datetime(2024, 7, 7, 20, 8, 21, 703598))]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 538, in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/asyncpg/prepared_stmt.py", line 176, in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/asyncpg/prepared_stmt.py", line 241, in __bind_execute
    data, status, _ = await self.__do_execute(
                      ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/asyncpg/prepared_stmt.py", line 230, in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "asyncpg/protocol/protocol.pyx", line 207, in bind_execute
asyncpg.exceptions.UniqueViolationError: duplicate key value violates unique constraint "users_pkey"
DETAIL:  Key (user_id)=(964635576) already exists.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 572, in execute
    self._adapt_connection.await_(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 550, in _prepare_and_execute
    self._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 501, in _handle_exception
    self._adapt_connection._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 784, in _handle_exception
    raise translated_error from error
sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.IntegrityError: <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "users_pkey"
DETAIL:  Key (user_id)=(964635576) already exists.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 49, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/fsm/middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/database/db.py", line 21, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 170, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 162, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/logging_middleware.py", line 8, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 59, in handle_start
    await session.commit()
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py", line 1009, in commit
    await greenlet_spawn(self.sync_session.commit)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2017, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 1302, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 1277, in _prepare_impl
    self.session.flush()
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4341, in flush
    self._flush(objects)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4476, in _flush
    with util.safe_reraise():
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py", line 146, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4437, in _flush
    flush_context.execute()
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 1048, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1418, in execute
    return meth(
           ^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py", line 515, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1640, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2353, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 572, in execute
    self._adapt_connection.await_(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 550, in _prepare_and_execute
    self._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 501, in _handle_exception
    self._adapt_connection._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 784, in _handle_exception
    raise translated_error from error
sqlalchemy.exc.IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "users_pkey"
DETAIL:  Key (user_id)=(964635576) already exists.
[SQL: INSERT INTO users (user_id, user_name, last_name, username, joined_at) VALUES ($1::BIGINT, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::TIMESTAMP WITHOUT TIME ZONE)]
[parameters: (964635576, 'Влад', 'Казаков', 'rejoller', datetime.datetime(2024, 7, 7, 20, 8, 21, 703598))]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2024-07-07 20:08:31,855 - ERROR - Failed to fetch updates - TelegramNetworkError: HTTP Client says - ServerDisconnectedError: Server disconnected
2024-07-07 20:08:31,856 - WARNING - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 6235250605)
2024-07-07 20:08:36,271 - INFO - Connection established (tryings = 1, bot id = 6235250605)
2024-07-07 20:08:36,288 - INFO - Received message from 964635576: /subscribe
2024-07-07 20:08:36,290 - INFO - Update id=792257276 is not handled. Duration 16 ms by bot id=6235250605
2024-07-07 20:08:36,290 - ERROR - Cause exception while process update id=792257276 by bot id=6235250605
AttributeError: 'Select' object has no attribute 'scalars'
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 49, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/fsm/middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/database/db.py", line 21, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 170, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 162, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/logging_middleware.py", line 8, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 79, in handle_waiting_for_choise
    all_municipalities = await session.execute(select(Municipalities.map_id).scalars().all()
                                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'Select' object has no attribute 'scalars'
2024-07-07 20:08:40,729 - WARNING - Received SIGINT signal
2024-07-07 20:08:40,734 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 20:08:40,734 - INFO - Polling stopped
2024-07-07 20:09:42,116 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 20:09:42,117 - INFO - Added job "on_startup" to job store "default"
2024-07-07 20:09:42,117 - INFO - Scheduler started
2024-07-07 20:09:42,117 - INFO - Start polling
2024-07-07 20:09:42,442 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 20:09:47,098 - INFO - Received message from 964635576: /subscribe
2024-07-07 20:09:47,099 - INFO - Update id=792257277 is not handled. Duration 5 ms by bot id=6235250605
2024-07-07 20:09:47,099 - ERROR - Cause exception while process update id=792257277 by bot id=6235250605
AttributeError: type object 'Municipalities' has no attribute 'municipality_name'
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 49, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/fsm/middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/database/db.py", line 21, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 170, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 162, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/logging_middleware.py", line 8, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 79, in handle_waiting_for_choise
    query = select(Municipalities.map_id, Municipalities.municipality_name).order_by(Municipalities.municipality_name.asc())
                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: type object 'Municipalities' has no attribute 'municipality_name'
2024-07-07 20:09:51,947 - WARNING - Received SIGINT signal
2024-07-07 20:09:51,950 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 20:09:51,950 - INFO - Polling stopped
2024-07-07 20:11:29,224 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 20:11:29,224 - INFO - Added job "on_startup" to job store "default"
2024-07-07 20:11:29,224 - INFO - Scheduler started
2024-07-07 20:11:29,225 - INFO - Start polling
2024-07-07 20:11:29,571 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 20:11:32,788 - INFO - Received message from 964635576: /subscribe
2024-07-07 20:11:32,837 - INFO - select pg_catalog.version()
2024-07-07 20:11:32,838 - INFO - [raw sql] ()
2024-07-07 20:11:32,840 - INFO - select current_schema()
2024-07-07 20:11:32,840 - INFO - [raw sql] ()
2024-07-07 20:11:32,842 - INFO - show standard_conforming_strings
2024-07-07 20:11:32,842 - INFO - [raw sql] ()
2024-07-07 20:11:32,844 - INFO - BEGIN (implicit)
2024-07-07 20:11:32,847 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-07 20:11:32,847 - INFO - [generated in 0.00020s] ()
2024-07-07 20:11:33,353 - INFO - ROLLBACK
2024-07-07 20:11:33,354 - INFO - Update id=792257278 is handled. Duration 570 ms by bot id=6235250605
2024-07-07 20:11:59,227 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 20:12:29 +07)" (scheduled at 2024-07-07 20:11:59.223967+07:00)
2024-07-07 20:12:00,777 - ERROR - Failed to initialize and load data:
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/bot.py", line 26, in on_startup
    await check_news(Message)
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 241, in check_news
    df_2 = pd.read_sql_query(con=session_maker, sql=check_query)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 526, in read_sql_query
    return pandas_sql.read_query(
           ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 2738, in read_query
    cursor = self.execute(sql, params)
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 2672, in execute
    cur = self.con.cursor()
          ^^^^^^^^^^^^^^^
AttributeError: 'async_sessionmaker' object has no attribute 'cursor'
2024-07-07 20:12:00,779 - INFO - Job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 20:12:29 +07)" executed successfully
2024-07-07 20:12:29,225 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 20:12:59 +07)" (scheduled at 2024-07-07 20:12:29.223967+07:00)
2024-07-07 20:12:30,892 - ERROR - Failed to initialize and load data:
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/bot.py", line 26, in on_startup
    await check_news(Message)
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 241, in check_news
    df_2 = pd.read_sql_query(con=session_maker, sql=check_query)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 526, in read_sql_query
    return pandas_sql.read_query(
           ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 2738, in read_query
    cursor = self.execute(sql, params)
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 2672, in execute
    cur = self.con.cursor()
          ^^^^^^^^^^^^^^^
AttributeError: 'async_sessionmaker' object has no attribute 'cursor'
2024-07-07 20:12:30,893 - INFO - Job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 20:12:59 +07)" executed successfully
2024-07-07 20:12:59,227 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 20:13:29 +07)" (scheduled at 2024-07-07 20:12:59.223967+07:00)
2024-07-07 20:13:00,851 - ERROR - Failed to initialize and load data:
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/bot.py", line 26, in on_startup
    await check_news(Message)
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 241, in check_news
    df_2 = pd.read_sql_query(con=session_maker, sql=check_query)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 526, in read_sql_query
    return pandas_sql.read_query(
           ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 2738, in read_query
    cursor = self.execute(sql, params)
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 2672, in execute
    cur = self.con.cursor()
          ^^^^^^^^^^^^^^^
AttributeError: 'async_sessionmaker' object has no attribute 'cursor'
2024-07-07 20:13:00,853 - INFO - Job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 20:13:29 +07)" executed successfully
2024-07-07 20:13:29,225 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 20:13:59 +07)" (scheduled at 2024-07-07 20:13:29.223967+07:00)
2024-07-07 20:13:30,717 - ERROR - Failed to initialize and load data:
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/bot.py", line 26, in on_startup
    await check_news(Message)
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 241, in check_news
    df_2 = pd.read_sql_query(con=session_maker, sql=check_query)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 526, in read_sql_query
    return pandas_sql.read_query(
           ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 2738, in read_query
    cursor = self.execute(sql, params)
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 2672, in execute
    cur = self.con.cursor()
          ^^^^^^^^^^^^^^^
AttributeError: 'async_sessionmaker' object has no attribute 'cursor'
2024-07-07 20:13:30,717 - INFO - Job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 20:13:59 +07)" executed successfully
2024-07-07 20:13:59,225 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 20:14:29 +07)" (scheduled at 2024-07-07 20:13:59.223967+07:00)
2024-07-07 20:14:01,059 - ERROR - Failed to initialize and load data:
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/bot.py", line 26, in on_startup
    await check_news(Message)
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 241, in check_news
    df_2 = pd.read_sql_query(con=session_maker, sql=check_query)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 526, in read_sql_query
    return pandas_sql.read_query(
           ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 2738, in read_query
    cursor = self.execute(sql, params)
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 2672, in execute
    cur = self.con.cursor()
          ^^^^^^^^^^^^^^^
AttributeError: 'async_sessionmaker' object has no attribute 'cursor'
2024-07-07 20:14:01,060 - INFO - Job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 20:14:29 +07)" executed successfully
2024-07-07 20:31:36,120 - WARNING - Run time of job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 20:31:59 +07)" was missed by 0:00:06.895600
2024-07-07 20:31:59,226 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 20:32:29 +07)" (scheduled at 2024-07-07 20:31:59.223967+07:00)
2024-07-07 20:32:00,934 - ERROR - Failed to initialize and load data:
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/bot.py", line 26, in on_startup
    await check_news(Message)
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 241, in check_news
    df_2 = pd.read_sql_query(con=session_maker, sql=check_query)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 526, in read_sql_query
    return pandas_sql.read_query(
           ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 2738, in read_query
    cursor = self.execute(sql, params)
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 2672, in execute
    cur = self.con.cursor()
          ^^^^^^^^^^^^^^^
AttributeError: 'async_sessionmaker' object has no attribute 'cursor'
2024-07-07 20:32:00,936 - INFO - Job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 20:32:29 +07)" executed successfully
2024-07-07 20:32:16,833 - WARNING - Received SIGINT signal
2024-07-07 20:32:16,839 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 20:32:16,839 - INFO - Polling stopped
2024-07-07 20:33:37,560 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 20:33:37,561 - INFO - Added job "on_startup" to job store "default"
2024-07-07 20:33:37,561 - INFO - Scheduler started
2024-07-07 20:33:37,561 - INFO - Start polling
2024-07-07 20:33:37,916 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 20:33:47,527 - INFO - Received message from 964635576: /subscribe
2024-07-07 20:33:47,564 - INFO - select pg_catalog.version()
2024-07-07 20:33:47,564 - INFO - [raw sql] ()
2024-07-07 20:33:47,570 - INFO - select current_schema()
2024-07-07 20:33:47,570 - INFO - [raw sql] ()
2024-07-07 20:33:47,572 - INFO - show standard_conforming_strings
2024-07-07 20:33:47,572 - INFO - [raw sql] ()
2024-07-07 20:33:47,573 - INFO - BEGIN (implicit)
2024-07-07 20:33:47,576 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-07 20:33:47,576 - INFO - [generated in 0.00025s] ()
2024-07-07 20:33:48,128 - INFO - ROLLBACK
2024-07-07 20:33:48,128 - INFO - Update id=792257279 is handled. Duration 617 ms by bot id=6235250605
2024-07-07 20:33:52,447 - WARNING - Received SIGINT signal
2024-07-07 20:33:52,453 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 20:33:52,453 - INFO - Polling stopped
2024-07-07 20:36:36,499 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 20:36:36,500 - INFO - Added job "on_startup" to job store "default"
2024-07-07 20:36:36,500 - INFO - Scheduler started
2024-07-07 20:36:36,500 - INFO - Start polling
2024-07-07 20:36:36,848 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 20:36:40,463 - INFO - Received message from 964635576: /subscribe
2024-07-07 20:36:40,479 - INFO - select pg_catalog.version()
2024-07-07 20:36:40,479 - INFO - [raw sql] ()
2024-07-07 20:36:40,481 - INFO - select current_schema()
2024-07-07 20:36:40,481 - INFO - [raw sql] ()
2024-07-07 20:36:40,482 - INFO - show standard_conforming_strings
2024-07-07 20:36:40,482 - INFO - [raw sql] ()
2024-07-07 20:36:40,483 - INFO - BEGIN (implicit)
2024-07-07 20:36:40,486 - INFO - SELECT municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-07 20:36:40,486 - INFO - [generated in 0.00022s] ()
2024-07-07 20:36:40,964 - INFO - ROLLBACK
2024-07-07 20:36:40,965 - INFO - Update id=792257280 is handled. Duration 506 ms by bot id=6235250605
2024-07-07 20:36:44,561 - WARNING - Received SIGINT signal
2024-07-07 20:36:44,563 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 20:36:44,564 - INFO - Polling stopped
2024-07-07 20:37:17,280 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 20:37:17,281 - INFO - Added job "on_startup" to job store "default"
2024-07-07 20:37:17,281 - INFO - Scheduler started
2024-07-07 20:37:17,281 - INFO - Start polling
2024-07-07 20:37:23,907 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 20:37:24,047 - INFO - Received message from 964635576: /subscribe
2024-07-07 20:37:24,076 - INFO - select pg_catalog.version()
2024-07-07 20:37:24,077 - INFO - [raw sql] ()
2024-07-07 20:37:24,088 - INFO - select current_schema()
2024-07-07 20:37:24,088 - INFO - [raw sql] ()
2024-07-07 20:37:24,090 - INFO - show standard_conforming_strings
2024-07-07 20:37:24,090 - INFO - [raw sql] ()
2024-07-07 20:37:24,092 - INFO - BEGIN (implicit)
2024-07-07 20:37:24,096 - INFO - SELECT municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-07 20:37:24,096 - INFO - [generated in 0.00026s] ()
2024-07-07 20:37:24,772 - INFO - ROLLBACK
2024-07-07 20:37:24,772 - INFO - Update id=792257281 is handled. Duration 730 ms by bot id=6235250605
2024-07-07 20:37:35,806 - WARNING - Received SIGINT signal
2024-07-07 20:37:35,809 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 20:37:35,809 - INFO - Polling stopped
2024-07-07 20:37:40,026 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 20:37:40,027 - INFO - Added job "on_startup" to job store "default"
2024-07-07 20:37:40,027 - INFO - Scheduler started
2024-07-07 20:37:40,027 - INFO - Start polling
2024-07-07 20:37:40,389 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 20:37:43,212 - INFO - Received message from 964635576: /subscribe
2024-07-07 20:37:43,223 - INFO - select pg_catalog.version()
2024-07-07 20:37:43,223 - INFO - [raw sql] ()
2024-07-07 20:37:43,224 - INFO - select current_schema()
2024-07-07 20:37:43,224 - INFO - [raw sql] ()
2024-07-07 20:37:43,225 - INFO - show standard_conforming_strings
2024-07-07 20:37:43,225 - INFO - [raw sql] ()
2024-07-07 20:37:43,226 - INFO - BEGIN (implicit)
2024-07-07 20:37:43,229 - INFO - SELECT municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-07 20:37:43,229 - INFO - [generated in 0.00037s] ()
2024-07-07 20:37:43,728 - INFO - ROLLBACK
2024-07-07 20:37:43,729 - INFO - Update id=792257282 is handled. Duration 532 ms by bot id=6235250605
2024-07-07 20:37:49,022 - WARNING - Received SIGINT signal
2024-07-07 20:37:49,024 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 20:37:49,024 - INFO - Polling stopped
2024-07-07 20:41:27,496 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 20:41:27,497 - INFO - Added job "on_startup" to job store "default"
2024-07-07 20:41:27,497 - INFO - Scheduler started
2024-07-07 20:41:27,497 - INFO - Start polling
2024-07-07 20:41:27,850 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 20:41:30,055 - INFO - Received message from 964635576: /subscribe
2024-07-07 20:41:30,100 - INFO - select pg_catalog.version()
2024-07-07 20:41:30,100 - INFO - [raw sql] ()
2024-07-07 20:41:30,105 - INFO - select current_schema()
2024-07-07 20:41:30,105 - INFO - [raw sql] ()
2024-07-07 20:41:30,107 - INFO - show standard_conforming_strings
2024-07-07 20:41:30,107 - INFO - [raw sql] ()
2024-07-07 20:41:30,108 - INFO - BEGIN (implicit)
2024-07-07 20:41:30,110 - INFO - SELECT municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-07 20:41:30,110 - INFO - [generated in 0.00012s] ()
2024-07-07 20:41:30,625 - INFO - ROLLBACK
2024-07-07 20:41:30,626 - INFO - Update id=792257283 is handled. Duration 589 ms by bot id=6235250605
2024-07-07 20:41:57,499 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 20:42:27 +07)" (scheduled at 2024-07-07 20:41:57.496596+07:00)
2024-07-07 20:41:59,281 - ERROR - Failed to initialize and load data:
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/bot.py", line 26, in on_startup
    await check_news(Message)
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 242, in check_news
    df_2 = pd.read_sql_query(con=session_maker, sql=check_query)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 526, in read_sql_query
    return pandas_sql.read_query(
           ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 2738, in read_query
    cursor = self.execute(sql, params)
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 2672, in execute
    cur = self.con.cursor()
          ^^^^^^^^^^^^^^^
AttributeError: 'async_sessionmaker' object has no attribute 'cursor'
2024-07-07 20:41:59,284 - INFO - Job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 20:42:27 +07)" executed successfully
2024-07-07 20:42:18,160 - WARNING - Received SIGINT signal
2024-07-07 20:42:18,164 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 20:42:18,165 - INFO - Polling stopped
2024-07-07 20:45:37,267 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 20:45:37,268 - INFO - Added job "on_startup" to job store "default"
2024-07-07 20:45:37,268 - INFO - Scheduler started
2024-07-07 20:45:37,268 - INFO - Start polling
2024-07-07 20:45:37,608 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 20:45:40,452 - INFO - Received message from 964635576: /subscribe
2024-07-07 20:45:40,503 - INFO - select pg_catalog.version()
2024-07-07 20:45:40,504 - INFO - [raw sql] ()
2024-07-07 20:45:40,507 - INFO - select current_schema()
2024-07-07 20:45:40,508 - INFO - [raw sql] ()
2024-07-07 20:45:40,515 - INFO - show standard_conforming_strings
2024-07-07 20:45:40,516 - INFO - [raw sql] ()
2024-07-07 20:45:40,517 - INFO - BEGIN (implicit)
2024-07-07 20:45:40,520 - INFO - SELECT municipalities.municipality_name, municipalities.municipality_name AS municipality_name__1 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-07 20:45:40,520 - INFO - [generated in 0.00014s] ()
2024-07-07 20:45:41,107 - INFO - ROLLBACK
2024-07-07 20:45:41,108 - INFO - Update id=792257284 is handled. Duration 675 ms by bot id=6235250605
2024-07-07 20:46:07,269 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 20:46:37 +07)" (scheduled at 2024-07-07 20:46:07.267469+07:00)
2024-07-07 20:46:09,200 - ERROR - Failed to initialize and load data:
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/bot.py", line 26, in on_startup
    await check_news(Message)
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 241, in check_news
    df_2 = pd.read_sql_query(con=session_maker, sql=check_query)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 526, in read_sql_query
    return pandas_sql.read_query(
           ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 2738, in read_query
    cursor = self.execute(sql, params)
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/io/sql.py", line 2672, in execute
    cur = self.con.cursor()
          ^^^^^^^^^^^^^^^
AttributeError: 'async_sessionmaker' object has no attribute 'cursor'
2024-07-07 20:46:09,204 - INFO - Job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 20:46:37 +07)" executed successfully
2024-07-07 20:46:09,848 - WARNING - Received SIGINT signal
2024-07-07 20:46:09,849 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 20:46:09,849 - INFO - Polling stopped
2024-07-07 20:46:14,237 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 20:46:14,238 - INFO - Added job "on_startup" to job store "default"
2024-07-07 20:46:14,238 - INFO - Scheduler started
2024-07-07 20:46:14,238 - INFO - Start polling
2024-07-07 20:46:14,599 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 20:46:17,308 - INFO - Received message from 964635576: /subscribe
2024-07-07 20:46:17,323 - INFO - select pg_catalog.version()
2024-07-07 20:46:17,323 - INFO - [raw sql] ()
2024-07-07 20:46:17,325 - INFO - select current_schema()
2024-07-07 20:46:17,325 - INFO - [raw sql] ()
2024-07-07 20:46:17,326 - INFO - show standard_conforming_strings
2024-07-07 20:46:17,326 - INFO - [raw sql] ()
2024-07-07 20:46:17,327 - INFO - BEGIN (implicit)
2024-07-07 20:46:17,329 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-07 20:46:17,329 - INFO - [generated in 0.00023s] ()
2024-07-07 20:46:17,825 - INFO - ROLLBACK
2024-07-07 20:46:17,826 - INFO - Update id=792257285 is handled. Duration 522 ms by bot id=6235250605
2024-07-07 20:46:22,845 - WARNING - Received SIGINT signal
2024-07-07 20:46:22,848 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 20:46:22,849 - INFO - Polling stopped
2024-07-07 20:47:29,170 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 20:47:29,170 - INFO - Added job "on_startup" to job store "default"
2024-07-07 20:47:29,170 - INFO - Scheduler started
2024-07-07 20:47:29,171 - INFO - Start polling
2024-07-07 20:47:29,497 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 20:47:32,057 - INFO - Received message from 964635576: /subscribe
2024-07-07 20:47:32,085 - INFO - select pg_catalog.version()
2024-07-07 20:47:32,085 - INFO - [raw sql] ()
2024-07-07 20:47:32,087 - INFO - select current_schema()
2024-07-07 20:47:32,087 - INFO - [raw sql] ()
2024-07-07 20:47:32,088 - INFO - show standard_conforming_strings
2024-07-07 20:47:32,088 - INFO - [raw sql] ()
2024-07-07 20:47:32,089 - INFO - BEGIN (implicit)
2024-07-07 20:47:32,091 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-07 20:47:32,091 - INFO - [generated in 0.00010s] ()
2024-07-07 20:47:32,696 - INFO - ROLLBACK
2024-07-07 20:47:32,697 - INFO - Update id=792257286 is handled. Duration 644 ms by bot id=6235250605
2024-07-07 20:47:37,383 - WARNING - Received SIGINT signal
2024-07-07 20:47:37,389 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 20:47:37,390 - INFO - Polling stopped
2024-07-07 21:19:35,687 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 21:19:35,688 - INFO - Added job "on_startup" to job store "default"
2024-07-07 21:19:35,688 - INFO - Scheduler started
2024-07-07 21:19:35,688 - INFO - Start polling
2024-07-07 21:19:36,061 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 21:19:39,258 - INFO - Received message from 964635576: /subscribe
2024-07-07 21:19:39,332 - INFO - select pg_catalog.version()
2024-07-07 21:19:39,332 - INFO - [raw sql] ()
2024-07-07 21:19:39,338 - INFO - select current_schema()
2024-07-07 21:19:39,338 - INFO - [raw sql] ()
2024-07-07 21:19:39,344 - INFO - show standard_conforming_strings
2024-07-07 21:19:39,344 - INFO - [raw sql] ()
2024-07-07 21:19:39,345 - INFO - BEGIN (implicit)
2024-07-07 21:19:39,348 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-07 21:19:39,348 - INFO - [generated in 0.00016s] ()
2024-07-07 21:19:39,767 - INFO - ROLLBACK
2024-07-07 21:19:39,768 - INFO - Update id=792257287 is handled. Duration 518 ms by bot id=6235250605
2024-07-07 21:19:41,783 - INFO - Received message from 964635576: Емельяновский район
2024-07-07 21:19:41,785 - INFO - BEGIN (implicit)
2024-07-07 21:19:41,788 - INFO - SELECT subscriptions.map_id 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT
2024-07-07 21:19:41,788 - INFO - [generated in 0.00031s] (964635576,)
2024-07-07 21:19:41,794 - INFO - ROLLBACK
2024-07-07 21:19:41,795 - INFO - Update id=792257288 is not handled. Duration 13 ms by bot id=6235250605
2024-07-07 21:19:41,795 - ERROR - Cause exception while process update id=792257288 by bot id=6235250605
MultipleResultsFound: Multiple rows were found when exactly one was required
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 49, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/fsm/middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/database/db.py", line 21, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 170, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 162, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/logging_middleware.py", line 8, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 128, in subscribe
    subscription_exists = result.one()
                         ^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/result.py", line 1520, in one
    return self._only_one_row(
           ^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/result.py", line 805, in _only_one_row
    raise exc.MultipleResultsFound(
sqlalchemy.exc.MultipleResultsFound: Multiple rows were found when exactly one was required
2024-07-07 21:19:54,877 - WARNING - Received SIGINT signal
2024-07-07 21:19:54,879 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 21:19:54,879 - INFO - Polling stopped
2024-07-07 21:21:51,725 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 21:21:51,726 - INFO - Added job "on_startup" to job store "default"
2024-07-07 21:21:51,726 - INFO - Scheduler started
2024-07-07 21:21:51,726 - INFO - Start polling
2024-07-07 21:21:52,075 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 21:21:54,066 - INFO - Received message from 964635576: /subscribe
2024-07-07 21:21:54,076 - INFO - select pg_catalog.version()
2024-07-07 21:21:54,076 - INFO - [raw sql] ()
2024-07-07 21:21:54,077 - INFO - select current_schema()
2024-07-07 21:21:54,077 - INFO - [raw sql] ()
2024-07-07 21:21:54,078 - INFO - show standard_conforming_strings
2024-07-07 21:21:54,078 - INFO - [raw sql] ()
2024-07-07 21:21:54,079 - INFO - BEGIN (implicit)
2024-07-07 21:21:54,081 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-07 21:21:54,081 - INFO - [generated in 0.00027s] ()
2024-07-07 21:21:54,463 - INFO - ROLLBACK
2024-07-07 21:21:54,464 - INFO - Update id=792257289 is handled. Duration 401 ms by bot id=6235250605
2024-07-07 21:21:55,494 - INFO - Received message from 964635576: Балахтинский район
2024-07-07 21:21:55,496 - INFO - BEGIN (implicit)
2024-07-07 21:21:55,498 - INFO - SELECT subscriptions.map_id 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT
2024-07-07 21:21:55,498 - INFO - [generated in 0.00027s] (964635576,)
2024-07-07 21:21:55,657 - INFO - ROLLBACK
2024-07-07 21:21:55,658 - INFO - Update id=792257290 is handled. Duration 164 ms by bot id=6235250605
2024-07-07 21:22:00,363 - INFO - Received message from 964635576: /subscribe
2024-07-07 21:22:00,365 - INFO - BEGIN (implicit)
2024-07-07 21:22:00,365 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-07 21:22:00,366 - INFO - [cached since 6.285s ago] ()
2024-07-07 21:22:00,600 - INFO - ROLLBACK
2024-07-07 21:22:00,600 - INFO - Update id=792257291 is handled. Duration 239 ms by bot id=6235250605
2024-07-07 21:22:02,227 - INFO - Received message from 964635576: Саянский район
2024-07-07 21:22:02,229 - INFO - BEGIN (implicit)
2024-07-07 21:22:02,229 - INFO - SELECT subscriptions.map_id 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT
2024-07-07 21:22:02,229 - INFO - [cached since 6.732s ago] (964635576,)
2024-07-07 21:22:02,364 - INFO - ROLLBACK
2024-07-07 21:22:02,365 - INFO - Update id=792257292 is handled. Duration 138 ms by bot id=6235250605
2024-07-07 21:22:06,895 - INFO - Received message from 964635576: /subscribe
2024-07-07 21:22:06,895 - INFO - BEGIN (implicit)
2024-07-07 21:22:06,896 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-07 21:22:06,896 - INFO - [cached since 12.82s ago] ()
2024-07-07 21:22:07,050 - INFO - ROLLBACK
2024-07-07 21:22:07,051 - INFO - Update id=792257293 is handled. Duration 157 ms by bot id=6235250605
2024-07-07 21:22:09,037 - INFO - Received message from 964635576: Шушенский район
2024-07-07 21:22:09,038 - INFO - BEGIN (implicit)
2024-07-07 21:22:09,039 - INFO - SELECT subscriptions.map_id 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT
2024-07-07 21:22:09,039 - INFO - [cached since 13.54s ago] (964635576,)
2024-07-07 21:22:09,186 - INFO - ROLLBACK
2024-07-07 21:22:09,187 - INFO - Update id=792257294 is handled. Duration 151 ms by bot id=6235250605
2024-07-07 21:22:21,585 - WARNING - Received SIGINT signal
2024-07-07 21:22:21,592 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 21:22:21,592 - INFO - Polling stopped
2024-07-07 21:22:21,727 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 21:22:51 +07)" (scheduled at 2024-07-07 21:22:21.725478+07:00)
2024-07-07 21:22:22,044 - ERROR - Job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 21:22:51 +07)" raised an exception
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/apscheduler/executors/base_py3.py", line 30, in run_coroutine_job
    retval = await job.func(*job.args, **job.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/bot.py", line 25, in on_startup
    await fetch_and_save_files()
  File "/Users/rejoller/python_projects/mchs_tg_bot/email_checker.py", line 38, in fetch_and_save_files
    await asyncio.to_thread(mail.login, EMAIL, PASSWORD)
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/threads.py", line 25, in to_thread
    return await loop.run_in_executor(None, func_call)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
asyncio.exceptions.CancelledError
2024-07-07 21:23:26,114 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 21:23:26,114 - INFO - Added job "on_startup" to job store "default"
2024-07-07 21:23:26,114 - INFO - Scheduler started
2024-07-07 21:23:26,114 - INFO - Start polling
2024-07-07 21:23:26,482 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 21:23:34,345 - INFO - Received message from 964635576: /subscribe
2024-07-07 21:23:34,359 - INFO - select pg_catalog.version()
2024-07-07 21:23:34,359 - INFO - [raw sql] ()
2024-07-07 21:23:34,360 - INFO - select current_schema()
2024-07-07 21:23:34,360 - INFO - [raw sql] ()
2024-07-07 21:23:34,361 - INFO - show standard_conforming_strings
2024-07-07 21:23:34,361 - INFO - [raw sql] ()
2024-07-07 21:23:34,362 - INFO - BEGIN (implicit)
2024-07-07 21:23:34,364 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-07 21:23:34,364 - INFO - [generated in 0.00009s] ()
2024-07-07 21:23:34,741 - INFO - ROLLBACK
2024-07-07 21:23:34,742 - INFO - Update id=792257295 is handled. Duration 411 ms by bot id=6235250605
2024-07-07 21:23:36,695 - INFO - Received message from 964635576: Саянский район
2024-07-07 21:23:36,698 - INFO - BEGIN (implicit)
2024-07-07 21:23:36,699 - INFO - SELECT subscriptions.map_id 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT
2024-07-07 21:23:36,700 - INFO - [generated in 0.00029s] (964635576,)
2024-07-07 21:23:37,010 - INFO - ROLLBACK
2024-07-07 21:23:37,011 - INFO - Update id=792257296 is handled. Duration 317 ms by bot id=6235250605
2024-07-07 21:23:45,158 - WARNING - Received SIGINT signal
2024-07-07 21:23:45,162 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 21:23:45,163 - INFO - Polling stopped
2024-07-07 21:54:46,010 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 21:54:46,012 - INFO - Added job "on_startup" to job store "default"
2024-07-07 21:54:46,012 - INFO - Scheduler started
2024-07-07 21:54:46,013 - INFO - Start polling
2024-07-07 21:54:46,372 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 21:54:58,692 - INFO - Received message from 964635576: /subscribe
2024-07-07 21:54:58,729 - INFO - select pg_catalog.version()
2024-07-07 21:54:58,730 - INFO - [raw sql] ()
2024-07-07 21:54:58,740 - INFO - select current_schema()
2024-07-07 21:54:58,741 - INFO - [raw sql] ()
2024-07-07 21:54:58,743 - INFO - show standard_conforming_strings
2024-07-07 21:54:58,743 - INFO - [raw sql] ()
2024-07-07 21:54:58,746 - INFO - BEGIN (implicit)
2024-07-07 21:54:58,758 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-07 21:54:58,759 - INFO - [generated in 0.00115s] ()
2024-07-07 21:54:59,427 - INFO - ROLLBACK
2024-07-07 21:54:59,428 - INFO - Update id=792257297 is handled. Duration 762 ms by bot id=6235250605
2024-07-07 21:55:05,083 - INFO - Received message from 964635576: Ачинский район
2024-07-07 21:55:05,091 - INFO - BEGIN (implicit)
2024-07-07 21:55:05,095 - INFO - SELECT subscriptions.map_id 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT
2024-07-07 21:55:05,095 - INFO - [generated in 0.00045s] (964635576,)
2024-07-07 21:55:05,684 - INFO - ROLLBACK
2024-07-07 21:55:05,685 - INFO - Update id=792257298 is handled. Duration 606 ms by bot id=6235250605
2024-07-07 21:55:45,509 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 21:55:45,511 - INFO - Added job "on_startup" to job store "default"
2024-07-07 21:55:45,511 - INFO - Scheduler started
2024-07-07 21:55:45,512 - INFO - Start polling
2024-07-07 21:55:45,856 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 21:56:15,515 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 21:56:45 +07)" (scheduled at 2024-07-07 21:56:15.509325+07:00)
2024-07-07 22:01:39,123 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 22:01:39,125 - INFO - Added job "on_startup" to job store "default"
2024-07-07 22:01:39,125 - INFO - Scheduler started
2024-07-07 22:01:39,126 - INFO - Start polling
2024-07-07 22:01:39,508 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 22:02:09,130 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 22:02:39 +07)" (scheduled at 2024-07-07 22:02:09.123353+07:00)
2024-07-07 22:03:27,532 - ERROR - Failed to initialize and load data:
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/bot.py", line 26, in on_startup
    await fetch_and_save_files()
          ^^^^^^^^^^^^^^^^^^^
TypeError: check_news() missing 1 required positional argument: 'session'
2024-07-07 22:03:38,956 - INFO - Job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 22:02:39 +07)" executed successfully
2024-07-07 22:03:38,961 - ERROR - Failed to fetch updates - TelegramNetworkError: HTTP Client says - Request timeout error
2024-07-07 22:03:38,961 - WARNING - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 6235250605)
2024-07-07 22:03:38,964 - WARNING - Received SIGINT signal
2024-07-07 22:03:38,964 - WARNING - Received SIGINT signal
2024-07-07 22:03:38,969 - WARNING - Run time of job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 22:03:39 +07)" was missed by 0:00:29.845674
2024-07-07 22:03:38,972 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 22:03:38,972 - INFO - Polling stopped
2024-07-07 22:03:39,124 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 22:04:09 +07)" (scheduled at 2024-07-07 22:03:39.123353+07:00)
2024-07-07 22:04:11,398 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 22:04:11,399 - INFO - Added job "on_startup" to job store "default"
2024-07-07 22:04:11,399 - INFO - Scheduler started
2024-07-07 22:04:11,399 - INFO - Start polling
2024-07-07 22:04:11,733 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 22:04:14,427 - WARNING - Received SIGINT signal
2024-07-07 22:04:14,428 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 22:04:14,428 - INFO - Polling stopped
2024-07-07 22:04:23,401 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 22:04:23,403 - INFO - Added job "on_startup" to job store "default"
2024-07-07 22:04:23,403 - INFO - Scheduler started
2024-07-07 22:04:23,403 - INFO - Start polling
2024-07-07 22:04:23,759 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 22:04:53,406 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 22:05:23 +07)" (scheduled at 2024-07-07 22:04:53.401230+07:00)
2024-07-07 22:05:59,707 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 22:05:59,708 - INFO - Added job "on_startup" to job store "default"
2024-07-07 22:05:59,709 - INFO - Scheduler started
2024-07-07 22:05:59,709 - INFO - Start polling
2024-07-07 22:06:00,054 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 22:06:29,713 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 22:06:59 +07)" (scheduled at 2024-07-07 22:06:29.706808+07:00)
2024-07-07 22:07:50,143 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 22:07:50,145 - INFO - Added job "on_startup" to job store "default"
2024-07-07 22:07:50,145 - INFO - Scheduler started
2024-07-07 22:07:50,146 - INFO - Start polling
2024-07-07 22:07:50,537 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 22:08:20,149 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 22:08:50 +07)" (scheduled at 2024-07-07 22:08:20.143243+07:00)
2024-07-07 22:10:55,458 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 22:10:55,459 - INFO - Added job "on_startup" to job store "default"
2024-07-07 22:10:55,459 - INFO - Scheduler started
2024-07-07 22:10:55,459 - INFO - Start polling
2024-07-07 22:10:55,811 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 22:11:01,892 - WARNING - Received SIGINT signal
2024-07-07 22:11:01,898 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 22:11:01,898 - INFO - Polling stopped
2024-07-07 22:11:07,463 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 22:11:07,463 - INFO - Added job "on_startup" to job store "default"
2024-07-07 22:11:07,463 - INFO - Scheduler started
2024-07-07 22:11:07,464 - INFO - Start polling
2024-07-07 22:11:07,787 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 22:11:37,466 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 22:12:07 +07)" (scheduled at 2024-07-07 22:11:37.463127+07:00)
2024-07-07 22:11:39,286 - ERROR - Failed to initialize and load data:
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/bot.py", line 28, in on_startup
    await check_news(Message, session=AsyncSession)
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 250, in check_news
    result = await session.execute(subscribers_query)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: AsyncSession.execute() missing 1 required positional argument: 'statement'
2024-07-07 22:11:39,287 - INFO - Job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 22:12:07 +07)" executed successfully
2024-07-07 22:11:41,572 - WARNING - Received SIGINT signal
2024-07-07 22:11:41,574 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 22:11:41,575 - INFO - Polling stopped
2024-07-07 22:11:51,557 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 22:11:51,558 - INFO - Added job "on_startup" to job store "default"
2024-07-07 22:11:51,558 - INFO - Scheduler started
2024-07-07 22:11:51,559 - INFO - Start polling
2024-07-07 22:11:51,888 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 22:12:21,562 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 22:12:51 +07)" (scheduled at 2024-07-07 22:12:21.557906+07:00)
2024-07-07 22:12:23,421 - ERROR - Failed to initialize and load data:
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/bot.py", line 28, in on_startup
    await check_news(Message, AsyncSession)
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 250, in check_news
    result = await session.execute(subscribers_query)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: AsyncSession.execute() missing 1 required positional argument: 'statement'
2024-07-07 22:12:23,422 - INFO - Job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 22:12:51 +07)" executed successfully
2024-07-07 22:12:37,350 - WARNING - Received SIGINT signal
2024-07-07 22:12:37,353 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 22:12:37,353 - INFO - Polling stopped
2024-07-07 22:15:28,391 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 22:15:28,392 - INFO - Added job "on_startup" to job store "default"
2024-07-07 22:15:28,392 - INFO - Scheduler started
2024-07-07 22:15:28,392 - INFO - Start polling
2024-07-07 22:15:28,718 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 22:15:58,394 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 22:16:28 +07)" (scheduled at 2024-07-07 22:15:58.391761+07:00)
2024-07-07 22:16:00,005 - ERROR - Failed to initialize and load data:
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/bot.py", line 28, in on_startup
    await check_news(Message, AsyncSession)
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 250, in check_news
    result = await session.execute(subscribers_query)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: AsyncSession.execute() missing 1 required positional argument: 'statement'
2024-07-07 22:16:00,010 - INFO - Job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 22:16:28 +07)" executed successfully
2024-07-07 22:16:28,392 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 22:16:58 +07)" (scheduled at 2024-07-07 22:16:28.391761+07:00)
2024-07-07 22:16:30,232 - ERROR - Failed to initialize and load data:
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/bot.py", line 28, in on_startup
    await check_news(Message, AsyncSession)
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 250, in check_news
    result = await session.execute(subscribers_query)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: AsyncSession.execute() missing 1 required positional argument: 'statement'
2024-07-07 22:16:30,233 - INFO - Job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 22:16:58 +07)" executed successfully
2024-07-07 22:16:33,502 - WARNING - Received SIGINT signal
2024-07-07 22:16:33,504 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 22:16:33,504 - INFO - Polling stopped
2024-07-07 22:16:58,414 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 22:16:58,415 - INFO - Added job "on_startup" to job store "default"
2024-07-07 22:16:58,415 - INFO - Scheduler started
2024-07-07 22:16:58,415 - INFO - Start polling
2024-07-07 22:16:58,772 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 22:17:28,418 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 22:17:58 +07)" (scheduled at 2024-07-07 22:17:28.414595+07:00)
2024-07-07 22:17:30,434 - ERROR - Failed to initialize and load data:
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/bot.py", line 28, in on_startup
    await check_news(Message, AsyncSession)
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 252, in check_news
    result = await session.execute(subscribers_query)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: AsyncSession.execute() missing 1 required positional argument: 'statement'
2024-07-07 22:17:30,434 - INFO - Job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 22:17:58 +07)" executed successfully
2024-07-07 22:17:37,505 - WARNING - Received SIGINT signal
2024-07-07 22:17:37,512 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 22:17:37,513 - INFO - Polling stopped
2024-07-07 22:20:10,494 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 22:20:10,494 - INFO - Added job "on_startup" to job store "default"
2024-07-07 22:20:10,494 - INFO - Scheduler started
2024-07-07 22:20:10,495 - INFO - Start polling
2024-07-07 22:20:10,918 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 22:20:40,498 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 22:21:10 +07)" (scheduled at 2024-07-07 22:20:40.494076+07:00)
2024-07-07 22:20:42,545 - ERROR - Failed to initialize and load data:
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/bot.py", line 28, in on_startup
    await check_news(Message, AsyncSession)
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 253, in check_news
    result = await session.execute(subscribers_query)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: AsyncSession.execute() missing 1 required positional argument: 'statement'
2024-07-07 22:20:42,546 - INFO - Job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 22:21:10 +07)" executed successfully
2024-07-07 22:20:49,341 - WARNING - Received SIGINT signal
2024-07-07 22:20:49,344 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 22:20:49,344 - INFO - Polling stopped
2024-07-07 22:27:56,312 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 22:27:56,313 - INFO - Added job "on_startup" to job store "default"
2024-07-07 22:27:56,313 - INFO - Scheduler started
2024-07-07 22:27:56,313 - INFO - Start polling
2024-07-07 22:27:56,660 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 22:28:26,319 - INFO - Running job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 22:28:56 +07)" (scheduled at 2024-07-07 22:28:26.312415+07:00)
2024-07-07 22:28:28,102 - INFO - select pg_catalog.version()
2024-07-07 22:28:28,102 - INFO - [raw sql] ()
2024-07-07 22:28:28,105 - INFO - select current_schema()
2024-07-07 22:28:28,105 - INFO - [raw sql] ()
2024-07-07 22:28:28,108 - INFO - show standard_conforming_strings
2024-07-07 22:28:28,108 - INFO - [raw sql] ()
2024-07-07 22:28:28,108 - INFO - BEGIN (implicit)
2024-07-07 22:28:28,111 - INFO - SELECT subscriptions.user_id, subscriptions.map_id, subscriptions.municipality_name, subscriptions.subscribed_at 
FROM subscriptions
2024-07-07 22:28:28,111 - INFO - [generated in 0.00016s] ()
2024-07-07 22:28:28,114 - ERROR - Failed to initialize and load data:
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/bot.py", line 29, in on_startup
    await check_news(Message, session)
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 269, in check_news
    result_df = df.merge(df_2, left_on='ID Карты', right_on='map_id')
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/core/frame.py", line 10832, in merge
    return merge(
           ^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/core/reshape/merge.py", line 170, in merge
    op = _MergeOperation(
         ^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/core/reshape/merge.py", line 794, in __init__
    ) = self._get_merge_keys()
        ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/core/reshape/merge.py", line 1297, in _get_merge_keys
    right_keys.append(right._get_label_or_level_values(rk))
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/core/generic.py", line 1911, in _get_label_or_level_values
    raise KeyError(key)
KeyError: 'map_id'
2024-07-07 22:28:28,120 - INFO - ROLLBACK
2024-07-07 22:28:28,121 - INFO - Job "on_startup (trigger: interval[0:00:30], next run at: 2024-07-07 22:28:56 +07)" executed successfully
2024-07-07 22:28:51,011 - WARNING - Received SIGINT signal
2024-07-07 22:28:51,014 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 22:28:51,014 - INFO - Polling stopped
2024-07-07 22:31:23,474 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 22:31:23,474 - INFO - Added job "on_startup" to job store "default"
2024-07-07 22:31:23,474 - INFO - Scheduler started
2024-07-07 22:31:23,475 - INFO - Start polling
2024-07-07 22:31:23,803 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 22:31:35,479 - INFO - Running job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 22:31:47 +07)" (scheduled at 2024-07-07 22:31:35.474021+07:00)
2024-07-07 22:31:37,131 - INFO - select pg_catalog.version()
2024-07-07 22:31:37,132 - INFO - [raw sql] ()
2024-07-07 22:31:37,133 - INFO - select current_schema()
2024-07-07 22:31:37,133 - INFO - [raw sql] ()
2024-07-07 22:31:37,134 - INFO - show standard_conforming_strings
2024-07-07 22:31:37,134 - INFO - [raw sql] ()
2024-07-07 22:31:37,134 - INFO - BEGIN (implicit)
2024-07-07 22:31:37,137 - INFO - SELECT subscriptions.user_id, subscriptions.map_id, subscriptions.municipality_name, subscriptions.subscribed_at 
FROM subscriptions
2024-07-07 22:31:37,137 - INFO - [generated in 0.00008s] ()
2024-07-07 22:31:37,139 - ERROR - Failed to initialize and load data:
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/bot.py", line 29, in on_startup
    await check_news(Message, session)
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 272, in check_news
    result_df = df.merge(df_2, left_on='ID Карты', right_on='map_id')
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/core/frame.py", line 10832, in merge
    return merge(
           ^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/core/reshape/merge.py", line 170, in merge
    op = _MergeOperation(
         ^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/core/reshape/merge.py", line 794, in __init__
    ) = self._get_merge_keys()
        ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/core/reshape/merge.py", line 1297, in _get_merge_keys
    right_keys.append(right._get_label_or_level_values(rk))
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/pandas/core/generic.py", line 1911, in _get_label_or_level_values
    raise KeyError(key)
KeyError: 'map_id'
2024-07-07 22:31:37,146 - INFO - ROLLBACK
2024-07-07 22:31:37,146 - INFO - Job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 22:31:47 +07)" executed successfully
2024-07-07 22:31:39,110 - WARNING - Received SIGINT signal
2024-07-07 22:31:39,112 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 22:31:39,112 - INFO - Polling stopped
2024-07-07 22:32:11,671 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 22:32:11,672 - INFO - Added job "on_startup" to job store "default"
2024-07-07 22:32:11,672 - INFO - Scheduler started
2024-07-07 22:32:11,672 - INFO - Start polling
2024-07-07 22:32:12,015 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 22:32:23,675 - INFO - Running job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 22:32:35 +07)" (scheduled at 2024-07-07 22:32:23.671717+07:00)
2024-07-07 22:32:25,623 - INFO - select pg_catalog.version()
2024-07-07 22:32:25,623 - INFO - [raw sql] ()
2024-07-07 22:32:25,625 - INFO - select current_schema()
2024-07-07 22:32:25,625 - INFO - [raw sql] ()
2024-07-07 22:32:25,625 - INFO - show standard_conforming_strings
2024-07-07 22:32:25,625 - INFO - [raw sql] ()
2024-07-07 22:32:25,626 - INFO - BEGIN (implicit)
2024-07-07 22:32:25,628 - INFO - SELECT subscriptions.user_id, subscriptions.map_id, subscriptions.municipality_name, subscriptions.subscribed_at 
FROM subscriptions
2024-07-07 22:32:25,628 - INFO - [generated in 0.00010s] ()
2024-07-07 22:32:25,643 - ERROR - Failed to initialize and load data:
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/bot.py", line 29, in on_startup
    await check_news(Message, session)
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 282, in check_news
    cur = connection.cursor()
          ^^^^^^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'cursor'
2024-07-07 22:32:25,644 - INFO - ROLLBACK
2024-07-07 22:32:25,644 - INFO - Job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 22:32:35 +07)" executed successfully
2024-07-07 22:32:27,692 - WARNING - Received SIGINT signal
2024-07-07 22:32:27,693 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 22:32:27,694 - INFO - Polling stopped
2024-07-07 22:32:52,126 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 22:32:52,127 - INFO - Added job "on_startup" to job store "default"
2024-07-07 22:32:52,127 - INFO - Scheduler started
2024-07-07 22:32:52,127 - INFO - Start polling
2024-07-07 22:32:52,477 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 22:33:04,129 - INFO - Running job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 22:33:16 +07)" (scheduled at 2024-07-07 22:33:04.126427+07:00)
2024-07-07 22:33:05,771 - INFO - select pg_catalog.version()
2024-07-07 22:33:05,772 - INFO - [raw sql] ()
2024-07-07 22:33:05,774 - INFO - select current_schema()
2024-07-07 22:33:05,774 - INFO - [raw sql] ()
2024-07-07 22:33:05,775 - INFO - show standard_conforming_strings
2024-07-07 22:33:05,775 - INFO - [raw sql] ()
2024-07-07 22:33:05,776 - INFO - BEGIN (implicit)
2024-07-07 22:33:05,779 - INFO - SELECT subscriptions.user_id, subscriptions.map_id, subscriptions.municipality_name, subscriptions.subscribed_at 
FROM subscriptions
2024-07-07 22:33:05,779 - INFO - [generated in 0.00018s] ()
2024-07-07 22:33:05,815 - ERROR - Failed to initialize and load data:
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/bot.py", line 29, in on_startup
    await check_news(Message, session)
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 283, in check_news
    cur = connection.cursor()
          ^^^^^^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'cursor'
2024-07-07 22:33:05,816 - INFO - ROLLBACK
2024-07-07 22:33:05,816 - INFO - Job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 22:33:16 +07)" executed successfully
2024-07-07 22:33:13,323 - WARNING - Received SIGINT signal
2024-07-07 22:33:13,325 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 22:33:13,325 - INFO - Polling stopped
2024-07-07 22:50:12,290 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 22:50:12,292 - INFO - Added job "on_startup" to job store "default"
2024-07-07 22:50:12,292 - INFO - Scheduler started
2024-07-07 22:50:12,293 - INFO - Start polling
2024-07-07 22:50:12,667 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 22:50:24,293 - INFO - Running job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 22:50:36 +07)" (scheduled at 2024-07-07 22:50:24.290222+07:00)
2024-07-07 22:50:26,118 - INFO - select pg_catalog.version()
2024-07-07 22:50:26,118 - INFO - [raw sql] ()
2024-07-07 22:50:26,127 - INFO - select current_schema()
2024-07-07 22:50:26,128 - INFO - [raw sql] ()
2024-07-07 22:50:26,131 - INFO - show standard_conforming_strings
2024-07-07 22:50:26,132 - INFO - [raw sql] ()
2024-07-07 22:50:26,133 - INFO - BEGIN (implicit)
2024-07-07 22:50:26,141 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-07 22:50:26,141 - INFO - [generated in 0.00051s] ()
2024-07-07 22:50:26,292 - INFO - SELECT messages.id, messages.user_id, messages.message_id, messages.message_text, messages.date_of_sending 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-07 22:50:26,292 - INFO - [generated in 0.00028s] ('<561761720169067@mail.yandex.ru>',)
2024-07-07 22:52:06,021 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 22:52:06,021 - INFO - Added job "on_startup" to job store "default"
2024-07-07 22:52:06,021 - INFO - Scheduler started
2024-07-07 22:52:06,022 - INFO - Start polling
2024-07-07 22:52:06,377 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 22:52:18,022 - INFO - Running job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 22:52:30 +07)" (scheduled at 2024-07-07 22:52:18.021082+07:00)
2024-07-07 22:52:22,879 - INFO - select pg_catalog.version()
2024-07-07 22:52:22,879 - INFO - [raw sql] ()
2024-07-07 22:52:22,884 - INFO - select current_schema()
2024-07-07 22:52:22,884 - INFO - [raw sql] ()
2024-07-07 22:52:22,886 - INFO - show standard_conforming_strings
2024-07-07 22:52:22,886 - INFO - [raw sql] ()
2024-07-07 22:52:22,887 - INFO - BEGIN (implicit)
2024-07-07 22:52:22,890 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-07 22:52:22,890 - INFO - [generated in 0.00012s] ()
2024-07-07 22:52:22,926 - INFO - SELECT messages.id, messages.user_id, messages.message_id, messages.message_text, messages.date_of_sending 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-07 22:52:22,926 - INFO - [generated in 0.00015s] ('<561761720169067@mail.yandex.ru>',)
2024-07-07 22:52:22,928 - ERROR - Failed to initialize and load data:
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 514, in _prepare_and_execute
    prepared_stmt, attributes = await adapt_connection._prepare(
                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 760, in _prepare
    prepared_stmt = await self._connection.prepare(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/asyncpg/connection.py", line 636, in prepare
    return await self._prepare(
           ^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/asyncpg/connection.py", line 654, in _prepare
    stmt = await self._get_statement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/asyncpg/connection.py", line 433, in _get_statement
    statement = await self._protocol.prepare(
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "asyncpg/protocol/protocol.pyx", line 166, in prepare
asyncpg.exceptions.UndefinedColumnError: column messages.id does not exist

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 572, in execute
    self._adapt_connection.await_(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 550, in _prepare_and_execute
    self._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 501, in _handle_exception
    self._adapt_connection._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 784, in _handle_exception
    raise translated_error from error
sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.ProgrammingError: <class 'asyncpg.exceptions.UndefinedColumnError'>: column messages.id does not exist

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/bot.py", line 29, in on_startup
    await check_news(Message, session)
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 288, in check_news
    check_result = await session.execute(check_query)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py", line 461, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 201, in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2236, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/context.py", line 293, in orm_execute_statement
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1418, in execute
    return meth(
           ^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py", line 515, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1640, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2353, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 572, in execute
    self._adapt_connection.await_(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 550, in _prepare_and_execute
    self._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 501, in _handle_exception
    self._adapt_connection._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 784, in _handle_exception
    raise translated_error from error
sqlalchemy.exc.ProgrammingError: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: column messages.id does not exist
[SQL: SELECT messages.id, messages.user_id, messages.message_id, messages.message_text, messages.date_of_sending 
FROM messages 
WHERE messages.message_id = $1::VARCHAR]
[parameters: ('<561761720169067@mail.yandex.ru>',)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2024-07-07 22:52:22,936 - INFO - ROLLBACK
2024-07-07 22:52:22,937 - INFO - Job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 22:52:30 +07)" executed successfully
2024-07-07 22:52:30,023 - INFO - Running job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 22:52:42 +07)" (scheduled at 2024-07-07 22:52:30.021082+07:00)
2024-07-07 22:52:30,689 - WARNING - Received SIGINT signal
2024-07-07 22:52:30,690 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 22:52:30,690 - INFO - Polling stopped
2024-07-07 22:52:31,160 - ERROR - Job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 22:52:42 +07)" raised an exception
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/apscheduler/executors/base_py3.py", line 30, in run_coroutine_job
    retval = await job.func(*job.args, **job.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/bot.py", line 29, in on_startup
    await check_news(Message, session)
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 208, in check_news
    saved_files, subject, content, email_id = await fetch_and_save_files()
                                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/email_checker.py", line 38, in fetch_and_save_files
    await asyncio.to_thread(mail.login, EMAIL, PASSWORD)
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/threads.py", line 25, in to_thread
    return await loop.run_in_executor(None, func_call)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
asyncio.exceptions.CancelledError
2024-07-07 22:54:55,171 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 22:54:55,172 - INFO - Added job "on_startup" to job store "default"
2024-07-07 22:54:55,172 - INFO - Scheduler started
2024-07-07 22:54:55,173 - INFO - Start polling
2024-07-07 22:54:55,518 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 22:55:07,174 - INFO - Running job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 22:55:19 +07)" (scheduled at 2024-07-07 22:55:07.170830+07:00)
2024-07-07 22:55:08,963 - INFO - select pg_catalog.version()
2024-07-07 22:55:08,963 - INFO - [raw sql] ()
2024-07-07 22:55:08,971 - INFO - select current_schema()
2024-07-07 22:55:08,971 - INFO - [raw sql] ()
2024-07-07 22:55:08,973 - INFO - show standard_conforming_strings
2024-07-07 22:55:08,973 - INFO - [raw sql] ()
2024-07-07 22:55:08,975 - INFO - BEGIN (implicit)
2024-07-07 22:55:08,981 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-07 22:55:08,981 - INFO - [generated in 0.00045s] ()
2024-07-07 22:55:09,128 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-07 22:55:09,128 - INFO - [generated in 0.00029s] ('<561761720169067@mail.yandex.ru>',)
2024-07-07 23:03:40,412 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 23:03:40,414 - INFO - Added job "on_startup" to job store "default"
2024-07-07 23:03:40,414 - INFO - Scheduler started
2024-07-07 23:03:40,415 - INFO - Start polling
2024-07-07 23:03:40,806 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 23:03:52,415 - INFO - Running job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 23:04:04 +07)" (scheduled at 2024-07-07 23:03:52.412176+07:00)
2024-07-07 23:03:54,317 - INFO - select pg_catalog.version()
2024-07-07 23:03:54,317 - INFO - [raw sql] ()
2024-07-07 23:03:54,328 - INFO - select current_schema()
2024-07-07 23:03:54,328 - INFO - [raw sql] ()
2024-07-07 23:03:54,330 - INFO - show standard_conforming_strings
2024-07-07 23:03:54,330 - INFO - [raw sql] ()
2024-07-07 23:03:54,332 - INFO - BEGIN (implicit)
2024-07-07 23:03:54,339 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-07 23:03:54,339 - INFO - [generated in 0.00043s] ()
2024-07-07 23:03:54,493 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-07 23:03:54,493 - INFO - [generated in 0.00026s] ('<561761720169067@mail.yandex.ru>',)
2024-07-07 23:05:22,971 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 23:05:22,972 - INFO - Added job "on_startup" to job store "default"
2024-07-07 23:05:22,972 - INFO - Scheduler started
2024-07-07 23:05:22,972 - INFO - Start polling
2024-07-07 23:05:23,333 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 23:05:27,846 - INFO - Received message from 964635576: /subscribe
2024-07-07 23:05:27,871 - INFO - select pg_catalog.version()
2024-07-07 23:05:27,871 - INFO - [raw sql] ()
2024-07-07 23:05:27,873 - INFO - select current_schema()
2024-07-07 23:05:27,873 - INFO - [raw sql] ()
2024-07-07 23:05:27,874 - INFO - show standard_conforming_strings
2024-07-07 23:05:27,874 - INFO - [raw sql] ()
2024-07-07 23:05:27,875 - INFO - BEGIN (implicit)
2024-07-07 23:05:27,879 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-07 23:05:27,879 - INFO - [generated in 0.00044s] ()
2024-07-07 23:05:28,331 - INFO - ROLLBACK
2024-07-07 23:05:28,332 - INFO - Update id=792257299 is handled. Duration 495 ms by bot id=6235250605
2024-07-07 23:05:31,121 - INFO - Received message from 964635576: Курагинский район
2024-07-07 23:05:31,125 - INFO - BEGIN (implicit)
2024-07-07 23:05:31,127 - INFO - SELECT subscriptions.map_id 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT
2024-07-07 23:05:31,127 - INFO - [generated in 0.00026s] (964635576,)
2024-07-07 23:05:31,375 - INFO - ROLLBACK
2024-07-07 23:05:31,376 - INFO - Update id=792257300 is handled. Duration 255 ms by bot id=6235250605
2024-07-07 23:05:34,978 - INFO - Running job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 23:05:46 +07)" (scheduled at 2024-07-07 23:05:34.971720+07:00)
2024-07-07 23:05:36,403 - WARNING - Received SIGINT signal
2024-07-07 23:05:36,406 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 23:05:36,406 - INFO - Polling stopped
2024-07-07 23:05:36,663 - ERROR - Job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 23:05:46 +07)" raised an exception
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/apscheduler/executors/base_py3.py", line 30, in run_coroutine_job
    retval = await job.func(*job.args, **job.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/bot.py", line 29, in on_startup
    await check_news(Message, session)
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 210, in check_news
    saved_files, subject, content, email_id = await fetch_and_save_files()
                                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/email_checker.py", line 92, in fetch_and_save_files
    await asyncio.to_thread(mail.logout)
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/threads.py", line 25, in to_thread
    return await loop.run_in_executor(None, func_call)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
asyncio.exceptions.CancelledError
2024-07-07 23:05:54,342 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 23:05:54,342 - INFO - Added job "on_startup" to job store "default"
2024-07-07 23:05:54,342 - INFO - Scheduler started
2024-07-07 23:05:54,343 - INFO - Start polling
2024-07-07 23:05:54,672 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 23:06:06,344 - INFO - Running job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 23:06:18 +07)" (scheduled at 2024-07-07 23:06:06.342185+07:00)
2024-07-07 23:06:08,205 - INFO - select pg_catalog.version()
2024-07-07 23:06:08,205 - INFO - [raw sql] ()
2024-07-07 23:06:08,207 - INFO - select current_schema()
2024-07-07 23:06:08,207 - INFO - [raw sql] ()
2024-07-07 23:06:08,208 - INFO - show standard_conforming_strings
2024-07-07 23:06:08,208 - INFO - [raw sql] ()
2024-07-07 23:06:08,208 - INFO - BEGIN (implicit)
2024-07-07 23:06:08,212 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-07 23:06:08,212 - INFO - [generated in 0.00022s] ()
2024-07-07 23:06:08,252 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-07 23:06:08,252 - INFO - [generated in 0.00019s] ('<561761720169067@mail.yandex.ru>',)
2024-07-07 23:06:08,644 - ERROR - Ошибка при отправке пользователю 811983691: Telegram server says - Bad Request: chat not found
2024-07-07 23:06:08,811 - ERROR - Ошибка при отправке пользователю 901904618: Telegram server says - Bad Request: chat not found
2024-07-07 23:06:08,813 - INFO - ROLLBACK
2024-07-07 23:06:08,814 - INFO - Job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 23:06:18 +07)" executed successfully
2024-07-07 23:06:10,354 - INFO - Received message from 964635576: /my_subscriptions
2024-07-07 23:06:10,356 - INFO - BEGIN (implicit)
2024-07-07 23:06:10,356 - INFO - SELECT subscriptions.municipality_name 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT
2024-07-07 23:06:10,357 - INFO - [generated in 0.00016s] (964635576,)
2024-07-07 23:06:10,716 - INFO - ROLLBACK
2024-07-07 23:06:10,718 - INFO - Update id=792257301 is handled. Duration 371 ms by bot id=6235250605
2024-07-07 23:06:17,624 - INFO - Received message from 964635576: /subscribe
2024-07-07 23:06:17,626 - INFO - BEGIN (implicit)
2024-07-07 23:06:17,628 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-07 23:06:17,628 - INFO - [generated in 0.00018s] ()
2024-07-07 23:06:17,800 - INFO - ROLLBACK
2024-07-07 23:06:17,801 - INFO - Update id=792257302 is handled. Duration 178 ms by bot id=6235250605
2024-07-07 23:06:18,343 - INFO - Running job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 23:06:30 +07)" (scheduled at 2024-07-07 23:06:18.342185+07:00)
2024-07-07 23:06:19,530 - INFO - Received message from 964635576: Козульский район
2024-07-07 23:06:19,531 - INFO - BEGIN (implicit)
2024-07-07 23:06:19,532 - INFO - SELECT subscriptions.map_id 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT
2024-07-07 23:06:19,532 - INFO - [generated in 0.00015s] (964635576,)
2024-07-07 23:06:19,693 - INFO - ROLLBACK
2024-07-07 23:06:19,694 - INFO - Update id=792257303 is handled. Duration 164 ms by bot id=6235250605
2024-07-07 23:06:19,962 - INFO - BEGIN (implicit)
2024-07-07 23:06:19,963 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-07 23:06:19,963 - INFO - [cached since 11.75s ago] ()
2024-07-07 23:06:19,976 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-07 23:06:19,976 - INFO - [cached since 11.72s ago] ('<561761720169067@mail.yandex.ru>',)
2024-07-07 23:06:20,114 - ERROR - Ошибка при отправке пользователю 811983691: Telegram server says - Bad Request: chat not found
2024-07-07 23:06:20,254 - ERROR - Ошибка при отправке пользователю 901904618: Telegram server says - Bad Request: chat not found
2024-07-07 23:06:20,256 - INFO - ROLLBACK
2024-07-07 23:06:20,257 - INFO - Job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 23:06:30 +07)" executed successfully
2024-07-07 23:06:20,896 - INFO - Received message from 964635576: /my_subscriptions
2024-07-07 23:06:20,898 - INFO - BEGIN (implicit)
2024-07-07 23:06:20,899 - INFO - SELECT subscriptions.municipality_name 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT
2024-07-07 23:06:20,899 - INFO - [cached since 10.54s ago] (964635576,)
2024-07-07 23:06:21,066 - INFO - ROLLBACK
2024-07-07 23:06:21,067 - INFO - Update id=792257304 is handled. Duration 171 ms by bot id=6235250605
2024-07-07 23:06:30,347 - INFO - Running job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 23:06:42 +07)" (scheduled at 2024-07-07 23:06:30.342185+07:00)
2024-07-07 23:06:31,145 - WARNING - Received SIGINT signal
2024-07-07 23:06:31,146 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 23:06:31,146 - INFO - Polling stopped
2024-07-07 23:06:31,551 - ERROR - Job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 23:06:42 +07)" raised an exception
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/apscheduler/executors/base_py3.py", line 30, in run_coroutine_job
    retval = await job.func(*job.args, **job.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/bot.py", line 29, in on_startup
    await check_news(Message, session)
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 210, in check_news
    saved_files, subject, content, email_id = await fetch_and_save_files()
                                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/email_checker.py", line 38, in fetch_and_save_files
    await asyncio.to_thread(mail.login, EMAIL, PASSWORD)
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/threads.py", line 25, in to_thread
    return await loop.run_in_executor(None, func_call)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
asyncio.exceptions.CancelledError
2024-07-07 23:06:31,828 - ERROR - Unclosed client session
client_session: <aiohttp.client.ClientSession object at 0x14556b8c0>
2024-07-07 23:06:31,828 - ERROR - Unclosed connector
connections: ['[(<aiohttp.client_proto.ResponseHandler object at 0x145547410>, 342267.991869875)]']
connector: <aiohttp.connector.TCPConnector object at 0x144b44dd0>
2024-07-07 23:09:35,298 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 23:09:35,299 - INFO - Added job "on_startup" to job store "default"
2024-07-07 23:09:35,299 - INFO - Scheduler started
2024-07-07 23:09:35,299 - INFO - Start polling
2024-07-07 23:09:35,614 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 23:09:38,440 - INFO - Received message from 964635576: /subscribe
2024-07-07 23:09:38,467 - INFO - select pg_catalog.version()
2024-07-07 23:09:38,468 - INFO - [raw sql] ()
2024-07-07 23:09:38,469 - INFO - select current_schema()
2024-07-07 23:09:38,469 - INFO - [raw sql] ()
2024-07-07 23:09:38,470 - INFO - show standard_conforming_strings
2024-07-07 23:09:38,470 - INFO - [raw sql] ()
2024-07-07 23:09:38,471 - INFO - BEGIN (implicit)
2024-07-07 23:09:38,474 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-07 23:09:38,474 - INFO - [generated in 0.00015s] ()
2024-07-07 23:09:38,900 - INFO - ROLLBACK
2024-07-07 23:09:38,900 - INFO - Update id=792257305 is handled. Duration 463 ms by bot id=6235250605
2024-07-07 23:09:40,073 - INFO - Received message from 964635576: Балахтинский район
2024-07-07 23:09:40,179 - INFO - BEGIN (implicit)
2024-07-07 23:09:40,179 - INFO - SELECT subscriptions.map_id 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT AND subscriptions.municipality_name = $2::VARCHAR
2024-07-07 23:09:40,180 - INFO - [generated in 0.00009s] (964635576, 'Балахтинский район')
2024-07-07 23:09:40,183 - INFO - ROLLBACK
2024-07-07 23:09:40,183 - INFO - Update id=792257306 is not handled. Duration 122 ms by bot id=6235250605
2024-07-07 23:09:40,183 - ERROR - Cause exception while process update id=792257306 by bot id=6235250605
AttributeError: 'Subscriptions' object has no attribute 'on_conflict_do_nothing'
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 49, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/fsm/middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/database/db.py", line 21, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 170, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 162, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/logging_middleware.py", line 8, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 150, in subscribe
    ).on_conflict_do_nothing())
      ^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'Subscriptions' object has no attribute 'on_conflict_do_nothing'
2024-07-07 23:09:47,332 - INFO - Running job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 23:09:59 +07)" (scheduled at 2024-07-07 23:09:47.298168+07:00)
2024-07-07 23:09:48,824 - WARNING - Received SIGINT signal
2024-07-07 23:09:48,827 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 23:09:48,827 - INFO - Polling stopped
2024-07-07 23:09:49,086 - INFO - BEGIN (implicit)
2024-07-07 23:09:49,087 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-07 23:09:49,087 - INFO - [generated in 0.00012s] ()
2024-07-07 23:09:49,118 - ERROR - Job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 23:09:59 +07)" raised an exception
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/apscheduler/executors/base_py3.py", line 30, in run_coroutine_job
    retval = await job.func(*job.args, **job.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/bot.py", line 29, in on_startup
    await check_news(Message, session)
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 257, in check_news
    result = await session.execute(subscribers_query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py", line 461, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2236, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/context.py", line 293, in orm_execute_statement
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1418, in execute
    return meth(
           ^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py", line 515, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1640, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2356, in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 572, in execute
    self._adapt_connection.await_(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 508, in _prepare_and_execute
    await adapt_connection._start_transaction()
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 835, in _start_transaction
    await self._transaction.start()
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/asyncpg/transaction.py", line 146, in start
    await self._connection.execute(query)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/asyncpg/connection.py", line 350, in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "asyncpg/protocol/protocol.pyx", line 374, in query
asyncio.exceptions.CancelledError
2024-07-07 23:12:08,020 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 23:12:08,021 - INFO - Added job "on_startup" to job store "default"
2024-07-07 23:12:08,021 - INFO - Scheduler started
2024-07-07 23:12:08,021 - INFO - Start polling
2024-07-07 23:12:08,385 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 23:12:12,009 - INFO - Received message from 964635576: /subscribe
2024-07-07 23:12:12,026 - INFO - select pg_catalog.version()
2024-07-07 23:12:12,027 - INFO - [raw sql] ()
2024-07-07 23:12:12,028 - INFO - select current_schema()
2024-07-07 23:12:12,028 - INFO - [raw sql] ()
2024-07-07 23:12:12,029 - INFO - show standard_conforming_strings
2024-07-07 23:12:12,030 - INFO - [raw sql] ()
2024-07-07 23:12:12,031 - INFO - BEGIN (implicit)
2024-07-07 23:12:12,034 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-07 23:12:12,034 - INFO - [generated in 0.00021s] ()
2024-07-07 23:12:12,440 - INFO - ROLLBACK
2024-07-07 23:12:12,440 - INFO - Update id=792257307 is handled. Duration 447 ms by bot id=6235250605
2024-07-07 23:12:14,887 - INFO - Received message from 964635576: Манский район
2024-07-07 23:12:14,988 - INFO - BEGIN (implicit)
2024-07-07 23:12:14,989 - INFO - SELECT subscriptions.map_id 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT AND subscriptions.municipality_name = $2::VARCHAR
2024-07-07 23:12:14,989 - INFO - [generated in 0.00009s] (964635576, 'Манский район')
2024-07-07 23:12:14,992 - INFO - ROLLBACK
2024-07-07 23:12:14,993 - INFO - Update id=792257308 is not handled. Duration 107 ms by bot id=6235250605
2024-07-07 23:12:14,993 - ERROR - Cause exception while process update id=792257308 by bot id=6235250605
AttributeError: 'NoneType' object has no attribute 'on_conflict_do_nothing'
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 49, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/fsm/middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/database/db.py", line 21, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 170, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 162, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/logging_middleware.py", line 8, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 151, in subscribe
    )).on_conflict_do_nothing()
       ^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'on_conflict_do_nothing'
2024-07-07 23:12:20,023 - INFO - Running job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 23:12:32 +07)" (scheduled at 2024-07-07 23:12:20.020056+07:00)
2024-07-07 23:12:22,016 - INFO - BEGIN (implicit)
2024-07-07 23:12:22,017 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-07 23:12:22,017 - INFO - [generated in 0.00018s] ()
2024-07-07 23:12:22,042 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-07 23:12:22,042 - INFO - [generated in 0.00019s] ('<561761720169067@mail.yandex.ru>',)
2024-07-07 23:12:22,608 - ERROR - Ошибка при отправке пользователю 811983691: Telegram server says - Bad Request: chat not found
2024-07-07 23:12:22,888 - WARNING - Received SIGINT signal
2024-07-07 23:12:22,889 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 23:12:22,889 - INFO - Polling stopped
2024-07-07 23:12:23,044 - ERROR - Ошибка при отправке пользователю 901904618: Telegram server says - Bad Request: chat not found
2024-07-07 23:12:23,046 - INFO - ROLLBACK
2024-07-07 23:12:23,047 - INFO - Job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 23:12:32 +07)" executed successfully
2024-07-07 23:12:23,287 - ERROR - Unclosed client session
client_session: <aiohttp.client.ClientSession object at 0x11d47bb00>
2024-07-07 23:12:23,287 - ERROR - Unclosed connector
connections: ['[(<aiohttp.client_proto.ResponseHandler object at 0x11d4f2750>, 342630.789101458)]']
connector: <aiohttp.connector.TCPConnector object at 0x11c1529c0>
2024-07-07 23:13:54,221 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 23:13:54,221 - INFO - Added job "on_startup" to job store "default"
2024-07-07 23:13:54,221 - INFO - Scheduler started
2024-07-07 23:13:54,222 - INFO - Start polling
2024-07-07 23:13:54,566 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 23:14:01,905 - INFO - Received message from 964635576: /subscribe
2024-07-07 23:14:01,937 - INFO - select pg_catalog.version()
2024-07-07 23:14:01,937 - INFO - [raw sql] ()
2024-07-07 23:14:01,939 - INFO - select current_schema()
2024-07-07 23:14:01,939 - INFO - [raw sql] ()
2024-07-07 23:14:01,939 - INFO - show standard_conforming_strings
2024-07-07 23:14:01,939 - INFO - [raw sql] ()
2024-07-07 23:14:01,940 - INFO - BEGIN (implicit)
2024-07-07 23:14:01,943 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-07 23:14:01,943 - INFO - [generated in 0.00010s] ()
2024-07-07 23:14:02,486 - INFO - ROLLBACK
2024-07-07 23:14:02,487 - INFO - Update id=792257309 is handled. Duration 586 ms by bot id=6235250605
2024-07-07 23:14:05,171 - INFO - Received message from 964635576: Козульский район
2024-07-07 23:14:05,273 - INFO - BEGIN (implicit)
2024-07-07 23:14:05,274 - INFO - SELECT subscriptions.map_id 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT AND subscriptions.municipality_name = $2::VARCHAR
2024-07-07 23:14:05,274 - INFO - [generated in 0.00009s] (964635576, 'Козульский район')
2024-07-07 23:14:05,280 - INFO - INSERT INTO subscriptions (user_id, map_id, municipality_name, subscribed_at) VALUES ($1::BIGINT, (SELECT municipalities.map_id 
FROM municipalities 
WHERE municipalities.municipality_name = $2::VARCHAR), $3::VARCHAR, $4::TIMESTAMP WITHOUT TIME ZONE) RETURNING subscriptions.id
2024-07-07 23:14:05,280 - INFO - [generated in 0.00016s] (964635576, 'Козульский район', 'Козульский район', datetime.datetime(2024, 7, 7, 23, 14, 5, 279106))
2024-07-07 23:14:05,286 - INFO - ROLLBACK
2024-07-07 23:14:05,287 - INFO - Update id=792257310 is not handled. Duration 117 ms by bot id=6235250605
2024-07-07 23:14:05,287 - ERROR - Cause exception while process update id=792257310 by bot id=6235250605
ProgrammingError: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: column subscriptions.id does not exist
[SQL: INSERT INTO subscriptions (user_id, map_id, municipality_name, subscribed_at) VALUES ($1::BIGINT, (SELECT municipalities.map_id 
FROM municipalities 
WHERE municipalities.municipality_name = $2::VARCHAR), $3::VARCHAR, $4::TIMESTAMP WITHOUT TIME ZONE) RETURNING subscriptions.id]
[parameters: (964635576, 'Козульский район', 'Козульский район', datetime.datetime(2024, 7, 7, 23, 14, 5, 279106))]
(Background on this error at: https://sqlalche.me/e/20/f405)
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 514, in _prepare_and_execute
    prepared_stmt, attributes = await adapt_connection._prepare(
                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 760, in _prepare
    prepared_stmt = await self._connection.prepare(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/asyncpg/connection.py", line 636, in prepare
    return await self._prepare(
           ^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/asyncpg/connection.py", line 654, in _prepare
    stmt = await self._get_statement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/asyncpg/connection.py", line 433, in _get_statement
    statement = await self._protocol.prepare(
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "asyncpg/protocol/protocol.pyx", line 166, in prepare
asyncpg.exceptions.UndefinedColumnError: column subscriptions.id does not exist

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 572, in execute
    self._adapt_connection.await_(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 550, in _prepare_and_execute
    self._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 501, in _handle_exception
    self._adapt_connection._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 784, in _handle_exception
    raise translated_error from error
sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.ProgrammingError: <class 'asyncpg.exceptions.UndefinedColumnError'>: column subscriptions.id does not exist

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 49, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/fsm/middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/database/db.py", line 21, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 170, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 162, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/logging_middleware.py", line 8, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 153, in subscribe
    await session.commit()
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py", line 1009, in commit
    await greenlet_spawn(self.sync_session.commit)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2017, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 1302, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 1277, in _prepare_impl
    self.session.flush()
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4341, in flush
    self._flush(objects)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4476, in _flush
    with util.safe_reraise():
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py", line 146, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4437, in _flush
    flush_context.execute()
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 1227, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1418, in execute
    return meth(
           ^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py", line 515, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1640, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2353, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 572, in execute
    self._adapt_connection.await_(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 550, in _prepare_and_execute
    self._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 501, in _handle_exception
    self._adapt_connection._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 784, in _handle_exception
    raise translated_error from error
sqlalchemy.exc.ProgrammingError: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: column subscriptions.id does not exist
[SQL: INSERT INTO subscriptions (user_id, map_id, municipality_name, subscribed_at) VALUES ($1::BIGINT, (SELECT municipalities.map_id 
FROM municipalities 
WHERE municipalities.municipality_name = $2::VARCHAR), $3::VARCHAR, $4::TIMESTAMP WITHOUT TIME ZONE) RETURNING subscriptions.id]
[parameters: (964635576, 'Козульский район', 'Козульский район', datetime.datetime(2024, 7, 7, 23, 14, 5, 279106))]
(Background on this error at: https://sqlalche.me/e/20/f405)
2024-07-07 23:14:06,222 - INFO - Running job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 23:14:18 +07)" (scheduled at 2024-07-07 23:14:06.221018+07:00)
2024-07-07 23:14:07,776 - INFO - BEGIN (implicit)
2024-07-07 23:14:07,778 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-07 23:14:07,779 - INFO - [generated in 0.00038s] ()
2024-07-07 23:14:07,800 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-07 23:14:07,801 - INFO - [generated in 0.00024s] ('<561761720169067@mail.yandex.ru>',)
2024-07-07 23:14:08,490 - ERROR - Ошибка при отправке пользователю 811983691: Telegram server says - Bad Request: chat not found
2024-07-07 23:14:08,824 - ERROR - Ошибка при отправке пользователю 901904618: Telegram server says - Bad Request: chat not found
2024-07-07 23:14:08,827 - INFO - ROLLBACK
2024-07-07 23:14:08,828 - INFO - Job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 23:14:18 +07)" executed successfully
2024-07-07 23:14:12,739 - WARNING - Received SIGINT signal
2024-07-07 23:14:12,743 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 23:14:12,743 - INFO - Polling stopped
2024-07-07 23:14:13,170 - ERROR - Unclosed client session
client_session: <aiohttp.client.ClientSession object at 0x11bbaaab0>
2024-07-07 23:14:13,170 - ERROR - Unclosed connector
connections: ['[(<aiohttp.client_proto.ResponseHandler object at 0x11bbf8890>, 342736.571626375)]']
connector: <aiohttp.connector.TCPConnector object at 0x11bbaab70>
2024-07-07 23:18:28,566 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 23:18:28,568 - INFO - Added job "on_startup" to job store "default"
2024-07-07 23:18:28,568 - INFO - Scheduler started
2024-07-07 23:18:28,569 - INFO - Start polling
2024-07-07 23:18:28,934 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 23:18:40,568 - INFO - Running job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 23:18:52 +07)" (scheduled at 2024-07-07 23:18:40.566349+07:00)
2024-07-07 23:18:42,577 - INFO - select pg_catalog.version()
2024-07-07 23:18:42,577 - INFO - [raw sql] ()
2024-07-07 23:18:42,585 - INFO - select current_schema()
2024-07-07 23:18:42,585 - INFO - [raw sql] ()
2024-07-07 23:18:42,586 - INFO - show standard_conforming_strings
2024-07-07 23:18:42,586 - INFO - [raw sql] ()
2024-07-07 23:18:42,588 - INFO - BEGIN (implicit)
2024-07-07 23:18:42,595 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-07 23:18:42,595 - INFO - [generated in 0.00047s] ()
2024-07-07 23:18:42,748 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-07 23:18:42,748 - INFO - [generated in 0.00029s] ('<561761720169067@mail.yandex.ru>',)
2024-07-07 23:18:55,355 - ERROR - Ошибка при отправке пользователю 811983691: Telegram server says - Bad Request: chat not found
2024-07-07 23:19:17,693 - WARNING - Execution of job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 23:18:52 +07)" skipped: maximum number of running instances reached (1)
2024-07-07 23:19:24,076 - ERROR - Ошибка при отправке пользователю 901904618: Telegram server says - Bad Request: chat not found
2024-07-07 23:19:28,839 - INFO - ROLLBACK
2024-07-07 23:19:28,859 - WARNING - Execution of job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 23:19:28 +07)" skipped: maximum number of running instances reached (1)
2024-07-07 23:19:28,861 - INFO - Job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 23:19:40 +07)" executed successfully
2024-07-07 23:19:36,721 - INFO - Received message from 964635576: /subscribe
2024-07-07 23:19:36,725 - INFO - BEGIN (implicit)
2024-07-07 23:19:36,728 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-07 23:19:36,728 - INFO - [generated in 0.00050s] ()
2024-07-07 23:19:37,445 - INFO - ROLLBACK
2024-07-07 23:19:37,447 - INFO - Update id=792257311 is handled. Duration 738 ms by bot id=6235250605
2024-07-07 23:19:39,797 - INFO - Received message from 964635576: Минусинский район
2024-07-07 23:19:39,820 - INFO - BEGIN (implicit)
2024-07-07 23:19:39,821 - INFO - SELECT subscriptions.map_id 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT AND subscriptions.municipality_name = $2::VARCHAR
2024-07-07 23:19:39,822 - INFO - [generated in 0.00040s] (964635576, 'Минусинский район')
2024-07-07 23:19:39,836 - INFO - INSERT INTO subscriptions (user_id, map_id, municipality_name, subscribed_at) VALUES ($1::BIGINT, (SELECT municipalities.map_id 
FROM municipalities 
WHERE municipalities.municipality_name = $2::VARCHAR), $3::VARCHAR, $4::TIMESTAMP WITHOUT TIME ZONE) RETURNING subscriptions.id
2024-07-07 23:19:39,837 - INFO - [generated in 0.00046s] (964635576, 'Минусинский район', 'Минусинский район', datetime.datetime(2024, 7, 7, 23, 19, 39, 829354))
2024-07-07 23:19:39,854 - INFO - ROLLBACK
2024-07-07 23:26:05,966 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 23:26:05,967 - INFO - Added job "on_startup" to job store "default"
2024-07-07 23:26:05,967 - INFO - Scheduler started
2024-07-07 23:26:05,967 - INFO - Start polling
2024-07-07 23:26:06,322 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 23:26:10,870 - INFO - Received message from 964635576: /subscribe
2024-07-07 23:26:10,915 - INFO - select pg_catalog.version()
2024-07-07 23:26:10,915 - INFO - [raw sql] ()
2024-07-07 23:26:10,917 - INFO - select current_schema()
2024-07-07 23:26:10,917 - INFO - [raw sql] ()
2024-07-07 23:26:10,919 - INFO - show standard_conforming_strings
2024-07-07 23:26:10,919 - INFO - [raw sql] ()
2024-07-07 23:26:10,920 - INFO - BEGIN (implicit)
2024-07-07 23:26:10,923 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-07 23:26:10,923 - INFO - [generated in 0.00019s] ()
2024-07-07 23:26:11,317 - INFO - ROLLBACK
2024-07-07 23:26:11,318 - INFO - Update id=792257313 is handled. Duration 469 ms by bot id=6235250605
2024-07-07 23:26:13,604 - INFO - Received message from 964635576: город Бородино
2024-07-07 23:26:13,737 - INFO - BEGIN (implicit)
2024-07-07 23:26:13,738 - INFO - SELECT subscriptions.map_id 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT AND subscriptions.municipality_name = $2::VARCHAR
2024-07-07 23:26:13,738 - INFO - [generated in 0.00009s] (964635576, 'город Бородино')
2024-07-07 23:26:13,744 - INFO - INSERT INTO subscriptions (user_id, map_id, municipality_name, subscribed_at) VALUES ($1::BIGINT, (SELECT municipalities.map_id 
FROM municipalities 
WHERE municipalities.municipality_name = $2::VARCHAR), $3::VARCHAR, $4::TIMESTAMP WITHOUT TIME ZONE) RETURNING subscriptions.id
2024-07-07 23:26:13,744 - INFO - [generated in 0.00017s] (964635576, 'город Бородино', 'город Бородино', datetime.datetime(2024, 7, 7, 23, 26, 13, 742393))
2024-07-07 23:26:13,765 - INFO - ROLLBACK
2024-07-07 23:26:13,766 - INFO - Update id=792257314 is not handled. Duration 162 ms by bot id=6235250605
2024-07-07 23:26:13,766 - ERROR - Cause exception while process update id=792257314 by bot id=6235250605
ProgrammingError: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: column subscriptions.id does not exist
[SQL: INSERT INTO subscriptions (user_id, map_id, municipality_name, subscribed_at) VALUES ($1::BIGINT, (SELECT municipalities.map_id 
FROM municipalities 
WHERE municipalities.municipality_name = $2::VARCHAR), $3::VARCHAR, $4::TIMESTAMP WITHOUT TIME ZONE) RETURNING subscriptions.id]
[parameters: (964635576, 'город Бородино', 'город Бородино', datetime.datetime(2024, 7, 7, 23, 26, 13, 742393))]
(Background on this error at: https://sqlalche.me/e/20/f405)
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 514, in _prepare_and_execute
    prepared_stmt, attributes = await adapt_connection._prepare(
                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 760, in _prepare
    prepared_stmt = await self._connection.prepare(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/asyncpg/connection.py", line 636, in prepare
    return await self._prepare(
           ^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/asyncpg/connection.py", line 654, in _prepare
    stmt = await self._get_statement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/asyncpg/connection.py", line 433, in _get_statement
    statement = await self._protocol.prepare(
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "asyncpg/protocol/protocol.pyx", line 166, in prepare
asyncpg.exceptions.UndefinedColumnError: column subscriptions.id does not exist

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 572, in execute
    self._adapt_connection.await_(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 550, in _prepare_and_execute
    self._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 501, in _handle_exception
    self._adapt_connection._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 784, in _handle_exception
    raise translated_error from error
sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.ProgrammingError: <class 'asyncpg.exceptions.UndefinedColumnError'>: column subscriptions.id does not exist

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 49, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/fsm/middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/database/db.py", line 21, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 170, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 162, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/logging_middleware.py", line 8, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 153, in subscribe
    await session.commit()
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py", line 1009, in commit
    await greenlet_spawn(self.sync_session.commit)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2017, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 1302, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 1277, in _prepare_impl
    self.session.flush()
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4341, in flush
    self._flush(objects)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4476, in _flush
    with util.safe_reraise():
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py", line 146, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4437, in _flush
    flush_context.execute()
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 1227, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1418, in execute
    return meth(
           ^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py", line 515, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1640, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2353, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 572, in execute
    self._adapt_connection.await_(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 550, in _prepare_and_execute
    self._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 501, in _handle_exception
    self._adapt_connection._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 784, in _handle_exception
    raise translated_error from error
sqlalchemy.exc.ProgrammingError: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: column subscriptions.id does not exist
[SQL: INSERT INTO subscriptions (user_id, map_id, municipality_name, subscribed_at) VALUES ($1::BIGINT, (SELECT municipalities.map_id 
FROM municipalities 
WHERE municipalities.municipality_name = $2::VARCHAR), $3::VARCHAR, $4::TIMESTAMP WITHOUT TIME ZONE) RETURNING subscriptions.id]
[parameters: (964635576, 'город Бородино', 'город Бородино', datetime.datetime(2024, 7, 7, 23, 26, 13, 742393))]
(Background on this error at: https://sqlalche.me/e/20/f405)
2024-07-07 23:26:17,972 - INFO - Running job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 23:26:29 +07)" (scheduled at 2024-07-07 23:26:17.966511+07:00)
2024-07-07 23:26:19,717 - INFO - BEGIN (implicit)
2024-07-07 23:26:19,719 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-07 23:26:19,719 - INFO - [generated in 0.00022s] ()
2024-07-07 23:26:19,750 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-07 23:26:19,750 - INFO - [generated in 0.00016s] ('<561761720169067@mail.yandex.ru>',)
2024-07-07 23:26:20,107 - ERROR - Ошибка при отправке пользователю 811983691: Telegram server says - Bad Request: chat not found
2024-07-07 23:26:20,235 - ERROR - Ошибка при отправке пользователю 901904618: Telegram server says - Bad Request: chat not found
2024-07-07 23:26:20,236 - INFO - ROLLBACK
2024-07-07 23:26:20,237 - INFO - Job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 23:26:29 +07)" executed successfully
2024-07-07 23:26:26,571 - WARNING - Received SIGINT signal
2024-07-07 23:26:26,574 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 23:26:26,574 - INFO - Polling stopped
2024-07-07 23:26:27,011 - ERROR - Unclosed client session
client_session: <aiohttp.client.ClientSession object at 0x12b4a6120>
2024-07-07 23:26:27,011 - ERROR - Unclosed connector
connections: ['[(<aiohttp.client_proto.ResponseHandler object at 0x12b4f4770>, 343468.020689291)]']
connector: <aiohttp.connector.TCPConnector object at 0x12b4a5dc0>
2024-07-07 23:30:00,855 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 23:30:00,856 - INFO - Added job "on_startup" to job store "default"
2024-07-07 23:30:00,856 - INFO - Scheduler started
2024-07-07 23:30:00,856 - INFO - Start polling
2024-07-07 23:30:01,234 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 23:30:06,474 - INFO - Received message from 964635576: /subscribe
2024-07-07 23:30:06,513 - INFO - select pg_catalog.version()
2024-07-07 23:30:06,513 - INFO - [raw sql] ()
2024-07-07 23:30:06,515 - INFO - select current_schema()
2024-07-07 23:30:06,515 - INFO - [raw sql] ()
2024-07-07 23:30:06,518 - INFO - show standard_conforming_strings
2024-07-07 23:30:06,518 - INFO - [raw sql] ()
2024-07-07 23:30:06,519 - INFO - BEGIN (implicit)
2024-07-07 23:30:06,523 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-07 23:30:06,523 - INFO - [generated in 0.00018s] ()
2024-07-07 23:30:07,024 - INFO - ROLLBACK
2024-07-07 23:30:07,025 - INFO - Update id=792257315 is handled. Duration 559 ms by bot id=6235250605
2024-07-07 23:30:09,220 - INFO - Received message from 964635576: Тасеевский район
2024-07-07 23:30:09,339 - INFO - BEGIN (implicit)
2024-07-07 23:30:09,340 - INFO - SELECT subscriptions.map_id 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT AND subscriptions.municipality_name = $2::VARCHAR
2024-07-07 23:30:09,340 - INFO - [generated in 0.00009s] (964635576, 'Тасеевский район')
2024-07-07 23:30:09,346 - INFO - INSERT INTO subscriptions (user_id, map_id, municipality_name, subscribed_at) VALUES ($1::BIGINT, (SELECT municipalities.map_id 
FROM municipalities 
WHERE municipalities.municipality_name = $2::VARCHAR), $3::VARCHAR, $4::TIMESTAMP WITHOUT TIME ZONE) RETURNING subscriptions.id
2024-07-07 23:30:09,346 - INFO - [generated in 0.00012s] (964635576, 'Тасеевский район', 'Тасеевский район', datetime.datetime(2024, 7, 7, 23, 30, 9, 344938))
2024-07-07 23:30:09,351 - INFO - COMMIT
2024-07-07 23:30:09,353 - INFO - BEGIN (implicit)
2024-07-07 23:30:09,354 - INFO - SELECT subscriptions.municipality_name 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT
2024-07-07 23:30:09,354 - INFO - [generated in 0.00007s] (964635576,)
2024-07-07 23:30:09,606 - INFO - ROLLBACK
2024-07-07 23:30:09,606 - INFO - Update id=792257316 is handled. Duration 387 ms by bot id=6235250605
2024-07-07 23:30:12,862 - INFO - Running job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 23:30:24 +07)" (scheduled at 2024-07-07 23:30:12.855737+07:00)
2024-07-07 23:30:14,575 - INFO - BEGIN (implicit)
2024-07-07 23:30:14,577 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-07 23:30:14,577 - INFO - [generated in 0.00032s] ()
2024-07-07 23:30:14,613 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-07 23:30:14,613 - INFO - [generated in 0.00020s] ('<561761720169067@mail.yandex.ru>',)
2024-07-07 23:30:14,998 - ERROR - Ошибка при отправке пользователю 811983691: Telegram server says - Bad Request: chat not found
2024-07-07 23:30:15,189 - ERROR - Ошибка при отправке пользователю 901904618: Telegram server says - Bad Request: chat not found
2024-07-07 23:30:15,190 - INFO - ROLLBACK
2024-07-07 23:30:15,190 - INFO - Job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 23:30:24 +07)" executed successfully
2024-07-07 23:30:19,438 - INFO - Received message from 964635576: /subscribe
2024-07-07 23:30:19,439 - INFO - BEGIN (implicit)
2024-07-07 23:30:19,440 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-07 23:30:19,440 - INFO - [cached since 12.92s ago] ()
2024-07-07 23:30:19,751 - INFO - ROLLBACK
2024-07-07 23:30:19,752 - INFO - Update id=792257317 is handled. Duration 315 ms by bot id=6235250605
2024-07-07 23:30:21,250 - INFO - Received message from 964635576: Ирбейский район
2024-07-07 23:30:21,255 - INFO - BEGIN (implicit)
2024-07-07 23:30:21,256 - INFO - SELECT subscriptions.map_id 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT AND subscriptions.municipality_name = $2::VARCHAR
2024-07-07 23:30:21,256 - INFO - [cached since 11.92s ago] (964635576, 'Ирбейский район')
2024-07-07 23:30:21,258 - INFO - INSERT INTO subscriptions (user_id, map_id, municipality_name, subscribed_at) VALUES ($1::BIGINT, (SELECT municipalities.map_id 
FROM municipalities 
WHERE municipalities.municipality_name = $2::VARCHAR), $3::VARCHAR, $4::TIMESTAMP WITHOUT TIME ZONE) RETURNING subscriptions.id
2024-07-07 23:30:21,258 - INFO - [cached since 11.91s ago] (964635576, 'Ирбейский район', 'Ирбейский район', datetime.datetime(2024, 7, 7, 23, 30, 21, 257743))
2024-07-07 23:30:21,271 - INFO - COMMIT
2024-07-07 23:30:21,272 - INFO - BEGIN (implicit)
2024-07-07 23:30:21,272 - INFO - SELECT subscriptions.municipality_name 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT
2024-07-07 23:30:21,272 - INFO - [cached since 11.92s ago] (964635576,)
2024-07-07 23:30:21,428 - INFO - ROLLBACK
2024-07-07 23:30:21,429 - INFO - Update id=792257318 is handled. Duration 180 ms by bot id=6235250605
2024-07-07 23:30:23,222 - INFO - Received message from 964635576: /subscribe
2024-07-07 23:30:23,222 - INFO - BEGIN (implicit)
2024-07-07 23:30:23,223 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-07 23:30:23,223 - INFO - [cached since 16.7s ago] ()
2024-07-07 23:30:23,403 - INFO - ROLLBACK
2024-07-07 23:30:23,404 - INFO - Update id=792257319 is handled. Duration 183 ms by bot id=6235250605
2024-07-07 23:30:24,857 - INFO - Running job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 23:30:36 +07)" (scheduled at 2024-07-07 23:30:24.855737+07:00)
2024-07-07 23:30:25,241 - INFO - Received message from 964635576: Кежемский район
2024-07-07 23:30:25,245 - INFO - BEGIN (implicit)
2024-07-07 23:30:25,245 - INFO - SELECT subscriptions.map_id 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT AND subscriptions.municipality_name = $2::VARCHAR
2024-07-07 23:30:25,245 - INFO - [cached since 15.91s ago] (964635576, 'Кежемский район')
2024-07-07 23:30:25,247 - INFO - INSERT INTO subscriptions (user_id, map_id, municipality_name, subscribed_at) VALUES ($1::BIGINT, (SELECT municipalities.map_id 
FROM municipalities 
WHERE municipalities.municipality_name = $2::VARCHAR), $3::VARCHAR, $4::TIMESTAMP WITHOUT TIME ZONE) RETURNING subscriptions.id
2024-07-07 23:30:25,247 - INFO - [cached since 15.9s ago] (964635576, 'Кежемский район', 'Кежемский район', datetime.datetime(2024, 7, 7, 23, 30, 25, 247481))
2024-07-07 23:30:25,248 - INFO - COMMIT
2024-07-07 23:30:25,249 - INFO - BEGIN (implicit)
2024-07-07 23:30:25,249 - INFO - SELECT subscriptions.municipality_name 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT
2024-07-07 23:30:25,249 - INFO - [cached since 15.9s ago] (964635576,)
2024-07-07 23:30:25,433 - INFO - ROLLBACK
2024-07-07 23:30:25,434 - INFO - Update id=792257320 is handled. Duration 193 ms by bot id=6235250605
2024-07-07 23:30:26,764 - INFO - BEGIN (implicit)
2024-07-07 23:30:26,765 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-07 23:30:26,765 - INFO - [cached since 12.19s ago] ()
2024-07-07 23:30:26,774 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-07 23:30:26,774 - INFO - [cached since 12.16s ago] ('<561761720169067@mail.yandex.ru>',)
2024-07-07 23:30:27,024 - ERROR - Ошибка при отправке пользователю 811983691: Telegram server says - Bad Request: chat not found
2024-07-07 23:30:27,179 - ERROR - Ошибка при отправке пользователю 901904618: Telegram server says - Bad Request: chat not found
2024-07-07 23:30:27,181 - INFO - ROLLBACK
2024-07-07 23:30:27,182 - INFO - Job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 23:30:36 +07)" executed successfully
2024-07-07 23:30:36,856 - INFO - Running job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 23:30:48 +07)" (scheduled at 2024-07-07 23:30:36.855737+07:00)
2024-07-07 23:30:38,836 - INFO - BEGIN (implicit)
2024-07-07 23:30:38,837 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-07 23:30:38,837 - INFO - [cached since 24.26s ago] ()
2024-07-07 23:30:38,851 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-07 23:30:38,851 - INFO - [cached since 24.24s ago] ('<561761720169067@mail.yandex.ru>',)
2024-07-07 23:30:39,032 - ERROR - Ошибка при отправке пользователю 811983691: Telegram server says - Bad Request: chat not found
2024-07-07 23:30:39,165 - ERROR - Ошибка при отправке пользователю 901904618: Telegram server says - Bad Request: chat not found
2024-07-07 23:30:39,167 - INFO - ROLLBACK
2024-07-07 23:30:39,168 - INFO - Job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 23:30:48 +07)" executed successfully
2024-07-07 23:30:45,838 - INFO - Received message from 964635576: /cancel_subscriptions
2024-07-07 23:30:45,851 - INFO - Update id=792257321 is not handled. Duration 16 ms by bot id=6235250605
2024-07-07 23:30:45,851 - ERROR - Cause exception while process update id=792257321 by bot id=6235250605
AttributeError: 'coroutine' object has no attribute 'where'
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 49, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/fsm/middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/database/db.py", line 21, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 170, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 162, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/logging_middleware.py", line 8, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 205, in handle_waiting_for_choise
    session.delete(Subscriptions).where(Subscriptions.user_id==user_id)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'coroutine' object has no attribute 'where'
2024-07-07 23:30:48,858 - INFO - Running job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 23:31:00 +07)" (scheduled at 2024-07-07 23:30:48.855737+07:00)
2024-07-07 23:30:50,453 - INFO - BEGIN (implicit)
2024-07-07 23:30:50,454 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-07 23:30:50,454 - INFO - [cached since 35.88s ago] ()
2024-07-07 23:30:50,483 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-07 23:30:50,483 - INFO - [cached since 35.87s ago] ('<561761720169067@mail.yandex.ru>',)
2024-07-07 23:30:50,618 - ERROR - Ошибка при отправке пользователю 811983691: Telegram server says - Bad Request: chat not found
2024-07-07 23:30:50,748 - ERROR - Ошибка при отправке пользователю 901904618: Telegram server says - Bad Request: chat not found
2024-07-07 23:30:50,749 - INFO - ROLLBACK
2024-07-07 23:30:50,750 - INFO - Job "on_startup (trigger: interval[0:00:12], next run at: 2024-07-07 23:31:00 +07)" executed successfully
2024-07-07 23:30:54,682 - WARNING - Received SIGINT signal
2024-07-07 23:30:54,684 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 23:30:54,684 - INFO - Polling stopped
2024-07-07 23:30:55,093 - ERROR - Unclosed client session
client_session: <aiohttp.client.ClientSession object at 0x1589d94c0>
2024-07-07 23:30:55,093 - ERROR - Unclosed connector
connections: ['[(<aiohttp.client_proto.ResponseHandler object at 0x1589f04d0>, 343738.539306708)]']
connector: <aiohttp.connector.TCPConnector object at 0x1589d9580>
2024-07-07 23:34:59,098 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 23:34:59,098 - INFO - Added job "on_startup" to job store "default"
2024-07-07 23:34:59,098 - INFO - Scheduler started
2024-07-07 23:34:59,099 - INFO - Start polling
2024-07-07 23:34:59,445 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 23:35:10,090 - INFO - Received message from 964635576: /subscribe
2024-07-07 23:35:10,172 - INFO - select pg_catalog.version()
2024-07-07 23:35:10,172 - INFO - [raw sql] ()
2024-07-07 23:35:10,176 - INFO - select current_schema()
2024-07-07 23:35:10,176 - INFO - [raw sql] ()
2024-07-07 23:35:10,178 - INFO - show standard_conforming_strings
2024-07-07 23:35:10,178 - INFO - [raw sql] ()
2024-07-07 23:35:10,180 - INFO - BEGIN (implicit)
2024-07-07 23:35:10,183 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-07 23:35:10,183 - INFO - [generated in 0.00013s] ()
2024-07-07 23:35:10,594 - INFO - ROLLBACK
2024-07-07 23:35:10,595 - INFO - Update id=792257322 is handled. Duration 515 ms by bot id=6235250605
2024-07-07 23:35:13,844 - INFO - Received message from 964635576: Абанский район
2024-07-07 23:35:13,961 - INFO - BEGIN (implicit)
2024-07-07 23:35:13,962 - INFO - SELECT subscriptions.map_id 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT AND subscriptions.municipality_name = $2::VARCHAR
2024-07-07 23:35:13,962 - INFO - [generated in 0.00010s] (964635576, 'Абанский район')
2024-07-07 23:35:13,968 - INFO - INSERT INTO subscriptions (user_id, map_id, municipality_name, subscribed_at) VALUES ($1::BIGINT, (SELECT municipalities.map_id 
FROM municipalities 
WHERE municipalities.municipality_name = $2::VARCHAR), $3::VARCHAR, $4::TIMESTAMP WITHOUT TIME ZONE) RETURNING subscriptions.id
2024-07-07 23:35:13,969 - INFO - [generated in 0.00015s] (964635576, 'Абанский район', 'Абанский район', datetime.datetime(2024, 7, 7, 23, 35, 13, 967401))
2024-07-07 23:35:13,986 - INFO - COMMIT
2024-07-07 23:35:13,988 - INFO - BEGIN (implicit)
2024-07-07 23:35:13,988 - INFO - SELECT subscriptions.municipality_name 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT
2024-07-07 23:35:13,988 - INFO - [generated in 0.00008s] (964635576,)
2024-07-07 23:35:14,208 - INFO - ROLLBACK
2024-07-07 23:35:14,209 - INFO - Update id=792257323 is handled. Duration 365 ms by bot id=6235250605
2024-07-07 23:35:15,871 - INFO - Received message from 964635576: /cancel_subscriptions
2024-07-07 23:35:15,873 - INFO - Update id=792257324 is not handled. Duration 3 ms by bot id=6235250605
2024-07-07 23:35:15,873 - ERROR - Cause exception while process update id=792257324 by bot id=6235250605
AttributeError: 'coroutine' object has no attribute 'where'
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 49, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/fsm/middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/database/db.py", line 21, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 170, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 162, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/logging_middleware.py", line 8, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 205, in handle_waiting_for_choise
    delete_subs = session.delete(Subscriptions).where(Subscriptions.user_id==user_id)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'coroutine' object has no attribute 'where'
2024-07-07 23:35:20,855 - WARNING - Received SIGINT signal
2024-07-07 23:35:20,862 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 23:35:20,862 - INFO - Polling stopped
2024-07-07 23:38:38,046 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 23:38:38,047 - INFO - Added job "on_startup" to job store "default"
2024-07-07 23:38:38,047 - INFO - Scheduler started
2024-07-07 23:38:38,047 - INFO - Start polling
2024-07-07 23:38:38,393 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 23:38:41,548 - INFO - Received message from 964635576: /cancel_subscriptions
2024-07-07 23:38:41,550 - INFO - Update id=792257325 is not handled. Duration 7 ms by bot id=6235250605
2024-07-07 23:38:41,550 - ERROR - Cause exception while process update id=792257325 by bot id=6235250605
AttributeError: 'coroutine' object has no attribute 'where'
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 49, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/fsm/middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/database/db.py", line 21, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 170, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 162, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/logging_middleware.py", line 8, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 205, in handle_waiting_for_choise
    delete_subs = session.delete(Subscriptions).where(Subscriptions.user_id==user_id)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'coroutine' object has no attribute 'where'
2024-07-07 23:38:45,408 - WARNING - Received SIGINT signal
2024-07-07 23:38:45,410 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 23:38:45,410 - INFO - Polling stopped
2024-07-07 23:39:45,116 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 23:39:45,116 - INFO - Added job "on_startup" to job store "default"
2024-07-07 23:39:45,117 - INFO - Scheduler started
2024-07-07 23:39:45,117 - INFO - Start polling
2024-07-07 23:39:45,463 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 23:39:49,780 - INFO - Received message from 964635576: /cancel_subscriptions
2024-07-07 23:39:49,821 - INFO - select pg_catalog.version()
2024-07-07 23:39:49,821 - INFO - [raw sql] ()
2024-07-07 23:39:49,827 - INFO - select current_schema()
2024-07-07 23:39:49,827 - INFO - [raw sql] ()
2024-07-07 23:39:49,841 - INFO - show standard_conforming_strings
2024-07-07 23:39:49,841 - INFO - [raw sql] ()
2024-07-07 23:39:49,842 - INFO - BEGIN (implicit)
2024-07-07 23:39:49,843 - INFO - DELETE FROM subscriptions WHERE subscriptions.user_id = $1::BIGINT
2024-07-07 23:39:49,843 - INFO - [generated in 0.00016s] (964635576,)
2024-07-07 23:39:49,847 - INFO - COMMIT
2024-07-07 23:39:50,226 - INFO - Update id=792257326 is handled. Duration 457 ms by bot id=6235250605
2024-07-07 23:40:17,678 - INFO - Received message from 964635576: /my_subscriptions
2024-07-07 23:40:17,682 - INFO - BEGIN (implicit)
2024-07-07 23:40:17,685 - INFO - SELECT subscriptions.municipality_name 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT
2024-07-07 23:40:17,685 - INFO - [generated in 0.00027s] (964635576,)
2024-07-07 23:40:18,083 - INFO - ROLLBACK
2024-07-07 23:40:18,084 - INFO - Update id=792257327 is handled. Duration 412 ms by bot id=6235250605
2024-07-07 23:40:20,855 - INFO - Received message from 964635576: /subscribe
2024-07-07 23:40:20,856 - INFO - BEGIN (implicit)
2024-07-07 23:40:20,858 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-07 23:40:20,858 - INFO - [generated in 0.00044s] ()
2024-07-07 23:40:21,109 - INFO - ROLLBACK
2024-07-07 23:40:21,113 - INFO - Update id=792257328 is handled. Duration 258 ms by bot id=6235250605
2024-07-07 23:40:23,741 - INFO - Received message from 964635576: Краснотуранский район
2024-07-07 23:40:23,855 - INFO - BEGIN (implicit)
2024-07-07 23:40:23,856 - INFO - SELECT subscriptions.map_id 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT AND subscriptions.municipality_name = $2::VARCHAR
2024-07-07 23:40:23,856 - INFO - [generated in 0.00008s] (964635576, 'Краснотуранский район')
2024-07-07 23:40:23,860 - INFO - INSERT INTO subscriptions (user_id, map_id, municipality_name, subscribed_at) VALUES ($1::BIGINT, (SELECT municipalities.map_id 
FROM municipalities 
WHERE municipalities.municipality_name = $2::VARCHAR), $3::VARCHAR, $4::TIMESTAMP WITHOUT TIME ZONE) RETURNING subscriptions.id
2024-07-07 23:40:23,860 - INFO - [generated in 0.00009s] (964635576, 'Краснотуранский район', 'Краснотуранский район', datetime.datetime(2024, 7, 7, 23, 40, 23, 859309))
2024-07-07 23:40:23,868 - INFO - COMMIT
2024-07-07 23:40:23,868 - INFO - BEGIN (implicit)
2024-07-07 23:40:23,869 - INFO - SELECT subscriptions.municipality_name 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT
2024-07-07 23:40:23,869 - INFO - [cached since 6.184s ago] (964635576,)
2024-07-07 23:40:24,020 - INFO - ROLLBACK
2024-07-07 23:40:24,020 - INFO - Update id=792257329 is handled. Duration 280 ms by bot id=6235250605
2024-07-07 23:40:26,027 - INFO - Received message from 964635576: /subscribe
2024-07-07 23:40:26,028 - INFO - BEGIN (implicit)
2024-07-07 23:40:26,028 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-07 23:40:26,028 - INFO - [cached since 5.171s ago] ()
2024-07-07 23:40:27,163 - INFO - ROLLBACK
2024-07-07 23:40:27,164 - INFO - Update id=792257330 is handled. Duration 1137 ms by bot id=6235250605
2024-07-07 23:40:32,805 - INFO - Received message from 964635576: /start
2024-07-07 23:40:32,807 - INFO - Update id=792257331 is not handled. Duration 3 ms by bot id=6235250605
2024-07-07 23:40:32,807 - ERROR - Cause exception while process update id=792257331 by bot id=6235250605
AttributeError: 'NoneType' object has no attribute 'on_conflict_do_nothing'
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 49, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/fsm/middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/database/db.py", line 21, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 170, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 162, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/logging_middleware.py", line 8, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 59, in handle_start
    ).on_conflict_do_nothing(index_elements=['user_id'])
      ^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'on_conflict_do_nothing'
2024-07-07 23:40:45,118 - INFO - Running job "on_startup (trigger: interval[0:01:00], next run at: 2024-07-07 23:41:45 +07)" (scheduled at 2024-07-07 23:40:45.116224+07:00)
2024-07-07 23:40:46,742 - INFO - BEGIN (implicit)
2024-07-07 23:40:46,744 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-07 23:40:46,744 - INFO - [generated in 0.00024s] ()
2024-07-07 23:40:46,770 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-07 23:40:46,771 - INFO - [generated in 0.00017s] ('<561761720169067@mail.yandex.ru>',)
2024-07-07 23:40:47,229 - ERROR - Ошибка при отправке пользователю 811983691: Telegram server says - Bad Request: chat not found
2024-07-07 23:40:47,437 - ERROR - Ошибка при отправке пользователю 901904618: Telegram server says - Bad Request: chat not found
2024-07-07 23:40:47,438 - INFO - ROLLBACK
2024-07-07 23:40:47,443 - INFO - Job "on_startup (trigger: interval[0:01:00], next run at: 2024-07-07 23:41:45 +07)" executed successfully
2024-07-07 23:41:15,155 - WARNING - Received SIGINT signal
2024-07-07 23:41:15,157 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 23:41:15,157 - INFO - Polling stopped
2024-07-07 23:41:15,593 - ERROR - Unclosed client session
client_session: <aiohttp.client.ClientSession object at 0x120061d30>
2024-07-07 23:41:24,289 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-07 23:41:24,289 - INFO - Added job "on_startup" to job store "default"
2024-07-07 23:41:24,289 - INFO - Scheduler started
2024-07-07 23:41:24,290 - INFO - Start polling
2024-07-07 23:41:24,645 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 23:41:32,000 - INFO - Received message from 964635576: /start
2024-07-07 23:41:32,019 - INFO - select pg_catalog.version()
2024-07-07 23:41:32,019 - INFO - [raw sql] ()
2024-07-07 23:41:32,021 - INFO - select current_schema()
2024-07-07 23:41:32,021 - INFO - [raw sql] ()
2024-07-07 23:41:32,022 - INFO - show standard_conforming_strings
2024-07-07 23:41:32,022 - INFO - [raw sql] ()
2024-07-07 23:41:32,023 - INFO - BEGIN (implicit)
2024-07-07 23:41:32,024 - INFO - INSERT INTO users (user_id, user_name, last_name, username, joined_at) VALUES ($1::BIGINT, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::TIMESTAMP WITHOUT TIME ZONE)
2024-07-07 23:41:32,024 - INFO - [generated in 0.00016s] (964635576, 'Влад', 'Казаков', 'rejoller', datetime.datetime(2024, 7, 7, 23, 41, 32, 1619))
2024-07-07 23:41:32,040 - INFO - ROLLBACK
2024-07-07 23:41:32,040 - INFO - Update id=792257332 is not handled. Duration 45 ms by bot id=6235250605
2024-07-07 23:41:32,040 - ERROR - Cause exception while process update id=792257332 by bot id=6235250605
IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "users_pkey"
DETAIL:  Key (user_id)=(964635576) already exists.
[SQL: INSERT INTO users (user_id, user_name, last_name, username, joined_at) VALUES ($1::BIGINT, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::TIMESTAMP WITHOUT TIME ZONE)]
[parameters: (964635576, 'Влад', 'Казаков', 'rejoller', datetime.datetime(2024, 7, 7, 23, 41, 32, 1619))]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 538, in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/asyncpg/prepared_stmt.py", line 176, in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/asyncpg/prepared_stmt.py", line 241, in __bind_execute
    data, status, _ = await self.__do_execute(
                      ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/asyncpg/prepared_stmt.py", line 230, in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "asyncpg/protocol/protocol.pyx", line 207, in bind_execute
asyncpg.exceptions.UniqueViolationError: duplicate key value violates unique constraint "users_pkey"
DETAIL:  Key (user_id)=(964635576) already exists.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 572, in execute
    self._adapt_connection.await_(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 550, in _prepare_and_execute
    self._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 501, in _handle_exception
    self._adapt_connection._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 784, in _handle_exception
    raise translated_error from error
sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.IntegrityError: <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "users_pkey"
DETAIL:  Key (user_id)=(964635576) already exists.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 49, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/fsm/middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/database/db.py", line 21, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 170, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 162, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/logging_middleware.py", line 8, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 61, in handle_start
    await session.commit()
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py", line 1009, in commit
    await greenlet_spawn(self.sync_session.commit)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2017, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 1302, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 1277, in _prepare_impl
    self.session.flush()
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4341, in flush
    self._flush(objects)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4476, in _flush
    with util.safe_reraise():
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py", line 146, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4437, in _flush
    flush_context.execute()
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 1048, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1418, in execute
    return meth(
           ^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py", line 515, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1640, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2353, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 572, in execute
    self._adapt_connection.await_(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 550, in _prepare_and_execute
    self._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 501, in _handle_exception
    self._adapt_connection._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 784, in _handle_exception
    raise translated_error from error
sqlalchemy.exc.IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "users_pkey"
DETAIL:  Key (user_id)=(964635576) already exists.
[SQL: INSERT INTO users (user_id, user_name, last_name, username, joined_at) VALUES ($1::BIGINT, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::TIMESTAMP WITHOUT TIME ZONE)]
[parameters: (964635576, 'Влад', 'Казаков', 'rejoller', datetime.datetime(2024, 7, 7, 23, 41, 32, 1619))]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2024-07-07 23:41:39,121 - INFO - Received message from 964635576: /subscribe
2024-07-07 23:41:39,124 - INFO - BEGIN (implicit)
2024-07-07 23:41:39,126 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-07 23:41:39,127 - INFO - [generated in 0.00026s] ()
2024-07-07 23:41:39,615 - INFO - ROLLBACK
2024-07-07 23:41:39,616 - INFO - Update id=792257333 is handled. Duration 497 ms by bot id=6235250605
2024-07-07 23:41:41,916 - INFO - Received message from 964635576: город Енисейск
2024-07-07 23:41:42,032 - INFO - BEGIN (implicit)
2024-07-07 23:41:42,033 - INFO - SELECT subscriptions.map_id 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT AND subscriptions.municipality_name = $2::VARCHAR
2024-07-07 23:41:42,033 - INFO - [generated in 0.00009s] (964635576, 'город Енисейск')
2024-07-07 23:41:42,037 - INFO - INSERT INTO subscriptions (user_id, map_id, municipality_name, subscribed_at) VALUES ($1::BIGINT, (SELECT municipalities.map_id 
FROM municipalities 
WHERE municipalities.municipality_name = $2::VARCHAR), $3::VARCHAR, $4::TIMESTAMP WITHOUT TIME ZONE) RETURNING subscriptions.id
2024-07-07 23:41:42,037 - INFO - [generated in 0.00009s] (964635576, 'город Енисейск', 'город Енисейск', datetime.datetime(2024, 7, 7, 23, 41, 42, 36610))
2024-07-07 23:41:42,039 - INFO - COMMIT
2024-07-07 23:41:42,040 - INFO - BEGIN (implicit)
2024-07-07 23:41:42,041 - INFO - SELECT subscriptions.municipality_name 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT
2024-07-07 23:41:42,041 - INFO - [generated in 0.00008s] (964635576,)
2024-07-07 23:41:42,251 - INFO - ROLLBACK
2024-07-07 23:41:42,252 - INFO - Update id=792257334 is handled. Duration 348 ms by bot id=6235250605
2024-07-07 23:41:47,575 - INFO - Received message from 964635576: /start
2024-07-07 23:41:47,576 - INFO - BEGIN (implicit)
2024-07-07 23:41:47,576 - INFO - INSERT INTO users (user_id, user_name, last_name, username, joined_at) VALUES ($1::BIGINT, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::TIMESTAMP WITHOUT TIME ZONE)
2024-07-07 23:41:47,576 - INFO - [cached since 15.55s ago] (964635576, 'Влад', 'Казаков', 'rejoller', datetime.datetime(2024, 7, 7, 23, 41, 47, 575817))
2024-07-07 23:41:47,578 - INFO - ROLLBACK
2024-07-07 23:41:47,579 - INFO - Update id=792257335 is not handled. Duration 5 ms by bot id=6235250605
2024-07-07 23:41:47,579 - ERROR - Cause exception while process update id=792257335 by bot id=6235250605
IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "users_pkey"
DETAIL:  Key (user_id)=(964635576) already exists.
[SQL: INSERT INTO users (user_id, user_name, last_name, username, joined_at) VALUES ($1::BIGINT, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::TIMESTAMP WITHOUT TIME ZONE)]
[parameters: (964635576, 'Влад', 'Казаков', 'rejoller', datetime.datetime(2024, 7, 7, 23, 41, 47, 575817))]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 538, in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/asyncpg/prepared_stmt.py", line 176, in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/asyncpg/prepared_stmt.py", line 241, in __bind_execute
    data, status, _ = await self.__do_execute(
                      ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/asyncpg/prepared_stmt.py", line 230, in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "asyncpg/protocol/protocol.pyx", line 207, in bind_execute
asyncpg.exceptions.UniqueViolationError: duplicate key value violates unique constraint "users_pkey"
DETAIL:  Key (user_id)=(964635576) already exists.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 572, in execute
    self._adapt_connection.await_(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 550, in _prepare_and_execute
    self._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 501, in _handle_exception
    self._adapt_connection._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 784, in _handle_exception
    raise translated_error from error
sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.IntegrityError: <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "users_pkey"
DETAIL:  Key (user_id)=(964635576) already exists.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 49, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/fsm/middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/database/db.py", line 21, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 170, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 162, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/logging_middleware.py", line 8, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 61, in handle_start
    await session.commit()
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py", line 1009, in commit
    await greenlet_spawn(self.sync_session.commit)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2017, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 1302, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 1277, in _prepare_impl
    self.session.flush()
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4341, in flush
    self._flush(objects)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4476, in _flush
    with util.safe_reraise():
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py", line 146, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4437, in _flush
    flush_context.execute()
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 1048, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1418, in execute
    return meth(
           ^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py", line 515, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1640, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2353, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 572, in execute
    self._adapt_connection.await_(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 550, in _prepare_and_execute
    self._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 501, in _handle_exception
    self._adapt_connection._handle_exception(error)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 784, in _handle_exception
    raise translated_error from error
sqlalchemy.exc.IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "users_pkey"
DETAIL:  Key (user_id)=(964635576) already exists.
[SQL: INSERT INTO users (user_id, user_name, last_name, username, joined_at) VALUES ($1::BIGINT, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::TIMESTAMP WITHOUT TIME ZONE)]
[parameters: (964635576, 'Влад', 'Казаков', 'rejoller', datetime.datetime(2024, 7, 7, 23, 41, 47, 575817))]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2024-07-07 23:41:55,815 - INFO - Received message from 964635576: /subscribe
2024-07-07 23:41:55,817 - INFO - BEGIN (implicit)
2024-07-07 23:41:55,817 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-07 23:41:55,817 - INFO - [cached since 16.69s ago] ()
2024-07-07 23:41:56,026 - INFO - ROLLBACK
2024-07-07 23:41:56,027 - INFO - Update id=792257336 is handled. Duration 212 ms by bot id=6235250605
2024-07-07 23:42:09,496 - INFO - Received message from 964635576: город Енисейск
2024-07-07 23:42:09,506 - INFO - BEGIN (implicit)
2024-07-07 23:42:09,506 - INFO - SELECT subscriptions.map_id 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT AND subscriptions.municipality_name = $2::VARCHAR
2024-07-07 23:42:09,507 - INFO - [cached since 27.47s ago] (964635576, 'город Енисейск')
2024-07-07 23:42:09,694 - INFO - ROLLBACK
2024-07-07 23:42:09,695 - INFO - Update id=792257337 is handled. Duration 213 ms by bot id=6235250605
2024-07-07 23:42:11,525 - INFO - Received message from 964635576: /subscribe
2024-07-07 23:42:11,526 - INFO - BEGIN (implicit)
2024-07-07 23:42:11,526 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-07 23:42:11,527 - INFO - [cached since 32.4s ago] ()
2024-07-07 23:42:11,801 - INFO - ROLLBACK
2024-07-07 23:42:11,802 - INFO - Update id=792257338 is handled. Duration 278 ms by bot id=6235250605
2024-07-07 23:42:14,087 - INFO - Received message from 964635576: город Минусинск
2024-07-07 23:42:14,093 - INFO - BEGIN (implicit)
2024-07-07 23:42:14,093 - INFO - SELECT subscriptions.map_id 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT AND subscriptions.municipality_name = $2::VARCHAR
2024-07-07 23:42:14,093 - INFO - [cached since 32.06s ago] (964635576, 'город Минусинск')
2024-07-07 23:42:14,095 - INFO - INSERT INTO subscriptions (user_id, map_id, municipality_name, subscribed_at) VALUES ($1::BIGINT, (SELECT municipalities.map_id 
FROM municipalities 
WHERE municipalities.municipality_name = $2::VARCHAR), $3::VARCHAR, $4::TIMESTAMP WITHOUT TIME ZONE) RETURNING subscriptions.id
2024-07-07 23:42:14,096 - INFO - [cached since 32.06s ago] (964635576, 'город Минусинск', 'город Минусинск', datetime.datetime(2024, 7, 7, 23, 42, 14, 94915))
2024-07-07 23:42:14,097 - INFO - COMMIT
2024-07-07 23:42:14,098 - INFO - BEGIN (implicit)
2024-07-07 23:42:14,098 - INFO - SELECT subscriptions.municipality_name 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT
2024-07-07 23:42:14,099 - INFO - [cached since 32.06s ago] (964635576,)
2024-07-07 23:42:14,238 - INFO - ROLLBACK
2024-07-07 23:42:14,239 - INFO - Update id=792257339 is handled. Duration 152 ms by bot id=6235250605
2024-07-07 23:42:24,290 - INFO - Running job "on_startup (trigger: interval[0:01:00], next run at: 2024-07-07 23:43:24 +07)" (scheduled at 2024-07-07 23:42:24.288989+07:00)
2024-07-07 23:42:25,837 - INFO - BEGIN (implicit)
2024-07-07 23:42:25,838 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-07 23:42:25,838 - INFO - [generated in 0.00013s] ()
2024-07-07 23:42:25,851 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-07 23:42:25,852 - INFO - [generated in 0.00015s] ('<561761720169067@mail.yandex.ru>',)
2024-07-07 23:42:26,192 - ERROR - Ошибка при отправке пользователю 811983691: Telegram server says - Bad Request: chat not found
2024-07-07 23:42:26,317 - ERROR - Ошибка при отправке пользователю 901904618: Telegram server says - Bad Request: chat not found
2024-07-07 23:42:26,317 - INFO - ROLLBACK
2024-07-07 23:42:26,318 - INFO - Job "on_startup (trigger: interval[0:01:00], next run at: 2024-07-07 23:43:24 +07)" executed successfully
2024-07-07 23:43:24,293 - INFO - Running job "on_startup (trigger: interval[0:01:00], next run at: 2024-07-07 23:44:24 +07)" (scheduled at 2024-07-07 23:43:24.288989+07:00)
2024-07-07 23:43:26,199 - INFO - BEGIN (implicit)
2024-07-07 23:43:26,200 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-07 23:43:26,200 - INFO - [cached since 60.36s ago] ()
2024-07-07 23:43:26,226 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-07 23:43:26,226 - INFO - [cached since 60.38s ago] ('<561761720169067@mail.yandex.ru>',)
2024-07-07 23:43:26,611 - ERROR - Ошибка при отправке пользователю 811983691: Telegram server says - Bad Request: chat not found
2024-07-07 23:43:26,779 - ERROR - Ошибка при отправке пользователю 901904618: Telegram server says - Bad Request: chat not found
2024-07-07 23:43:26,780 - INFO - ROLLBACK
2024-07-07 23:43:26,781 - INFO - Job "on_startup (trigger: interval[0:01:00], next run at: 2024-07-07 23:44:24 +07)" executed successfully
2024-07-07 23:44:24,290 - INFO - Running job "on_startup (trigger: interval[0:01:00], next run at: 2024-07-07 23:45:24 +07)" (scheduled at 2024-07-07 23:44:24.288989+07:00)
2024-07-07 23:44:25,781 - INFO - BEGIN (implicit)
2024-07-07 23:44:25,781 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-07 23:44:25,782 - INFO - [cached since 119.9s ago] ()
2024-07-07 23:44:25,792 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-07 23:44:25,792 - INFO - [cached since 119.9s ago] ('<561761720169067@mail.yandex.ru>',)
2024-07-07 23:44:26,137 - ERROR - Ошибка при отправке пользователю 811983691: Telegram server says - Bad Request: chat not found
2024-07-07 23:44:26,270 - ERROR - Ошибка при отправке пользователю 901904618: Telegram server says - Bad Request: chat not found
2024-07-07 23:44:26,270 - INFO - ROLLBACK
2024-07-07 23:44:26,271 - INFO - Job "on_startup (trigger: interval[0:01:00], next run at: 2024-07-07 23:45:24 +07)" executed successfully
2024-07-07 23:45:24,290 - INFO - Running job "on_startup (trigger: interval[0:01:00], next run at: 2024-07-07 23:46:24 +07)" (scheduled at 2024-07-07 23:45:24.288989+07:00)
2024-07-07 23:45:26,002 - INFO - BEGIN (implicit)
2024-07-07 23:45:26,003 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-07 23:45:26,003 - INFO - [cached since 180.2s ago] ()
2024-07-07 23:45:26,020 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-07 23:45:26,020 - INFO - [cached since 180.2s ago] ('<561761720169067@mail.yandex.ru>',)
2024-07-07 23:45:26,513 - ERROR - Ошибка при отправке пользователю 811983691: Telegram server says - Bad Request: chat not found
2024-07-07 23:45:26,754 - ERROR - Ошибка при отправке пользователю 901904618: Telegram server says - Bad Request: chat not found
2024-07-07 23:45:26,756 - INFO - ROLLBACK
2024-07-07 23:45:26,757 - INFO - Job "on_startup (trigger: interval[0:01:00], next run at: 2024-07-07 23:46:24 +07)" executed successfully
2024-07-07 23:45:51,089 - WARNING - Received SIGINT signal
2024-07-07 23:45:51,092 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-07 23:45:51,092 - INFO - Polling stopped
2024-07-07 23:45:51,538 - ERROR - Unclosed client session
client_session: <aiohttp.client.ClientSession object at 0x140962ae0>
2024-07-08 00:07:46,403 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-08 00:07:46,412 - INFO - Added job "on_startup" to job store "default"
2024-07-08 00:07:46,412 - INFO - Scheduler started
2024-07-08 00:07:46,413 - INFO - Start polling
2024-07-08 00:07:46,786 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-08 00:07:49,746 - INFO - Received message from 964635576: /start
2024-07-08 00:07:49,750 - INFO - Update id=792257340 is not handled. Duration 13 ms by bot id=6235250605
2024-07-08 00:07:49,750 - ERROR - Cause exception while process update id=792257340 by bot id=6235250605
ArgumentError: subject table for an INSERT, UPDATE or DELETE expected, got <database.models.Users object at 0x11e6a2360>.
Traceback (most recent call last):
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 49, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/fsm/middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/database/db.py", line 21, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 170, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 142, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 137, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/router.py", line 162, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/logging_middleware.py", line 8, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/handlers.py", line 46, in handle_start
    add_user_query = insert(Users(
                     ^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/sql/_dml_constructors.py", line 82, in insert
    return Insert(table)
           ^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/sql/dml.py", line 1213, in __init__
    super().__init__(table)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/sql/dml.py", line 987, in __init__
    self.table = coercions.expect(
                 ^^^^^^^^^^^^^^^^^
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/sql/coercions.py", line 393, in expect
    impl._raise_for_expected(original_element, argname)
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/sql/coercions.py", line 693, in _raise_for_expected
    super()._raise_for_expected(
  File "/Users/rejoller/python_projects/mchs_tg_bot/.venv/lib/python3.12/site-packages/sqlalchemy/sql/coercions.py", line 518, in _raise_for_expected
    raise exc.ArgumentError(msg, code=code) from err
sqlalchemy.exc.ArgumentError: subject table for an INSERT, UPDATE or DELETE expected, got <database.models.Users object at 0x11e6a2360>.
2024-07-08 00:07:57,364 - WARNING - Received SIGINT signal
2024-07-08 00:07:57,369 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-08 00:07:57,369 - INFO - Polling stopped
2024-07-08 00:11:50,629 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-08 00:11:50,630 - INFO - Added job "on_startup" to job store "default"
2024-07-08 00:11:50,630 - INFO - Scheduler started
2024-07-08 00:11:50,630 - INFO - Start polling
2024-07-08 00:11:50,976 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-08 00:11:55,761 - INFO - Received message from 964635576: /start
2024-07-08 00:11:55,809 - INFO - select pg_catalog.version()
2024-07-08 00:11:55,809 - INFO - [raw sql] ()
2024-07-08 00:11:55,824 - INFO - select current_schema()
2024-07-08 00:11:55,825 - INFO - [raw sql] ()
2024-07-08 00:11:55,827 - INFO - show standard_conforming_strings
2024-07-08 00:11:55,827 - INFO - [raw sql] ()
2024-07-08 00:11:55,829 - INFO - BEGIN (implicit)
2024-07-08 00:11:55,830 - INFO - INSERT INTO users (user_id, user_name, last_name, username, joined_at) VALUES ($1::BIGINT, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::TIMESTAMP WITHOUT TIME ZONE) ON CONFLICT DO NOTHING
2024-07-08 00:11:55,830 - INFO - [no key 0.00024s] (964635576, 'Влад', 'Казаков', 'rejoller', datetime.datetime(2024, 7, 8, 0, 11, 55, 764170))
2024-07-08 00:11:55,848 - INFO - COMMIT
2024-07-08 00:11:56,294 - INFO - Update id=792257341 is handled. Duration 542 ms by bot id=6235250605
2024-07-08 00:12:05,261 - INFO - Received message from 964635576: /subscribe
2024-07-08 00:12:05,264 - INFO - BEGIN (implicit)
2024-07-08 00:12:05,272 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-08 00:12:05,272 - INFO - [generated in 0.00046s] ()
2024-07-08 00:12:05,484 - INFO - ROLLBACK
2024-07-08 00:12:05,485 - INFO - Update id=792257342 is handled. Duration 226 ms by bot id=6235250605
2024-07-08 00:12:06,422 - INFO - Received message from 964635576: Ачинский район
2024-07-08 00:12:06,424 - INFO - BEGIN (implicit)
2024-07-08 00:12:06,427 - INFO - SELECT subscriptions.map_id 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT AND subscriptions.municipality_name = $2::VARCHAR
2024-07-08 00:12:06,427 - INFO - [generated in 0.00033s] (964635576, 'Ачинский район')
2024-07-08 00:12:06,438 - INFO - INSERT INTO subscriptions (user_id, map_id, municipality_name, subscribed_at) VALUES ($1::BIGINT, (SELECT municipalities.map_id 
FROM municipalities 
WHERE municipalities.municipality_name = $2::VARCHAR), $3::VARCHAR, $4::TIMESTAMP WITHOUT TIME ZONE) RETURNING subscriptions.id
2024-07-08 00:12:06,438 - INFO - [generated in 0.00023s] (964635576, 'Ачинский район', 'Ачинский район', datetime.datetime(2024, 7, 8, 0, 12, 6, 432586))
2024-07-08 00:12:06,455 - INFO - COMMIT
2024-07-08 00:12:06,458 - INFO - BEGIN (implicit)
2024-07-08 00:12:06,459 - INFO - SELECT subscriptions.municipality_name 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT
2024-07-08 00:12:06,459 - INFO - [generated in 0.00019s] (964635576,)
2024-07-08 00:12:06,587 - INFO - ROLLBACK
2024-07-08 00:12:06,588 - INFO - Update id=792257343 is handled. Duration 168 ms by bot id=6235250605
2024-07-08 00:12:09,713 - INFO - Received message from 964635576: /subscribe
2024-07-08 00:12:09,714 - INFO - BEGIN (implicit)
2024-07-08 00:12:09,714 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-08 00:12:09,714 - INFO - [cached since 4.443s ago] ()
2024-07-08 00:12:09,869 - INFO - ROLLBACK
2024-07-08 00:12:09,871 - INFO - Update id=792257344 is handled. Duration 157 ms by bot id=6235250605
2024-07-08 00:12:11,492 - INFO - Received message from 964635576: Ачинский район
2024-07-08 00:12:11,493 - INFO - BEGIN (implicit)
2024-07-08 00:12:11,494 - INFO - SELECT subscriptions.map_id 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT AND subscriptions.municipality_name = $2::VARCHAR
2024-07-08 00:12:11,494 - INFO - [cached since 5.067s ago] (964635576, 'Ачинский район')
2024-07-08 00:12:11,628 - INFO - ROLLBACK
2024-07-08 00:12:11,629 - INFO - Update id=792257345 is handled. Duration 137 ms by bot id=6235250605
2024-07-08 00:12:14,905 - INFO - Received message from 964635576: /start
2024-07-08 00:12:14,907 - INFO - BEGIN (implicit)
2024-07-08 00:12:14,907 - INFO - INSERT INTO users (user_id, user_name, last_name, username, joined_at) VALUES ($1::BIGINT, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::TIMESTAMP WITHOUT TIME ZONE) ON CONFLICT DO NOTHING
2024-07-08 00:12:14,907 - INFO - [no key 0.00019s] (964635576, 'Влад', 'Казаков', 'rejoller', datetime.datetime(2024, 7, 8, 0, 12, 14, 906559))
2024-07-08 00:12:14,908 - INFO - COMMIT
2024-07-08 00:12:15,128 - INFO - Update id=792257346 is handled. Duration 223 ms by bot id=6235250605
2024-07-08 00:12:16,724 - INFO - BEGIN (implicit)
2024-07-08 00:12:16,724 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-08 00:12:16,724 - INFO - [cached since 11.45s ago] ()
2024-07-08 00:12:16,881 - INFO - ROLLBACK
2024-07-08 00:12:16,881 - INFO - Update id=792257347 is handled. Duration 160 ms by bot id=6235250605
2024-07-08 00:12:19,261 - INFO - Received message from 964635576: Партизанский район
2024-07-08 00:12:19,263 - INFO - BEGIN (implicit)
2024-07-08 00:12:19,263 - INFO - SELECT subscriptions.map_id 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT AND subscriptions.municipality_name = $2::VARCHAR
2024-07-08 00:12:19,263 - INFO - [cached since 12.84s ago] (964635576, 'Партизанский район')
2024-07-08 00:12:19,265 - INFO - INSERT INTO subscriptions (user_id, map_id, municipality_name, subscribed_at) VALUES ($1::BIGINT, (SELECT municipalities.map_id 
FROM municipalities 
WHERE municipalities.municipality_name = $2::VARCHAR), $3::VARCHAR, $4::TIMESTAMP WITHOUT TIME ZONE) RETURNING subscriptions.id
2024-07-08 00:12:19,265 - INFO - [cached since 12.83s ago] (964635576, 'Партизанский район', 'Партизанский район', datetime.datetime(2024, 7, 8, 0, 12, 19, 264487))
2024-07-08 00:12:19,267 - INFO - COMMIT
2024-07-08 00:12:19,269 - INFO - BEGIN (implicit)
2024-07-08 00:12:19,270 - INFO - SELECT subscriptions.municipality_name 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT
2024-07-08 00:12:19,270 - INFO - [cached since 12.81s ago] (964635576,)
2024-07-08 00:12:19,442 - INFO - ROLLBACK
2024-07-08 00:12:19,443 - INFO - Update id=792257348 is handled. Duration 182 ms by bot id=6235250605
2024-07-08 00:12:24,571 - INFO - Received message from 964635576: /subscribe
2024-07-08 00:12:24,573 - INFO - BEGIN (implicit)
2024-07-08 00:12:24,573 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-08 00:12:24,574 - INFO - [cached since 19.3s ago] ()
2024-07-08 00:12:24,738 - INFO - ROLLBACK
2024-07-08 00:12:24,739 - INFO - Update id=792257349 is handled. Duration 169 ms by bot id=6235250605
2024-07-08 00:12:29,334 - INFO - Received message from 964635576: Эвенкийский муниципальный район
2024-07-08 00:12:29,335 - INFO - BEGIN (implicit)
2024-07-08 00:12:29,335 - INFO - SELECT subscriptions.map_id 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT AND subscriptions.municipality_name = $2::VARCHAR
2024-07-08 00:12:29,336 - INFO - [cached since 22.91s ago] (964635576, 'Эвенкийский муниципальный район')
2024-07-08 00:12:29,338 - INFO - INSERT INTO subscriptions (user_id, map_id, municipality_name, subscribed_at) VALUES ($1::BIGINT, (SELECT municipalities.map_id 
FROM municipalities 
WHERE municipalities.municipality_name = $2::VARCHAR), $3::VARCHAR, $4::TIMESTAMP WITHOUT TIME ZONE) RETURNING subscriptions.id
2024-07-08 00:12:29,339 - INFO - [cached since 22.9s ago] (964635576, 'Эвенкийский муниципальный район', 'Эвенкийский муниципальный район', datetime.datetime(2024, 7, 8, 0, 12, 29, 337755))
2024-07-08 00:12:29,341 - INFO - COMMIT
2024-07-08 00:12:29,346 - INFO - BEGIN (implicit)
2024-07-08 00:12:29,347 - INFO - SELECT subscriptions.municipality_name 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT
2024-07-08 00:12:29,347 - INFO - [cached since 22.89s ago] (964635576,)
2024-07-08 00:12:29,546 - INFO - ROLLBACK
2024-07-08 00:12:29,547 - INFO - Update id=792257350 is handled. Duration 213 ms by bot id=6235250605
2024-07-08 00:12:32,711 - INFO - Received message from 964635576: /subscribe
2024-07-08 00:12:32,712 - INFO - BEGIN (implicit)
2024-07-08 00:12:32,712 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-08 00:12:32,712 - INFO - [cached since 27.44s ago] ()
2024-07-08 00:12:32,884 - INFO - ROLLBACK
2024-07-08 00:12:32,885 - INFO - Update id=792257351 is handled. Duration 174 ms by bot id=6235250605
2024-07-08 00:12:37,096 - INFO - Received message from 964635576: Северо-Енисейский район
2024-07-08 00:12:37,097 - INFO - BEGIN (implicit)
2024-07-08 00:12:37,097 - INFO - SELECT subscriptions.map_id 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT AND subscriptions.municipality_name = $2::VARCHAR
2024-07-08 00:12:37,097 - INFO - [cached since 30.67s ago] (964635576, 'Северо-Енисейский район')
2024-07-08 00:12:37,100 - INFO - INSERT INTO subscriptions (user_id, map_id, municipality_name, subscribed_at) VALUES ($1::BIGINT, (SELECT municipalities.map_id 
FROM municipalities 
WHERE municipalities.municipality_name = $2::VARCHAR), $3::VARCHAR, $4::TIMESTAMP WITHOUT TIME ZONE) RETURNING subscriptions.id
2024-07-08 00:12:37,100 - INFO - [cached since 30.66s ago] (964635576, 'Северо-Енисейский район', 'Северо-Енисейский район', datetime.datetime(2024, 7, 8, 0, 12, 37, 99160))
2024-07-08 00:12:37,101 - INFO - COMMIT
2024-07-08 00:12:37,103 - INFO - BEGIN (implicit)
2024-07-08 00:12:37,103 - INFO - SELECT subscriptions.municipality_name 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT
2024-07-08 00:12:37,104 - INFO - [cached since 30.65s ago] (964635576,)
2024-07-08 00:12:37,293 - INFO - ROLLBACK
2024-07-08 00:12:37,294 - INFO - Update id=792257352 is handled. Duration 199 ms by bot id=6235250605
2024-07-08 00:12:50,631 - INFO - Running job "on_startup (trigger: interval[0:01:00], next run at: 2024-07-08 00:13:50 +07)" (scheduled at 2024-07-08 00:12:50.629398+07:00)
2024-07-08 00:12:52,560 - INFO - BEGIN (implicit)
2024-07-08 00:12:52,561 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-08 00:12:52,562 - INFO - [generated in 0.00017s] ()
2024-07-08 00:12:52,581 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-08 00:12:52,581 - INFO - [generated in 0.00014s] ('<561761720169067@mail.yandex.ru>',)
2024-07-08 00:12:52,958 - ERROR - Ошибка при отправке пользователю 811983691: Telegram server says - Bad Request: chat not found
2024-07-08 00:12:53,098 - ERROR - Ошибка при отправке пользователю 901904618: Telegram server says - Bad Request: chat not found
2024-07-08 00:12:53,099 - INFO - ROLLBACK
2024-07-08 00:12:53,100 - INFO - Job "on_startup (trigger: interval[0:01:00], next run at: 2024-07-08 00:13:50 +07)" executed successfully
2024-07-08 00:12:58,013 - INFO - Received message from 964635576: /my_subscriptions
2024-07-08 00:12:58,015 - INFO - BEGIN (implicit)
2024-07-08 00:12:58,016 - INFO - SELECT subscriptions.municipality_name 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT
2024-07-08 00:12:58,016 - INFO - [cached since 51.56s ago] (964635576,)
2024-07-08 00:12:58,382 - INFO - ROLLBACK
2024-07-08 00:12:58,386 - INFO - Update id=792257353 is handled. Duration 374 ms by bot id=6235250605
2024-07-08 00:13:03,653 - INFO - Received message from 964635576: /cancel_subscriptions
2024-07-08 00:13:03,657 - INFO - BEGIN (implicit)
2024-07-08 00:13:03,659 - INFO - DELETE FROM subscriptions WHERE subscriptions.user_id = $1::BIGINT
2024-07-08 00:13:03,659 - INFO - [generated in 0.00027s] (964635576,)
2024-07-08 00:13:03,665 - INFO - COMMIT
2024-07-08 00:13:03,834 - INFO - Update id=792257354 is handled. Duration 204 ms by bot id=6235250605
2024-07-08 00:13:06,077 - INFO - Received message from 964635576: /my_subscriptions
2024-07-08 00:13:06,078 - INFO - BEGIN (implicit)
2024-07-08 00:13:06,079 - INFO - SELECT subscriptions.municipality_name 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT
2024-07-08 00:13:06,079 - INFO - [cached since 59.62s ago] (964635576,)
2024-07-08 00:13:06,305 - INFO - ROLLBACK
2024-07-08 00:13:06,306 - INFO - Update id=792257355 is handled. Duration 231 ms by bot id=6235250605
2024-07-08 00:13:08,273 - INFO - Received message from 964635576: /subscribe
2024-07-08 00:13:08,273 - INFO - BEGIN (implicit)
2024-07-08 00:13:08,274 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-08 00:13:08,274 - INFO - [cached since 63s ago] ()
2024-07-08 00:13:08,442 - INFO - ROLLBACK
2024-07-08 00:13:08,443 - INFO - Update id=792257356 is handled. Duration 171 ms by bot id=6235250605
2024-07-08 00:13:50,633 - INFO - Running job "on_startup (trigger: interval[0:01:00], next run at: 2024-07-08 00:14:50 +07)" (scheduled at 2024-07-08 00:13:50.629398+07:00)
2024-07-08 00:13:52,378 - INFO - BEGIN (implicit)
2024-07-08 00:13:52,379 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-08 00:13:52,379 - INFO - [cached since 59.82s ago] ()
2024-07-08 00:13:52,404 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-08 00:13:52,405 - INFO - [cached since 59.82s ago] ('<561761720169067@mail.yandex.ru>',)
2024-07-08 00:13:52,855 - ERROR - Ошибка при отправке пользователю 811983691: Telegram server says - Bad Request: chat not found
2024-07-08 00:13:53,212 - ERROR - Ошибка при отправке пользователю 901904618: Telegram server says - Bad Request: chat not found
2024-07-08 00:13:53,214 - INFO - ROLLBACK
2024-07-08 00:13:53,215 - INFO - Job "on_startup (trigger: interval[0:01:00], next run at: 2024-07-08 00:14:50 +07)" executed successfully
2024-07-08 00:14:50,632 - INFO - Running job "on_startup (trigger: interval[0:01:00], next run at: 2024-07-08 00:15:50 +07)" (scheduled at 2024-07-08 00:14:50.629398+07:00)
2024-07-08 00:14:52,110 - INFO - BEGIN (implicit)
2024-07-08 00:14:52,111 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-08 00:14:52,111 - INFO - [cached since 119.6s ago] ()
2024-07-08 00:14:52,124 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-08 00:14:52,124 - INFO - [cached since 119.5s ago] ('<561761720169067@mail.yandex.ru>',)
2024-07-08 00:14:52,524 - ERROR - Ошибка при отправке пользователю 811983691: Telegram server says - Bad Request: chat not found
2024-07-08 00:14:52,681 - ERROR - Ошибка при отправке пользователю 901904618: Telegram server says - Bad Request: chat not found
2024-07-08 00:14:52,683 - INFO - ROLLBACK
2024-07-08 00:14:52,684 - INFO - Job "on_startup (trigger: interval[0:01:00], next run at: 2024-07-08 00:15:50 +07)" executed successfully
2024-07-08 00:15:50,633 - INFO - Running job "on_startup (trigger: interval[0:01:00], next run at: 2024-07-08 00:16:50 +07)" (scheduled at 2024-07-08 00:15:50.629398+07:00)
2024-07-08 00:15:52,202 - INFO - BEGIN (implicit)
2024-07-08 00:15:52,203 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-08 00:15:52,203 - INFO - [cached since 179.6s ago] ()
2024-07-08 00:15:52,215 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-08 00:15:52,215 - INFO - [cached since 179.6s ago] ('<561761720169067@mail.yandex.ru>',)
2024-07-08 00:15:52,581 - ERROR - Ошибка при отправке пользователю 811983691: Telegram server says - Bad Request: chat not found
2024-07-08 00:15:52,754 - ERROR - Ошибка при отправке пользователю 901904618: Telegram server says - Bad Request: chat not found
2024-07-08 00:15:52,756 - INFO - ROLLBACK
2024-07-08 00:15:52,757 - INFO - Job "on_startup (trigger: interval[0:01:00], next run at: 2024-07-08 00:16:50 +07)" executed successfully
2024-07-08 00:16:05,237 - WARNING - Received SIGINT signal
2024-07-08 00:16:05,241 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-08 00:16:05,241 - INFO - Polling stopped
2024-07-08 00:16:05,719 - ERROR - Unclosed client session
client_session: <aiohttp.client.ClientSession object at 0x11fc296d0>
2024-07-08 00:16:05,720 - ERROR - Unclosed connector
connections: ['[(<aiohttp.client_proto.ResponseHandler object at 0x11fcb5fd0>, 346440.537584125)]']
connector: <aiohttp.connector.TCPConnector object at 0x11f9793d0>
2024-07-08 00:16:09,642 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-08 00:16:09,642 - INFO - Added job "on_startup" to job store "default"
2024-07-08 00:16:09,642 - INFO - Scheduler started
2024-07-08 00:16:09,643 - INFO - Start polling
2024-07-08 00:16:09,984 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-08 00:16:16,976 - INFO - Received message from 964635576: /subscribe
2024-07-08 00:16:16,991 - INFO - select pg_catalog.version()
2024-07-08 00:16:16,991 - INFO - select pg_catalog.version()
2024-07-08 00:16:16,991 - INFO - [raw sql] ()
2024-07-08 00:16:16,991 - INFO - [raw sql] ()
2024-07-08 00:16:16,994 - INFO - select current_schema()
2024-07-08 00:16:16,994 - INFO - select current_schema()
2024-07-08 00:16:16,994 - INFO - [raw sql] ()
2024-07-08 00:16:16,994 - INFO - [raw sql] ()
2024-07-08 00:16:16,995 - INFO - show standard_conforming_strings
2024-07-08 00:16:16,995 - INFO - show standard_conforming_strings
2024-07-08 00:16:16,995 - INFO - [raw sql] ()
2024-07-08 00:16:16,995 - INFO - [raw sql] ()
2024-07-08 00:16:16,996 - INFO - BEGIN (implicit)
2024-07-08 00:16:16,996 - INFO - BEGIN (implicit)
2024-07-08 00:16:17,002 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-08 00:16:17,002 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-08 00:16:17,003 - INFO - [generated in 0.00063s] ()
2024-07-08 00:16:17,003 - INFO - [generated in 0.00063s] ()
2024-07-08 00:16:17,415 - INFO - ROLLBACK
2024-07-08 00:16:17,415 - INFO - ROLLBACK
2024-07-08 00:16:17,416 - INFO - Update id=792257357 is handled. Duration 454 ms by bot id=6235250605
2024-07-08 00:16:36,417 - WARNING - Received SIGINT signal
2024-07-08 00:16:36,421 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-08 00:16:36,421 - INFO - Polling stopped
2024-07-08 00:16:57,219 - INFO - select pg_catalog.version()
2024-07-08 00:16:57,219 - INFO - select pg_catalog.version()
2024-07-08 00:16:57,221 - INFO - [raw sql] ()
2024-07-08 00:16:57,221 - INFO - [raw sql] ()
2024-07-08 00:16:57,223 - INFO - select current_schema()
2024-07-08 00:16:57,223 - INFO - select current_schema()
2024-07-08 00:16:57,223 - INFO - [raw sql] ()
2024-07-08 00:16:57,223 - INFO - [raw sql] ()
2024-07-08 00:16:57,224 - INFO - show standard_conforming_strings
2024-07-08 00:16:57,224 - INFO - show standard_conforming_strings
2024-07-08 00:16:57,224 - INFO - [raw sql] ()
2024-07-08 00:16:57,224 - INFO - [raw sql] ()
2024-07-08 00:16:57,227 - INFO - BEGIN (implicit)
2024-07-08 00:16:57,227 - INFO - BEGIN (implicit)
2024-07-08 00:16:57,234 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-08 00:16:57,234 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-08 00:16:57,235 - INFO - [generated in 0.00044s] ()
2024-07-08 00:16:57,235 - INFO - [generated in 0.00044s] ()
2024-07-08 00:16:57,756 - INFO - ROLLBACK
2024-07-08 00:16:57,756 - INFO - ROLLBACK
2024-07-08 00:17:42,825 - INFO - BEGIN (implicit)
2024-07-08 00:17:42,825 - INFO - BEGIN (implicit)
2024-07-08 00:17:42,827 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-08 00:17:42,827 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-08 00:17:42,828 - INFO - [generated in 0.00026s] ()
2024-07-08 00:17:42,828 - INFO - [generated in 0.00026s] ()
2024-07-08 00:17:42,889 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-08 00:17:42,889 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-08 00:17:42,889 - INFO - [generated in 0.00014s] ('<561761720169067@mail.yandex.ru>',)
2024-07-08 00:17:42,889 - INFO - [generated in 0.00014s] ('<561761720169067@mail.yandex.ru>',)
2024-07-08 00:17:43,255 - ERROR - Ошибка при отправке пользователю 811983691: Telegram server says - Bad Request: chat not found
2024-07-08 00:17:43,382 - ERROR - Ошибка при отправке пользователю 901904618: Telegram server says - Bad Request: chat not found
2024-07-08 00:17:43,383 - INFO - ROLLBACK
2024-07-08 00:17:43,383 - INFO - ROLLBACK
2024-07-08 00:18:15,258 - ERROR - Unclosed client session
client_session: <aiohttp.client.ClientSession object at 0x12780bfe0>
2024-07-08 00:18:22,254 - INFO - select pg_catalog.version()
2024-07-08 00:18:22,254 - INFO - select pg_catalog.version()
2024-07-08 00:18:22,255 - INFO - [raw sql] ()
2024-07-08 00:18:22,255 - INFO - [raw sql] ()
2024-07-08 00:18:22,259 - INFO - select current_schema()
2024-07-08 00:18:22,259 - INFO - select current_schema()
2024-07-08 00:18:22,259 - INFO - [raw sql] ()
2024-07-08 00:18:22,259 - INFO - [raw sql] ()
2024-07-08 00:18:22,261 - INFO - show standard_conforming_strings
2024-07-08 00:18:22,261 - INFO - show standard_conforming_strings
2024-07-08 00:18:22,261 - INFO - [raw sql] ()
2024-07-08 00:18:22,261 - INFO - [raw sql] ()
2024-07-08 00:18:22,262 - INFO - BEGIN (implicit)
2024-07-08 00:18:22,262 - INFO - BEGIN (implicit)
2024-07-08 00:18:22,265 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-08 00:18:22,265 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-08 00:18:22,265 - INFO - [generated in 0.00018s] ()
2024-07-08 00:18:22,265 - INFO - [generated in 0.00018s] ()
2024-07-08 00:18:22,765 - INFO - ROLLBACK
2024-07-08 00:18:22,765 - INFO - ROLLBACK
2024-07-08 00:19:20,361 - INFO - BEGIN (implicit)
2024-07-08 00:19:20,361 - INFO - BEGIN (implicit)
2024-07-08 00:19:20,363 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-08 00:19:20,363 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-08 00:19:20,363 - INFO - [generated in 0.00051s] ()
2024-07-08 00:19:20,363 - INFO - [generated in 0.00051s] ()
2024-07-08 00:19:20,383 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-08 00:19:20,383 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-08 00:19:20,383 - INFO - [generated in 0.00022s] ('<561761720169067@mail.yandex.ru>',)
2024-07-08 00:19:20,383 - INFO - [generated in 0.00022s] ('<561761720169067@mail.yandex.ru>',)
2024-07-08 00:19:20,733 - ERROR - Ошибка при отправке пользователю 811983691: Telegram server says - Bad Request: chat not found
2024-07-08 00:19:20,862 - ERROR - Ошибка при отправке пользователю 901904618: Telegram server says - Bad Request: chat not found
2024-07-08 00:19:20,865 - INFO - ROLLBACK
2024-07-08 00:19:20,865 - INFO - ROLLBACK
2024-07-08 00:20:20,277 - INFO - BEGIN (implicit)
2024-07-08 00:20:20,277 - INFO - BEGIN (implicit)
2024-07-08 00:20:20,279 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-08 00:20:20,279 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-08 00:20:20,280 - INFO - [cached since 59.92s ago] ()
2024-07-08 00:20:20,280 - INFO - [cached since 59.92s ago] ()
2024-07-08 00:20:20,298 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-08 00:20:20,298 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-08 00:20:20,298 - INFO - [cached since 59.92s ago] ('<561761720169067@mail.yandex.ru>',)
2024-07-08 00:20:20,298 - INFO - [cached since 59.92s ago] ('<561761720169067@mail.yandex.ru>',)
2024-07-08 00:20:20,641 - ERROR - Ошибка при отправке пользователю 811983691: Telegram server says - Bad Request: chat not found
2024-07-08 00:20:20,767 - ERROR - Ошибка при отправке пользователю 901904618: Telegram server says - Bad Request: chat not found
2024-07-08 00:20:20,769 - INFO - ROLLBACK
2024-07-08 00:20:20,769 - INFO - ROLLBACK
2024-07-08 00:21:20,269 - INFO - BEGIN (implicit)
2024-07-08 00:21:20,269 - INFO - BEGIN (implicit)
2024-07-08 00:21:20,271 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-08 00:21:20,271 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-08 00:21:20,271 - INFO - [cached since 119.9s ago] ()
2024-07-08 00:21:20,271 - INFO - [cached since 119.9s ago] ()
2024-07-08 00:21:20,283 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-08 00:21:20,283 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-08 00:21:20,283 - INFO - [cached since 119.9s ago] ('<561761720169067@mail.yandex.ru>',)
2024-07-08 00:21:20,283 - INFO - [cached since 119.9s ago] ('<561761720169067@mail.yandex.ru>',)
2024-07-08 00:21:20,668 - ERROR - Ошибка при отправке пользователю 811983691: Telegram server says - Bad Request: chat not found
2024-07-08 00:21:20,809 - ERROR - Ошибка при отправке пользователю 901904618: Telegram server says - Bad Request: chat not found
2024-07-08 00:21:20,812 - INFO - ROLLBACK
2024-07-08 00:21:20,812 - INFO - ROLLBACK
2024-07-08 00:22:23,283 - INFO - BEGIN (implicit)
2024-07-08 00:22:23,283 - INFO - BEGIN (implicit)
2024-07-08 00:22:23,285 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-08 00:22:23,285 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-08 00:22:23,285 - INFO - [cached since 182.9s ago] ()
2024-07-08 00:22:23,285 - INFO - [cached since 182.9s ago] ()
2024-07-08 00:22:23,296 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-08 00:22:23,296 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-08 00:22:23,297 - INFO - [cached since 182.9s ago] ('<561761720169067@mail.yandex.ru>',)
2024-07-08 00:22:23,297 - INFO - [cached since 182.9s ago] ('<561761720169067@mail.yandex.ru>',)
2024-07-08 00:22:23,855 - ERROR - Ошибка при отправке пользователю 811983691: Telegram server says - Bad Request: chat not found
2024-07-08 00:22:24,113 - ERROR - Ошибка при отправке пользователю 901904618: Telegram server says - Bad Request: chat not found
2024-07-08 00:22:24,115 - INFO - ROLLBACK
2024-07-08 00:22:24,115 - INFO - ROLLBACK
2024-07-08 00:23:20,272 - INFO - BEGIN (implicit)
2024-07-08 00:23:20,272 - INFO - BEGIN (implicit)
2024-07-08 00:23:20,273 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-08 00:23:20,273 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-08 00:23:20,274 - INFO - [cached since 239.9s ago] ()
2024-07-08 00:23:20,274 - INFO - [cached since 239.9s ago] ()
2024-07-08 00:23:20,284 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-08 00:23:20,284 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-08 00:23:20,284 - INFO - [cached since 239.9s ago] ('<561761720169067@mail.yandex.ru>',)
2024-07-08 00:23:20,284 - INFO - [cached since 239.9s ago] ('<561761720169067@mail.yandex.ru>',)
2024-07-08 00:23:20,633 - ERROR - Ошибка при отправке пользователю 811983691: Telegram server says - Bad Request: chat not found
2024-07-08 00:23:20,780 - ERROR - Ошибка при отправке пользователю 901904618: Telegram server says - Bad Request: chat not found
2024-07-08 00:23:20,782 - INFO - ROLLBACK
2024-07-08 00:23:20,782 - INFO - ROLLBACK
2024-07-08 00:23:28,165 - ERROR - Unclosed client session
client_session: <aiohttp.client.ClientSession object at 0x13600bf50>
2024-07-08 00:23:28,166 - ERROR - Unclosed connector
connections: ['[(<aiohttp.client_proto.ResponseHandler object at 0x136064050>, 346888.555919416)]']
connector: <aiohttp.connector.TCPConnector object at 0x136009490>
2024-07-08 00:23:32,747 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-08 00:23:32,748 - INFO - Added job "on_startup" to job store "default"
2024-07-08 00:23:32,748 - INFO - Scheduler started
2024-07-08 00:23:32,748 - INFO - Start polling
2024-07-08 00:23:33,072 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-08 00:23:36,645 - INFO - Received message from 964635576: /subscribe
2024-07-08 00:23:36,693 - INFO - select pg_catalog.version()
2024-07-08 00:23:36,693 - INFO - [raw sql] ()
2024-07-08 00:23:36,703 - INFO - select current_schema()
2024-07-08 00:23:36,703 - INFO - [raw sql] ()
2024-07-08 00:23:36,705 - INFO - show standard_conforming_strings
2024-07-08 00:23:36,705 - INFO - [raw sql] ()
2024-07-08 00:23:36,706 - INFO - BEGIN (implicit)
2024-07-08 00:23:36,713 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-08 00:23:36,713 - INFO - [generated in 0.00041s] ()
2024-07-08 00:23:37,222 - INFO - ROLLBACK
2024-07-08 00:23:37,222 - INFO - Update id=792257360 is handled. Duration 582 ms by bot id=6235250605
2024-07-08 00:24:32,750 - INFO - Running job "on_startup (trigger: interval[0:01:00], next run at: 2024-07-08 00:25:32 +07)" (scheduled at 2024-07-08 00:24:32.747893+07:00)
2024-07-08 00:24:34,370 - INFO - BEGIN (implicit)
2024-07-08 00:24:34,374 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-08 00:24:34,374 - INFO - [generated in 0.00035s] ()
2024-07-08 00:24:34,395 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-08 00:24:34,395 - INFO - [generated in 0.00025s] ('<561761720169067@mail.yandex.ru>',)
2024-07-08 00:24:34,898 - ERROR - Ошибка при отправке пользователю 811983691: Telegram server says - Bad Request: chat not found
2024-07-08 00:24:35,205 - ERROR - Ошибка при отправке пользователю 901904618: Telegram server says - Bad Request: chat not found
2024-07-08 00:24:35,209 - INFO - ROLLBACK
2024-07-08 00:24:35,213 - INFO - Job "on_startup (trigger: interval[0:01:00], next run at: 2024-07-08 00:25:32 +07)" executed successfully
2024-07-08 00:25:18,784 - INFO - Received message from 964635576: /subscribe
2024-07-08 00:25:18,788 - INFO - BEGIN (implicit)
2024-07-08 00:25:18,791 - INFO - SELECT municipalities.map_id, municipalities.municipality_name 
FROM municipalities ORDER BY municipalities.municipality_name ASC
2024-07-08 00:25:18,791 - INFO - [cached since 102.1s ago] ()
2024-07-08 00:25:19,306 - INFO - ROLLBACK
2024-07-08 00:25:19,309 - INFO - Update id=792257361 is handled. Duration 528 ms by bot id=6235250605
2024-07-08 00:25:22,757 - INFO - Received message from 964635576: Сухобузимский район
2024-07-08 00:25:22,759 - INFO - BEGIN (implicit)
2024-07-08 00:25:22,762 - INFO - SELECT subscriptions.map_id 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT AND subscriptions.municipality_name = $2::VARCHAR
2024-07-08 00:25:22,763 - INFO - [generated in 0.00039s] (964635576, 'Сухобузимский район')
2024-07-08 00:25:22,772 - INFO - INSERT INTO subscriptions (user_id, map_id, municipality_name, subscribed_at) VALUES ($1::BIGINT, (SELECT municipalities.map_id 
FROM municipalities 
WHERE municipalities.municipality_name = $2::VARCHAR), $3::VARCHAR, $4::TIMESTAMP WITHOUT TIME ZONE) RETURNING subscriptions.id
2024-07-08 00:25:22,772 - INFO - [generated in 0.00028s] (964635576, 'Сухобузимский район', 'Сухобузимский район', datetime.datetime(2024, 7, 8, 0, 25, 22, 768578))
2024-07-08 00:25:22,781 - INFO - COMMIT
2024-07-08 00:25:22,783 - INFO - BEGIN (implicit)
2024-07-08 00:25:22,784 - INFO - SELECT subscriptions.municipality_name 
FROM subscriptions 
WHERE subscriptions.user_id = $1::BIGINT
2024-07-08 00:25:22,785 - INFO - [generated in 0.00025s] (964635576,)
2024-07-08 00:25:22,924 - INFO - ROLLBACK
2024-07-08 00:25:22,926 - INFO - Update id=792257362 is handled. Duration 170 ms by bot id=6235250605
2024-07-08 00:25:32,751 - INFO - Running job "on_startup (trigger: interval[0:01:00], next run at: 2024-07-08 00:26:32 +07)" (scheduled at 2024-07-08 00:25:32.747893+07:00)
2024-07-08 00:25:34,535 - INFO - BEGIN (implicit)
2024-07-08 00:25:34,536 - INFO - SELECT subscriptions.user_id, subscriptions.map_id 
FROM subscriptions
2024-07-08 00:25:34,536 - INFO - [cached since 60.16s ago] ()
2024-07-08 00:25:34,561 - INFO - SELECT messages.user_id 
FROM messages 
WHERE messages.message_id = $1::VARCHAR
2024-07-08 00:25:34,561 - INFO - [cached since 60.17s ago] ('<561761720169067@mail.yandex.ru>',)
2024-07-08 00:25:34,905 - ERROR - Ошибка при отправке пользователю 811983691: Telegram server says - Bad Request: chat not found
2024-07-08 00:25:35,030 - ERROR - Ошибка при отправке пользователю 901904618: Telegram server says - Bad Request: chat not found
2024-07-08 00:25:35,031 - INFO - ROLLBACK
2024-07-08 00:25:35,032 - INFO - Job "on_startup (trigger: interval[0:01:00], next run at: 2024-07-08 00:26:32 +07)" executed successfully
2024-07-08 00:25:55,433 - INFO - Received message from 964635576: /cancel_subscriptions
2024-07-08 00:25:55,439 - INFO - BEGIN (implicit)
2024-07-08 00:25:55,441 - INFO - DELETE FROM subscriptions WHERE subscriptions.user_id = $1::BIGINT
2024-07-08 00:25:55,441 - INFO - [generated in 0.00016s] (964635576,)
2024-07-08 00:25:55,470 - INFO - COMMIT
2024-07-08 00:25:55,845 - INFO - Update id=792257363 is handled. Duration 416 ms by bot id=6235250605
2024-07-08 00:25:57,676 - INFO - Received message from 964635576: /cancel_subscriptions
2024-07-08 00:25:57,678 - INFO - BEGIN (implicit)
2024-07-08 00:25:57,679 - INFO - DELETE FROM subscriptions WHERE subscriptions.user_id = $1::BIGINT
2024-07-08 00:25:57,679 - INFO - [cached since 2.238s ago] (964635576,)
2024-07-08 00:25:57,680 - INFO - COMMIT
2024-07-08 00:25:57,818 - INFO - Update id=792257364 is handled. Duration 143 ms by bot id=6235250605
2024-07-08 00:26:04,915 - WARNING - Received SIGINT signal
2024-07-08 00:26:04,918 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-08 00:26:04,918 - INFO - Polling stopped
2024-07-08 00:26:05,357 - ERROR - Unclosed client session
client_session: <aiohttp.client.ClientSession object at 0x14570bef0>
2024-07-08 00:27:05,590 - INFO - Adding job tentatively -- it will be properly scheduled when the scheduler starts
2024-07-08 00:27:05,591 - INFO - Added job "on_startup" to job store "default"
2024-07-08 00:27:05,591 - INFO - Scheduler started
2024-07-08 00:27:05,591 - INFO - Start polling
2024-07-08 00:27:05,925 - INFO - Run polling for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-08 00:27:10,909 - INFO - Received message from 964635576: /subscribe
2024-07-08 00:27:11,360 - INFO - Update id=792257365 is handled. Duration 455 ms by bot id=6235250605
2024-07-08 00:27:13,307 - INFO - Received message from 964635576: Ачинский район
2024-07-08 00:27:13,455 - INFO - Update id=792257366 is handled. Duration 149 ms by bot id=6235250605
2024-07-08 00:27:19,325 - INFO - Received message from 964635576: /subscribe
2024-07-08 00:27:19,501 - INFO - Update id=792257367 is handled. Duration 178 ms by bot id=6235250605
2024-07-08 00:27:34,953 - INFO - Received message from 964635576: упвпвпвм
2024-07-08 00:27:35,332 - INFO - Update id=792257368 is handled. Duration 396 ms by bot id=6235250605
2024-07-08 00:27:41,499 - INFO - Received message from 964635576: Отмена
2024-07-08 00:27:41,676 - INFO - Update id=792257369 is handled. Duration 190 ms by bot id=6235250605
2024-07-08 00:27:44,925 - INFO - Update id=792257370 is not handled. Duration 1 ms by bot id=6235250605
2024-07-08 00:28:05,597 - INFO - Running job "on_startup (trigger: interval[0:01:00], next run at: 2024-07-08 00:29:05 +07)" (scheduled at 2024-07-08 00:28:05.590712+07:00)
2024-07-08 00:28:07,727 - ERROR - Ошибка при отправке пользователю 811983691: Telegram server says - Bad Request: chat not found
2024-07-08 00:28:07,889 - ERROR - Ошибка при отправке пользователю 901904618: Telegram server says - Bad Request: chat not found
2024-07-08 00:28:07,895 - INFO - Job "on_startup (trigger: interval[0:01:00], next run at: 2024-07-08 00:29:05 +07)" executed successfully
2024-07-08 00:28:28,988 - WARNING - Received SIGINT signal
2024-07-08 00:28:28,990 - INFO - Polling stopped for bot @MCR_Expert_bot id=6235250605 - 'MCR_expert'
2024-07-08 00:28:28,990 - INFO - Polling stopped
2024-07-08 00:28:29,405 - ERROR - Unclosed client session
client_session: <aiohttp.client.ClientSession object at 0x13dc06e40>
