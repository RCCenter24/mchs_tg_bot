from aiogram import Router, F, types
from aiogram.filters import StateFilter
from aiogram.fsm.context import FSMContext

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from sqlalchemy.dialects.postgresql import insert

from datetime import datetime as dt

from database.models import Municipalities, Subscriptions

from users.user_states import Form




router = Router()




@router.message(StateFilter(Form.waiting_for_munic), F.chat.type == 'private')
async def subscribe(message: types.Message, state: FSMContext, session: AsyncSession):
    selected_mun = message.text
    user_id = message.from_user.id
    data = await state.get_data()
    if selected_mun == "–û—Ç–º–µ–Ω–∞":
        await state.clear()
        await message.answer('–í—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', reply_markup=types.ReplyKeyboardRemove())
        return

    all_municipalities = data.get('all_municipalities', [])
    if selected_mun in all_municipalities:

        subscribe_check_query = select(Subscriptions.municipality_id) \
            .join(Municipalities, Municipalities.municipality_id == Subscriptions.municipality_id) \
            .where(
                (Subscriptions.user_id == user_id) &
                (Municipalities.municipality_name == selected_mun)
            )

        result = await session.execute(subscribe_check_query)
        subscription_exists = result.first()

        if subscription_exists is not None:
            await message.answer('–í—ã —É–∂–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ —ç—Ç–æ –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω–æ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ',
                                 reply_markup=types.ReplyKeyboardRemove())
        else:
            subquery = select(Municipalities.municipality_id).where(
                Municipalities.municipality_name == selected_mun).scalar_subquery()

            add_subscriber_query = insert(Subscriptions).values(
                user_id=user_id,
                municipality_id=subquery,
                date_subscribed=dt.now()
            ).on_conflict_do_nothing()

            await session.execute(add_subscriber_query)
            await session.commit()

            query_get_subs = select(Municipalities.municipality_name) \
                    .join(Subscriptions, Subscriptions.municipality_id == Municipalities.municipality_id) \
                    .where(Subscriptions.user_id == user_id)

            result = await session.execute(query_get_subs)
            all_cathegories = result.all()

            municipalities = [item[0] for item in all_cathegories]

            message_text = "–ü–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ üôÇ\n\n<b>–í–∞—à–∏ –ø–æ–¥–ø–∏—Å–∫–∏</b>\n" + \
                "\n".join(municipalities)

            await message.answer(message_text, parse_mode='HTML', reply_markup=types.ReplyKeyboardRemove())

        await state.clear()
    else:
        await message.answer('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω–æ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö.')